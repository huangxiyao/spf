<html>
<body>
<p>This artifact contains utilities (Java API's and JSP tags) for
Java portlets built using the Shared Portal Framework (SPF).</p>

<style type="text/css">
body {
	padding: 0;
	font-family: Verdana, Sans-serif;
	font-size: small;
}

h1 {
	font-family: Georgia, Serif;
	font-size: 160%;
	color: #404040;
	margin-top: 5px;
}

h2 {
	font-family: Georgia, Serif;
	font-size: 130%;
	color: #404040;
	page-break-before: always;
}

h3 {
	font-family: Verdana, Sans-serif;
	font-size: small;
	font-weight: bold;
	color: #404040;
	margin-top: 20px;
}

h4 {
	font-family: Verdana, Sans-serif;
	font-size: small;
	font-weight: normal;
	color: #404040;
	margin-top: 20px;
}

li {
	margin-left: -10px;
}

ol li {
	margin-bottom: 20px;
}

code {
	color: #990000;
	font-size: small;
}

pre {
	color: #990000;
	font-size: small;
}

.byline {
	font-style: italic;
	font-size: 90%;
	color: gray;
	margin-top: -10px;
	border-bottom: solid black 1px;
}

.codeSample {
	color: #990000;
	font-family: 'Courier New', Courier, monospace;
	font-size: small;
	border: solid #990000 1px;
	padding: 5px;
}

.leftFloatingImage {
	float: left;
	margin: 0 10px 10px 0;
}

.rightFloatingImage {
	float: right;
	margin: 0 0 10px 10px;
}

.toc {
	list-style-type: none;
}

ul.toc ul {
	list-style-type: none;
}

table.props td,table.props th {
	padding: 5px;
	background-color: #F0F0F0
}

table.props th {
	font-size: 11px;
	font-weight: bold;
	text-align: right;
}

table.props td {
	font-family: 'Courier New', Courier, monospace;
}

.style1 {
	border-style: solid;
	border-width: 1px;
}
</style>

<h1>Shared Portal Framework - Portlet Utilities - Developer's Guide<br>
<font color="red">WORK IN PROGRESS</font></h1>

<a name="toc">
<h2>Table of Contents</h2>
</a>

<ul class="toc">
	<li>1. <a href="#overview">Overview</a>
	<ul>
		<li>1.1. <a href="#wpap">WPA Portlet Edition and Spring
		Portlet MVC</a></li>
		<li>1.2. <a href="#installation">Installation</a></li>
		<li>1.3. <a href="#dependencies">Dependencies</a></li>
	</ul>
	</li>
	<li>2. <a href="#i18n">Internationalization</a>
	<ul>
		<li>2.1. <a href="#i18n.resources">Kinds of resources</a>
		<ul>
			<li>2.1.1. <a href="#i18n.resources.message">Message
			resources (message properties)</a></li>
			<li>2.2.2. <a href="#i18n.resources.supporting">Supporting
			resources (images, HTML, PDF, etc)</a></li>
			<li>2.2.3. <a href="#i18n.resources.bundles">Resource
			bundles</a></li>
		</ul>
		</li>
		<li>2.2. <a href="#i18n.location">Where to put your resources</a>
		<ul>
			<li>2.2.1. <a href="#i18n.location.internal">Internal
			resources go in your portlet application</a></li>
			<li>2.2.2. <a href="#i18n.location.external">External
			resources go in the portlet resource bundle folder</a></li>
			<li>2.2.3. <a href="#i18n.location.both">Using both kinds of
			resources</a></li>
		</ul>
		</li>
		<li>2.3. <a href="#i18n.messages.java">Accessing message
		resources using Java code</a>
		<ul>
			<li>2.3.1. <a href="#i18n.messages.java.spring.getMessage">Using
			Spring (<code>ApplicationContext.getMessage</code>)</a></li>
			<li>2.3.2. <a href="#i18n.messages.java.spf.getMessage">Using
			SPF (<code>I18nUtility.getMessage</code>)</a></li>
		</ul>
		</li>
		<li>2.4. <a href="#i18n.messages.tags">Accessing message
		resources using JSP tag libraries</a>
		<ul>
			<li>2.4.1. <a href="#i18n.messages.jsp.spring.message">Using
			Spring (<code>&lt;spring:message&gt;</code>)</a></li>
			<li>2.4.2. <a href="#i18n.messages.jsp.spf.message">Using
			SPF (<code>&lt;spf-i18n-portlet:message&gt;</code>, <code>&lt;spf-i18n-portlet:param&gt;</code>,
			and <code>&lt;spf-i18n-portlet:classicContextualHelpParam&gt;</code>)</a></li>
		</ul>
		</li>
		<li>2.5. <a href="#i18n.supporting.java">Accessing supporting
		resources using Java code</a>
		<ul>
			<li>2.5.1. <a href="#i18n.supporting.java.getLocalizedFileURL">Using
			<code>I18nUtility.getLocalizedFileURL</code></a></li>
			<li>2.5.2. <a
				href="#i18n.supporting.java.getLocalizedFileStream">Using <code>I18nUtility.getLocalizedFileStream</code></a></li>
			<li>2.5.3. <a href="#i18n.supporting.java.getLocalizedFileName">Using
			<code>I18nUtility.getLocalizedFileName</code></a></li>
		</ul>
		</li>
		<li>2.6. <a href="#i18n.supporting.jsp">Accessing supporting
		resources using JSP tag libraries</a>
		<ul>
			<li>2.6.1. <a href="#i18n.supporting.jsp.localizedFileURL">Using
			<code>&lt;spf-i18n-portlet:localizedFileURL&gt;</code></a></li>
		</ul>
		</li>
		<li>2.7. <a href="#i18n.supporting.relay">Providing download
		service for external resources using <code>RelayServlet</code></a></li>
		<li>2.8. <a href="#i18n.l10n">Localizing your resources</a></li>
		<li>2.9. <a href="#i18n.other">Other internationalization
		topics</a>
		<ul>
			<li>2.9.1. <a href="#i18n.other.locale.get">Getting the
			locale</a></li>
			<li>2.9.2. <a href="#i18n.other.locale.set">Setting the
			locale</a></li>
			<li>2.9.3. <a href="#i18n.other.common">Using the common <code>I18nUtility</code></a></li>
			<li>2.9.4. <a href="#i18n.other.refs">Other references</a></li>
		</ul>
		</li>
	</ul>
	</li>
	<li>3. <a href="#help">Help</a>
	<ul>
		<li>3.1. <a href="#help.kinds">Kinds of help</a>
		<ul>
			<li>3.1.1. <a href="#help.kinds.contextual">Contextual help
			(classic and other)</a></li>
			<li>3.1.2. <a href="#help.kinds.portlet">Portlet help (help
			mode)</a></li>
			<li>3.1.3. <a href="#help.kinds.global">Portal help (global
			help)</a></li>
		</ul>
		</li>
		<li>3.2. <a href="help.contextual.java">Producing contextual
		help using Java code </a>
		<ul>
			<li>3.2.1. <a
				href="#help.contextual.java.classicContextualHelpProvider">Using
			<code>ClassicContextualHelpProvider</code></a></li>
			<li>3.2.2. <a
				href="#help.contextual.java.contextualHelpProvider">Extending <code>ContextualHelpProvider</code>
			to create your own contextual help style</a></li>
		</ul>
		</li>
		<li>3.3. <a href="#help.contextual.jsp">Producing contextual
		help using JSP tag libraries</a>
		<ul>
			<li>3.3.1. <a
				href="#help.contextual.jsp.classicContextualHelpProvider">Using
			<code>&lt;spf-help-portlet:classicContextualHelpProvider&gt;</code></a></li>
			<li>3.3.2. <a
				href="#help.contextual.jsp.classicContextualHelpProviderParam">Using
			<code>&lt;spf-i18n-portlet:classicContextualHelpProviderParam&gt;</code></a></li>
			<li>3.3.2. <a
				href="#help.contextual.java.contextualhelpprovider">Creating a
			tag library for your own contextual help style</a></li>
		</ul>
		</li>
		<li>3.4. <a href="#help.portlet.java">Producing portlet help
		(help mode) using <code>FileDisplayPortletController</code></a></li>
	</ul>
	</li>
	<li>4. <a href="#file">File Display</a>
	<ul>
		<li>4.1. <a href="#file.about">About file display</a></li>
		<li>4.2. <a href="#file.display">Displaying file content
		using Java code</a>
		<ul>
			<li>4.2.1. <a href="#file.display.fileInterpolator">Using <code>FileInterpolator</code>
			to read and interpolate file content</a></li>
			<li>4.2.2. <a href="#file.display.fileDisplayPortletController">Using
			<code>FileDisplayPortletController</code> to display interpolated
			file content</a></li>
			<li>4.2.3. <a href="#file.display.htmlViewer">Using the <code>html-viewer</code>
			portlet to display interpolated file content</a></li>
		</ul>
		<li>4.3. <a href="#file.author#">Authoring file content and
		using interpolation tokens</a>
		<ul>
			<li>4.3.1. <a href="#file.author.token.url">Including URLs
			for supporting resources like images and CSS (<code>&lt;CONTENT-URL:<i>path</i>&gt;</code>,
			<code>&lt;LOCALIZED-CONTENT-URL:<i>path</i>&gt</code>) </a></li>
			<li>4.3.2. <a href="#file.author.token.user">Displaying user
			information (<code>&lt;NAME&gt;</code>, <code>&lt;EMAIL&gt;</code>, <code>&lt;LANGUAGE-CODE&gt;</code>,
			<code>LANGUAGE-TAG&gt;</code>, <code>&lt;USER-PROPERTY:<i>key</i>&gt;</code>)</a></li>
			<li>4.3.3. <a href="#file.author.token.auth">Permissioning
			content for authorized users (<code>&lt;ROLE:<i>role-names</i>&gt;</code>,
			<code>&lt;GROUP:<i>group-names</i>&gt;</code>)</a></li>
			<li>4.3.4. <a href="#file.author.token.consolidate">Consolidating
			content for easier administration (<code>&lt;PORTLET:<i>friendly-ids</i>&gt;</code>,
			<code>&lt;SITE:<i>site-names</i></code>, <code>&lt;TOKEN:<i>key</i>&gt;</code>)</a></li>
			<li>4.3.5. <a href="#file.author.token.misc">Miscellaneous (<code>&lt;SITE&gt;</code>)</a></li>
		</ul>
		</li>
	</ul>
	</li>
	<li>5. <a href="#portal">Portal Data</a>
	<ul>
		<li>5.1. <a href="#portal.kinds">Kinds of portal provided
		data</a>
		<ul>
			<li>5.1.1. <a href="#portal.user">User data (profile
			attributes, groups and roles)</a></li>
			<li>5.1.2. <a href="#portal.prefs">Portlet preferences</a></li>
			<li>5.1.3. <a href="#portal.request">Portal request data
			(site name, friendly ID, and URLs)</a></li>
		</ul>
		</li>
		<li>5.2. <a href="#portal.user.get">Accessing user data using
		Java code</a>
		<ul>
			<li>5.2.1. <a href="#portal.user.props">Accessing user
			profile attributes (<code>Utils.getUserProperty</code>)</a></li>
			<li>5.2.2. <a href="#portal.user.groups">Accessing user
			groups (<code>Utils.getGroups</code>)</a></li>
		</ul>
		</li>
		<li>5.3. <a href="#portal.request.get">Accessing portal
		request data</a>
		<ul>
			<li>5.3.1. <a href="#portal.request.site">Accessing the
			portal site name (<code>Utils.getSiteName</code>)</a></li>
			<li>5.3.2. <a href="#portal.request.portlet">Accessing the
			portlet friendly ID (<code>Utils.getPortletID</code>)</a></li>
			<li>5.3.3. <a href="#portal.request.url">Accessing portal
			URL's (<code>Utils.getRequestURL</code>, <code>Utils.getSiteRootURL</code>)</a></li>
		</ul>
		</li>
	</ul>
	</li>
	<li>6. <a href="#error">Error Handling</a>
	<ul>
		<li>6.1. <a href="#error.about">About error handling</a></li>
		<li>6.2. <a href="#error.categorization">Categorizing
		exceptions using the <code>SPFException</code> hierarchy</a></li>
		<li>6.3. <a href="#error.handling">Handling exceptions using
		<code>ExceptionUtil</code> and <code>SimpleMappingExceptionResolver</code></a></li>
	</ul>
	</li>
</ul>

<hr>

<a name="overview"><h2>Overview</h2></a>

<p>This is the developer's guide for the Shared Portal Framework
portlet utilities. Portlet developers using the SPF should read this
guide. They should also check out the following additional guides for
portlet developers in the Shared Portal Framework:</p>

<ul>
	<li>Shared Portal Framework - Common Utilities - Developer's Guide</li>
	<li>Shared Portal Framework - HTML Viewer Portlet -
	Administrator's Guide</li>
	<li>Shared Portal Framework - File Relay Servlet - Configuration
	Guide</li>
</ul>

<p>Developers of Vignette portal components (not portlets) in the
Shared Portal Framework should ignore this guide.</p>

<a name="Resources">
<h3>Where you put your resources</h3>
</a>
<p>You have a choice. You may put your message and other static
resource files (ie message properties and images, HTML files, video
files, PDF's, etc) into your portlet WAR where they traditionally go:</p>

<ol>
	<li>
	<p>Your message properties would go into your <code>WEB-INF/classes/</code>,
	optionally under some additional sub-path (we recommend <code>portlet/i18n/</code>
	for reasons that will become clear). For example:</p>

	<blockquote><pre>
	<i>&lt;root&gt;</i>
	    WEB-INF/
	        classes/
	        	portlet/
	        		i18n/
	        			messages.properties
	        			messages_fr_FR.properties
	        			...
	</pre></blockquote>

	<p>Also, be sure to configure Spring properly so it can find those
	message properties. For example, if you use Spring's {@link
	org.springframework.context.support.ReloadableResourceBundleMessageSource}
	class, you would put this into your application context configuration
	(eg either your application-wide <code>applicationContext.xml</code> or
	your portlet-specific version of that file) for a bundle of message
	properties with basename of <code>messages</code> (eg <code>messages.properties</code>,
	<code>messages_fr_FR.properties</code>, etc):</p>

	<blockquote><pre>
	&lt;bean id="messageSource"
		class="org.springframework.context.support.ReloadableResourceBundleMessageSource"&gt;
		&lt;property name="basenames"&gt;
			&lt;list&gt;
				&lt;value&gt;
					classpath:portlet/i18n/messages
				&lt;/value&gt;
			&lt;/list&gt;
		&lt;/property&gt;
	&lt;/bean&gt;
	</pre></blockquote>
	</li>

	<li>
	<p>Your other static resource files (images, videos, PDF's, etc)
	would go into respective folders at the root of your portlet WAR. For
	example, if you have a bundle of HTML files (<code>text.html</code>, <code>text_es_MX.html</code>,
	etc) and a bundle of images (<code>picture.jpg</code>, <code>picture_ja.jpg</code>,
	etc), they could go into your portlet WAR as follows:</p>

	<blockquote><pre>
	<i>&lt;root&gt;</i>
	    html/
	        text.html
	        text_es_MX.html
	        ...
	    images/
	        picture.jpg
	        picture_ja.jpg
	        ...
	</pre></blockquote>
	</li>
</ol>

<p>Then when you use the standard Spring message API's, or the SPF
portlet message API's in {@link
com.hp.it.spf.xa.i18n.portlet.I18nUtility}, or the tag libraries for
either, they will find your message resources inside your portlet WAR.
And when you use the localized file access API's in <code>I18nUtility</code>,
they will find your static resource files there likewise.</p>

<p>However, you may instead put your messages and other resources <i>outside</i>
of your portlet WAR. Why? Doing so may have some advantages - for
example, it may make for easier administration of the resources.
Currently the SPF supports you putting them into what is called the <i>portlet
resource bundle folder</i>, which is any folder on the portlet server's
filesystem to which the portlet JVM has at least read access.</p>

<ol>
	<li>
	<p>Put the path for your portlet bundle folder into the classpath
	of your server's JVM. Or, put some parent path for it into the
	classpath. If you are using an application-hosting service (like SASU),
	they may already have defined for you a standard path from which to
	load so-called "global resources" (like externally-administered
	configuration files), and they may have put that into the classpath
	already. In any event, we recommend making the portlet bundle folder be
	a subfolder of your "global resources" classpath folder.</p>

	<p>For example, if you are using SASU, it may be that <code>/opt/sasuapps/spf/globalResources</code>
	is already your assigned classpath folder for all global resources (eg
	configuration files). If that is the case, we recommend creating the
	subfolder <code>portlet/i18n/</code> underneath it, so that <code>/opt/sasuapps/spf/globalResources/portlet/i18n/</code>
	is your portlet bundle folder. SASU should have put the <code>/opt/sasuapps/spf/globalResources</code>
	into the classpath for you.</p>
	</li>

	<li>
	<p>Put your message properties and other resource files into your
	portlet bundle folder. We recommend you use subfolders for further
	organization - for example, putting message properties in the portlet
	bundle folder proper, images in the <code>images/</code> subfolder,
	etc. Like this (example):</p>

	<blockquote><pre>
	/opt/sasuapps/spf/globalResources/     &lt;-- this is in the classpath
		...                                &lt;-- misc other external config files go here
		portlet/i18n/                      &lt;-- this is your portlet bundle folder
			html/                          &lt;-- this is your portlet bundle HTML subfolder
				text.html
				text_es_MX.html
				...
			images/                        &lt;-- this is your portlet bundle images subfolder
				picture.jpg
				picture_ja.jpg
				...
			messages.properties
			messages_fr_FR.properties
			...
	</pre></blockquote>
	</li>

	<li>
	<p>Configure Spring properly so it can find those externalized
	message properties relative to the classpath. We recommend you use
	Spring's {@link
	org.springframework.context.support.ReloadableResourceBundleMessageSource}
	class, since that makes your message properties hot-reloadable (ie your
	administrator can update your message bundles without restarting the
	JVM). You would use the same application-context configuration shown
	above (which is why we recommended using <code>portlet/i18n/</code>
	under <code>WEB-INF/classes/</code> above - so that the Spring
	configuration for internal resource access is the same as it is for
	external).</p>
	</li>

	<li>
	<p>If you chose a non-default location for the portlet bundle
	folder, configure it in <a href="#i18n_portlet_config"><code>i18n_portlet_config.properties</code></a>
	(see below). The default location is hardcoded in {@link
	com.hp.it.spf.xa.i18n.portlet.I18nUtility#BUNDLE_DIR_DEFAULT}, which is
	<code>/opt/sasuapps/spf/globalResources/portlet/i18n</code> (as in the
	above example) at this time of writing.</p>
	</li>

	<li>
	<p>Finally, if you have non-message static resources (images, etc)
	in your portlet bundle folder, and you will be using {@link
	com.hp.it.spf.xa.i18n.portlet.I18nUtility} to make URL's for them (eg
	to render in the browser), note that SPF uses a file-relay servlet (see
	{@link com.hp.it.spf.xa.relay.servlet.RelayServlet}) to service those
	URL's. Deploy that relay servlet in any Web application which is <i>both</i>
	accessible to the end-user browser, and has access to the portlet
	bundle folder. For example, if you are using local portlets, you could
	deploy it in your portal application. By default, SPF assumes you have
	deployed it in your portlet application, mapped under the hardcoded
	{@link com.hp.it.spf.xa.i18n.portlet.I18nUtility#RELAY_PATH_DEFAULT}
	path. See the {@link com.hp.it.spf.xa.relay.servlet.RelayServlet} for
	more information about deploying this servlet. If you deploy it in a
	non-default location, you will need to configure that in <a
		href="#i18n_portlet_config"><code>i18n_portlet_config.properties</code></a>.
	</p>
	</li>
</ol>

<p>Then when you use the standard Spring message API's, or the SPF
portlet message API's in {@link
com.hp.it.spf.xa.i18n.portlet.I18nUtility}, or the tag libraries for
either, they will find your message resources in your portlet bundle
folder. And when you use the localized file access API's in <code>I18nUtility</code>,
they will find your static resource files there likewise.</p>

<p>Note that you can mix both of these approaches, if you like:</p>

<ul>
	<li>
	<p>If you want to put some resource bundles inside your portlet WAR
	while keeping others external, you can do that. For example, you can
	keep your message bundles inside the WAR while keeping all your images
	in the portlet bundle folder.</p>
	</li>
	<li>
	<p>If you want to split a bundle across locations - eg keeping the
	English (base) files inside the portlet WAR and only keeping your
	localized versions outside - you can also do that.</p>
	</li>
	<li>
	<p>Finally, you can even have identically-named bundle files in
	both locations. For example, you can keep a "default" / "fallback" set
	of bundles inside your portlet WAR, and put "overrides" for them
	outside. SPF will search the portlet bundle folder first, only
	falling-back to look inside the portlet WAR if the resource was not
	found outside.</p>

	<blockquote>
	<p>There are some caveats to this regarding message properties,
	however. SPF uses Spring for access to message resources, and Spring
	searches these in the order set by the system classloader. For the
	"fallback" approach to work, this classloader needs to check inside
	your portlet application <i>last</i>, only after having <i>first</i>
	checked the classpath. You may or may not be able to control the load
	order used by the system classloader in your application server. Test
	it.</p>
	</blockquote>
	</li>
</ul>

<a name="i18n_portlet_config">
<h3>i18n_portlet_config.properties</h3>
</a>

<p>TBD</p>
</body>
</html>

