<html>
<head>
<title>Shared Portal Framework - Portlet Utilities - Developer's
Guide</title>
</head>
<body>
<p>This artifact contains utilities (Java API's and JSP tags) for
Java portlets built using the Shared Portal Framework (SPF).</p>

<style type="text/css">
body {
	padding: 0;
	font-family: Verdana, Sans-serif;
	font-size: small;
}

h1 {
	font-family: Georgia, Serif;
	font-size: 200%;
	color: #404040;
	margin-top: 5px;
}

h2 {
	font-family: Georgia, Serif;
	font-size: 175%;
	color: #404040;
	page-break-before: always;
}

h3 {
	font-family: Verdana, Sans-serif;
	font-size: 150%;
	font-weight: bold;
	color: #404040;
	margin-top: 20px;
}

h4 {
	font-family: Verdana, Sans-serif;
	font-size: 125%;
	font-weight: bold;
	color: #404040;
	margin-top: 20px;
}

li {
	margin-left: -10px;
}

ol li {
	margin-bottom: 20px;
}

code {
	color: #990000;
	font-size: 110%
}

pre {
	color: #990000;
	font-size: 110%;
}

.byline {
	font-style: italic;
	font-size: 90%;
	color: gray;
	margin-top: -10px;
	border-bottom: solid black 1px;
}

.codeSample {
	color: #990000;
	font-family: 'Courier New', Courier, monospace;
	font-size: small;
	border: solid #990000 1px;
	padding: 5px;
}

.leftFloatingImage {
	float: left;
	margin: 0 10px 10px 0;
}

.rightFloatingImage {
	float: right;
	margin: 0 0 10px 10px;
}

.toc {
	list-style-type: none;
}

ul.toc ul {
	list-style-type: none;
}

table.props td,table.props th {
	padding: 5px;
	background-color: #F0F0F0
}

table.props th {
	font-size: 11px;
	font-weight: bold;
	text-align: right;
}

table.props td {
	font-family: 'Courier New', Courier, monospace;
}

.style1 {
	border-style: solid;
	border-width: 1px;
}
</style>

<a name="top">
<h1>Shared Portal Framework - Portlet Utilities - Developer's Guide</h1>
</a>

<a name="toc">
<h2>Table of Contents</h2>
</a>

<ul class="toc">
	<li>1. <a href="#overview">Overview</a>
	<ul>
		<li>1.1. <a href="#overview.installation">Installation</a>
		<ul>
			<li>1.1.1. <a href="#overview.installation.jar">Installation
			of the SPF portlet utilities JAR</a></li>
			<li>1.1.2. <a href="#overview.installation.i18n_portlet_config">Installation
			of <code>i18n_portlet_config.properties</code> (optional)</a></li>
			<li>1.1.3. <a href="#overview.installation.init_relay">Installation
			of <code>init_relay.properties</code> (optional)</a></li>
		</ul>
		</li>
		<li>1.2. <a href="#overview.dependencies">Dependencies</a></li>
		<li>1.3. <a href="#overview.other">Other libraries for SPF
		portlet developers</a>
		<ul>
			<li>1.3.1. <a href="#overview.other.wpap">WPA Portlet
			Edition</a></li>
			<li>1.3.2. <a href="#overview.other.spring">Spring Portlet
			MVC</a></li>
			<li>1.3.3. <a href="#overview.other.portlet">Portlet 2.0
			(JSR 286)</a></li>
			<li>1.3.4. <a href="#overview.other.spf.common">SPF Common
			Utilities</a></li>
			<li>1.3.5. <a href="#overview.other.spf.htmlviewer">SPF <code>htmlviewer</code>
			Portlet</a></li>
		</ul>
		</li>
	</ul>
	</li>
	<li>2. <a href="#i18n">Internationalization</a>
	<ul>
		<li>2.1. <a href="#i18n.resources">Kinds of resources</a>
		<ul>
			<li>2.1.1. <a href="#i18n.resources.message">Message
			resources (message properties)</a></li>
			<li>2.1.2. <a href="#i18n.resources.supporting">Supporting
			resources (images, HTML, PDF, etc)</a></li>
			<li>2.1.3. <a href="#i18n.resources.bundles">Resource
			bundles</a></li>
		</ul>
		</li>
		<li>2.2. <a href="#i18n.location">Where to put your resources</a>
		<ul>
			<li>2.2.1. <a href="#i18n.location.internal">Internal
			resources (portlet application)</a></li>
			<li>2.2.2. <a href="#i18n.location.external">External
			resources (portlet resource bundle folder)</a></li>
			<li>2.2.3. <a href="#i18n.location.both">Mixing internal and
			external resources</a></li>
		</ul>
		</li>
		<li>2.3. <a href="#i18n.messages.java">Accessing message
		resources using Java code</a>
		<ul>
			<li>2.3.1. <a href="#i18n.messages.java.spring.getMessage">Using
			Spring (<code>ApplicationContext.getMessage</code>)</a></li>
			<li>2.3.2. <a href="#i18n.messages.java.spf.getMessage">Using
			SPF (<code>I18nUtility.getMessage</code>)</a></li>
		</ul>
		</li>
		<li>2.4. <a href="#i18n.messages.tags">Accessing message
		resources using JSP tag libraries</a>
		<ul>
			<li>2.4.1. <a href="#i18n.messages.jsp.spring.message">Using
			Spring (<code>&lt;spring:message&gt;</code>)</a></li>
			<li>2.4.2. <a href="#i18n.messages.jsp.spf.message">Using
			SPF (<code>&lt;spf-i18n-portlet:message&gt;</code>, <code>&lt;spf-i18n-portlet:param&gt;</code>,
			and <code>&lt;spf-i18n-portlet:classicContextualHelpParam&gt;</code>)</a></li>
		</ul>
		</li>
		<li>2.5. <a href="#i18n.supporting.java">Accessing supporting
		resources using Java code</a>
		<ul>
			<li>2.5.1. <a href="#i18n.supporting.java.getLocalizedFileURL">Using
			<code>I18nUtility.getLocalizedFileURL</code></a></li>
			<li>2.5.2. <a
				href="#i18n.supporting.java.getLocalizedFileStream">Using <code>I18nUtility.getLocalizedFileStream</code></a></li>
			<li>2.5.3. <a href="#i18n.supporting.java.getLocalizedFileName">Using
			<code>I18nUtility.getLocalizedFileName</code></a></li>
		</ul>
		</li>
		<li>2.6. <a href="#i18n.supporting.jsp">Accessing supporting
		resources using JSP tag libraries</a>
		<ul>
			<li>2.6.1. <a href="#i18n.supporting.jsp.localizedFileURL">Using
			<code>&lt;spf-i18n-portlet:localizedFileURL&gt;</code></a></li>
		</ul>
		</li>
		<li>2.7. <a href="#i18n.supporting.relay">Providing download
		service for external resources using <code>RelayServlet</code></a></li>
		<li>2.8. <a href="#i18n.l10n">Localizing your resources</a>
		<ul>
			<li>2.8.1 <a href="#i18n.l10n.spf">The SPF localization
			process</a></li>
		</ul>
		</li>
		<li>2.9. <a href="#i18n.other">Other internationalization
		topics</a>
		<ul>
			<li>2.9.1. <a href="#i18n.other.locale.get">Getting the
			locale</a></li>
			<li>2.9.2. <a href="#i18n.other.locale.set">Setting the
			locale</a></li>
			<li>2.9.3. <a href="#i18n.other.i18n_portlet_config">Configuring
			<code>i18n_portlet_config.properties</code> (optional)</a></li>
			<li>2.9.4. <a href="#i18n.other.init_relay">Configuring <code>init_relay.properties</code>
			(optional)</a></li>
			<li>2.9.5. <a href="#i18n.other.common">Using the common <code>I18nUtility</code></a></li>
		</ul>
		</li>
	</ul>
	</li>
	<li>3. <a href="#help">Online Help</a>
	<ul>
		<li>3.1. <a href="#help.kinds">About online help</a>
		<ul>
			<li>3.1.1. <a href="#help.kinds.contextual">Contextual help
			(classic and custom; standalone and injected)</a></li>
			<li>3.1.2. <a href="#help.kinds.portlet">Portlet help (help
			mode)</a></li>
			<li>3.1.3. <a href="#help.kinds.global">Portal help (global
			help)</a></li>
		</ul>
		</li>
		<li>3.2. <a href="#help.contextual.java">Producing contextual
		help using Java code </a>
		<ul>
			<li>3.2.1. <a
				href="#help.contextual.java.classicContextualHelpProvider">Using
			<code>ClassicContextualHelpProvider</code></a></li>
			<li>3.2.2. <a
				href="#help.contextual.java.contextualHelpProvider">Extending a
			<code>ContextualHelpProvider</code> to create a custom rendition</a></li>
		</ul>
		</li>
		<li>3.3. <a href="#help.contextual.jsp">Producing contextual
		help using JSP tag libraries</a>
		<ul>
			<li>3.3.1. <a href="#help.contextual.jsp.classicContextualHelp">Using
			<code>&lt;spf-help-portlet:classicContextualHelp&gt;</code> for
			standalone classic contextual help</a></li>
			<li>3.3.2. <a
				href="#help.contextual.jsp.classicContextualHelpParam">Using <code>&lt;spf-i18n-portlet:classicContextualHelpParam&gt;</code>
			for injected classic contextual help</a></li>
			<li>3.3.3. <a href="#help.contextual.jsp.contextualHelpProvider">Creating
			a tag library for a custom rendition</a></li>
		</ul>
		</li>
		<li>3.4. <a href="#help.portlet">Producing portlet help (help
		mode)</a>
		<ul>
			<li>3.4.1. <a href="#help.portlet.jsp.interpolate">Using <code>&lt;spf-file-portlet:interpolate&gt;</code>
			for portlet help</a></li>
			<li>3.4.2. <a
				href="#help.portlet.java.fileInterpolatorController">Using <code>FileInterpolatorController</code>
			for portlet help</a></li>
		</ul>
		</li>
	</ul>
	</li>
	<li>4. <a href="#file">Text Interpolation</a>
	<ul>
		<li>4.1. <a href="#file.about">About text interpolation</a></li>
		<li>4.2. <a href="#file.display.java">Interpolating text
		using Java code</a>
		<ul>
			<li>4.2.1. <a href="#file.display.java.fileInterpolator">Using
			<code>FileInterpolator</code> to interpolate text from files</a></li>
			<li>4.2.2. <a
				href="#file.display.java.fileInterpolatorController">Using <code>FileInterpolatorController</code>
			to display interpolated text from files</a></li>
			<li>4.2.3. <a href="#file.display.java.tokenParser">Using <code>TokenParser</code>
			to interpolate strings</a></li>
		</ul>
		</li>
		<li>4.3. <a href="#file.display.jsp">Interpolating text using
		JSP tag libraries</a>
		<ul>
			<li>4.3.1. <a href="#file.display.jsp.interpolate">Using <code>&lt;spf-file-portlet:interpolate&gt;</code></a></li>
		</ul>
		</li>
		<li>4.4. <a href="#file.display.htmlViewer">Using the <code>htmlviewer</code>
		portlet to display interpolated text from files</a></li>
		<li>4.5. <a href="#file.author">Authoring text using
		interpolation tokens</a>
		<ul>
			<li>4.5.1. <a href="#file.author.token.url">Referencing URLs
			(<code>{CONTENT-URL:<i>path</i>}</code>, <code>{LOCALIZED-CONTENT-URL:<i>path</i>&gt</code>,
			<code>{REQUEST-URL}</code>, <code>{REQUEST-URL:<i>spec</i>}</code>, <code>{SITE-URL}</code>,
			<code>{SITE-URL:<i>spec</i>}</code>)</a></li>
			<li>4.5.2. <a href="#file.author.token.user">Displaying user
			information (<code>{NAME}</code>, <code>{EMAIL}</code>, <code>{LANGUAGE-CODE}</code>,
			<code>{LANGUAGE-CODE:<i>case</i>}</code>, <code>{COUNTRY-CODE}</code>,
			<code>{COUNTRY-CODE:<i>case</i>}</code>, <code>{LANGUAGE-TAG}</code>,
			<code>{LANGUAGE-TAG:<i>case</i>}</code>, <code>{HPP-LANGUAGE-CODE}</code>,
			<code>{HPP-LANGUAGE-CODE:<i>case</i>}</code>, <code>{USER-PROPERTY:<i>key</i>}</code>)</a></li>
			<li>4.5.3. <a href="#file.author.token.auth">Permissioning
			content for authorized users (<code>{LOGGED-IN}</code>, <code>{LOGGED-OUT}</code>,
			<code>{ROLE:<i>role-names</i>}</code>, <code>{GROUP:<i>group-names</i>}</code>)</a></li>
			<li>4.5.4. <a href="#file.author.token.consolidate">Consolidating
			content for easier administration (<code>{PORTLET:<i>friendly-ids</i>}</code>,
			<code>{PAGE:<i>friendly-ids</i>}</code>, <code>{SITE:<i>site-names</i></code>},
			<code>{INCLUDE:<i>key</i>}</code>)</a></li>
			<li>4.5.5. <a href="#file.author.token.misc">Miscellaneous (<code>{AFTER:<i>date</i>}</code>,
			<code>{BEFORE:<i>date</i>}</code>, <code>{SITE-NAME}</code>, <code>{URL-ENCODE:<i>string</i>}</code>)</a></li>
		</ul>
		</li>
	</ul>
	</li>
	<li>5. <a href="#portal">Portal Data</a>
	<ul>
		<li>5.1. <a href="#portal.kinds">Kinds of portal provided
		data</a>
		<ul>
			<li>5.1.1. <a href="#portal.user">User data (profile
			attributes, groups, etc)</a></li>
			<li>5.1.2. <a href="#portal.request">Portal request data
			(site name, portlet ID, URLs, etc)</a></li>
		</ul>
		</li>
		<li>5.2. <a href="#portal.user.get">Accessing user data</a>
		<ul>
			<li>5.2.1. <a href="#portal.user.loginStatus">Checking user
			authentication status (<code>Utils.isAuthenticatedUser</code>)</a></li>
			<li>5.2.2. <a href="#portal.user.props">Accessing user
			profile attributes (<code>Utils.getUserProperty</code>)</a></li>
			<li>5.2.3. <a href="#portal.user.groups">Accessing user
			groups (<code>Utils.getGroups</code>, <code>Utils.isUserInGroup</code>)</a></li>
		</ul>
		</li>
		<li>5.3. <a href="#portal.request.get">Accessing portal
		request data</a>
		<ul>
			<li>5.3.1. <a href="#portal.request.site">Accessing the
			portal site name (<code>Utils.getPortalSiteName</code>)</a></li>
			<li>5.3.2. <a href="#portal.request.portlet">Accessing the
			portlet ID (<code>Utils.getPortalPortletID</code>)</a></li>
			<li>5.3.3. <a href="#portal.request.url">Accessing portal
			URL's (<code>Utils.getPortalRequestURL</code>, <code>Utils.getPortalSiteURL</code>)</a></li>
		</ul>
		</li>
	</ul>
	</li>
	<li>6. <a href="#error">Error Handling</a>
	<ul>
		<li>6.1. <a href="#error.about">About error handling and the
		Shared Portal Framework</a>
		<ul>
			<li>6.1.1. <a href="#error.about.other">Error handling with
			WPA Portlet Edition and Spring Portlet MVC</a></li>
			<li>6.1.2. <a href="#error.about.spf">Error handling
			extensions in SPF</a></li>
		</ul>
		</li>
		<li>6.2. <a href="#error.spf.exceptions">Using the <code>SPFException</code>
		hierarchy (<code>SPFException</code>, <code>BusinessException</code>,
		<code>SystemException</code>)</a></li>
		<li>6.3. <a href="#error.spf.handling">Handling exceptions
		using <code>ExceptionUtil</code> and <code>SimpleMappingExceptionResolver</code></a>
		<ul>
			<li>6.3.1. <a href="#error.spf.handling.exceptionUtil">Using
			<code>ExceptionUtil</code> to store and access exception data</a></li>
			<li>6.3.2. <a
				href="#error.spf.handling.simpleMappingExceptionResolver">Using
			<code>SimpleMappingExceptionResolver</code> to resolve a view for
			your exception</a></li>
		</ul>
		</li>
		<li>6.4. <a href="#error.spf.examples">Some examples</a>
		<ul>
			<li>6.4.1. <a href="#error.spf.examples.business">An example
			of business error handling</a></li>
			<li>6.4.2. <a href="#error.spf.examples.system">An example
			of system error handling</a></li>
		</ul>
		</li>
	</ul>
	</li>
	<li>7. <a href="#history">Document History</a></li>
</ul>

<hr>

<a name="overview">
<h2>1. Overview</h2>
</a>

<p>This is the developer's guide for the <b>Shared Portal
Framework (SPF) portlet utilities</b>. The SPF portlet utilities are a
collection of Java classes and JSP tag libraries providing useful
functionality for SPF Java portlet developers in the following areas:</p>

<ul>
	<li><a href="#i18n">Internationalization</a> - the SPF portlet
	utilities provide Java classes and JSP tags for handling all kinds of
	UI resources in your code (messages, images, etc) so that they can be
	localized</li>
	<li><a href="#help">Online Help</a> - the SPF portlet utilities
	provide Java classes and JSP tags which make it easier for you to
	develop online help</li>
	<li><a href="#file">Text Interpolation</a> - the SPF portlet
	utilities provide Java classes for interpolating and displaying text
	(including special markup tokens) from files or strings to users
	(saving you time when developing portlets that mostly display static
	text)</li>
	<li><a href="#portal">Portal Data</a> - the SPF portlet utilities
	provide Java classes for accessing data passed by the SPF (Vignette)
	portal</li>
	<li><a href="#error">Error Handling</a> - the SPF portlet
	utilities provide Java classes to assist you with error handling,
	especially system error handling (saving you time developing rote
	handlers for system errors)</li>
</ul>

<p>The SPF portlet utilities augment HP IT's WPAP (Web Presentation
Architecture - Portlet Edition) framework, which in turn augments the
Spring consortium's Portlet MVC framework. These are all among the
several SPF artifacts for SPF developers. See <a href="#overview.other">other
libraries</a>.</p>

<hr>

<a name="overview.installation">
<h3>1.1. Installation</h3>
</a>

<a name="overview.installation.jar">
<h4>1.1.1 Installation of the SPF portlet utilities JAR</h4>
</a>

<p>The SPF portlet utilities are distributed in Java JAR format. The
base JAR filename is <code>spf-portlet-utilities.jar</code>; typically a
version number is included (for example, <code>spf-portlet-utilities-1.0.0.jar</code>).
The SPF portlet utilities are distributed through Maven 2:</p>

<ul>
	<li>The current Maven 2 repository is <a
		href="http://samson.atl.hp.com:8081/nexus/content/groups/public/com/hp/it/spf/xa/spf-portlet-utilities/"><code>http://samson.atl.hp.com:8081/nexus/content/groups/public/com/hp/it/spf/xa/spf-portlet-utilities/</code></a></li>
	<li>The group ID is <code>com.hp.it.spf.xa</code>
	<li>The artifact ID is <code>spf-portlet-utilities</code>
</ul>

<p>To get the SPF portlet utilities, download the latest released
version from the repository. As usual with any JAR file, include it in
your portlet application's <code>/WEB-INF/lib</code> folder.</p>

<a name="overview.installation.i18n_portlet_config">
<h4>1.1.2 Installation of <code>i18n_portlet_config.properties</code>
(optional)</h4>
</a>

<blockquote>
<p><b>Note:</b> You only need to concern yourself with <code>i18n_portlet_config.properties</code>
if you have <a href="#i18n.location.external">external supporting
resources</a> <b>and</b> you are either putting the <i>portlet resource
bundle folder</i> in a non-default location, <b>or</b> you are deploying the
<i>file relay servlet</i> in a non-default location.</p>
</blockquote>

<p>To install this file:</p>

<ul>
	<li>
	<p>Download the template for <code>i18n_portlet_config.properties</code>.
	It is packaged with the rest of the SPF portlet configuration file
	templates, in the <code>spf-portlet-config.jar</code>. Download the
	latest version of this JAR (typically a version number is affixed to
	the JAR filename) and extract the <code>i18n_portlet_config.properties</code>
	template file from it.</p>

	<p>You can get the latest <code>spf-portlet-config.jar</code> from
	the SPF team on their Maven 2 repository, here: <a
		href="http://samson.atl.hp.com:8081/nexus/content/groups/public/com/hp/it/spf/xa/spf-portlet-config">http://samson.atl.hp.com:8081/nexus/content/groups/public/com/hp/it/spf/xa/spf-portlet-config/</a>
	(browse for the latest version).</p>
	</li>

	<li>
	<p>Customize the properties in the file as needed - see
	instructions for <a href="#i18n.other.i18n_portlet_config">configuring
	the <code>i18n_portlet_config.properties</code></a>.</p>
	</li>

	<li>
	<p>Include the customized file, named <code>i18n_portlet_config.properties</code>,
	with your portlet application. You can put the file anywhere that the
	system classloader searches: inside your portlet application (eg in <code>/WEB-INF/classes</code>)
	or in any folder outside of the WAR which is named in the classpath for
	your JVM. If you need to make the configuration easily performable by
	an administrator, we recommend the latter; otherwise the former is
	easier because it is one-time setup.</p>

	<p>If you are interested in externalizing the <code>i18n_portlet_config.properties</code>
	from the portlet WAR, check how your application server is configured.
	If you are using an application server hosting environment, like DASH
	or SASU, they probably will have provided you a "global resources"
	folder on the server filesystem and in the JVM classpath. You would put
	the <code>i18n_portlet_config.properties</code> file there, if you
	wanted it to be external to your portlet WAR (eg so the administrator
	can easily customize it).</p>

	<blockquote>
	<p><b>Note:</b> Depending on the search order performed by your
	system classloader, you may be able to do <b>both</b>: include a <code>i18n_portlet_config.properties</code>
	inside your application, and also let the administrator optionally
	override it when needed, by putting an <code>i18n_portlet_config.properties</code>
	outside of the WAR. For this to work, your classloader must search the
	external folders in the classpath <b>before</b> searching inside the
	WAR. If you are interested in this "mixed" deployment of <code>i18n_portlet_config.properties</code>,
	be sure to test it out first, as actual behavior may vary by
	environment (application server, etc).</p>
	</blockquote>
	</li>
</ul>

<a name="overview.installation.init_relay">
<h4>1.1.3 Installation of <code>init_relay.properties</code>
(optional)</h4>
</a>

<blockquote>
<p><b>Note:</b> You only need to concern yourself with <code>init_relay.properties</code>
if you have <a href="#i18n.location.external">external supporting
resources</a> <b>and</b> you are dis-satisfied with the configuration in <code>init_relay_default.properties</code>
(which is delivered inside the SPF portlet utilities JAR). See the
discussion in the <a
	href="com/hp/it/spf/xa/relay/servlet/package-summary.html#init_relay.properties">package
description</a> for the relay servlet.</p>
</blockquote>

<p>To install this file:</p>

<ul>
	<li>
	<p>Download the template for <code>init_relay.properties</code>. It
	is packaged with the rest of the SPF portlet configuration file
	templates, in the <code>spf-portlet-config.jar</code>. Download the
	latest version of this JAR (typically a version number is affixed to
	the JAR filename) and extract the <code>init_relay.properties</code>
	template file from it.</p>

	<p>You can get the latest <code>spf-portlet-config.jar</code> from
	the SPF team on their Maven 2 repository, here: <a
		href="http://samson.atl.hp.com:8081/nexus/content/groups/public/com/hp/it/spf/xa/spf-portlet-config">http://samson.atl.hp.com:8081/nexus/content/groups/public/com/hp/it/spf/xa/spf-portlet-config/</a>
	(browse for the latest version).</p>
	</li>

	<li>
	<p>Customize the properties in the file as needed - see
	instructions for <a href="#i18n.other.init_relay">configuring the <code>init_relay.properties</code></a>.</p>
	</li>

	<li>
	<p>Include the customized file, named <code>init_relay.properties</code>,
	with your relay servlet application (eg, your portlet application, if
	that is where you are deploying the relay servlet). You can put the
	file anywhere that the system classloader searches: inside your portlet
	application (eg in <code>/WEB-INF/classes</code>) or in any folder
	outside of the WAR which is named in the classpath for your JVM. See
	the discussion on this point above, in regard to <a
		href="#overview.installation.i18n_portlet_config"><code>i18n_portlet_config.properties</code></a>
	- the same comments apply to <code>init_relay.properties</code>.</p>
	</li>
</ul>

<hr>

<a name="overview.dependencies">
<h3>1.2. Dependencies</h3>
</a>

<p>The SPF portlet utilities depend on WPAP and all of the various
technologies upon which WPAP in turn depends:</p>

<ul>
	<li>Spring Portlet MVC</li>
	<li>Java Portlet</li>
	<li>Java Servlet</li>
	<li>JSP</li>
</ul>

<p>In addition, the SPF portlet utilities depend on the SPF commmon
utilities (common utilities for both portlet and portal components in
the Shared Portal Framework).</p>

<p>All of these dependencies are managed through Maven. For a list
of the exact current dependencies, see the Maven POM for the SPF portlet
utilities. You can download it from the Maven repository mentioned
above. As usual, all of these JAR dependencies also need to be included
when you build your portlet application's <code>/WEB-INF/lib</code>.</p>

<hr>

<a name="overview.other">
<h3>1.3. Other libraries for SPF portlet developers</h3>
</a>

<a name="overview.other.wpap">
<h4>1.3.1. WPA Portlet Edition</h4>
</a>

<p>The SPF portlet utilities augment HP IT's WPA Portlet Edition
framework. Several facilities which SPF portlet developers will use
(such as Timber for logging) are provided by WPAP. See the developer's
site for WPA Portlet Edition here: <a
	href="http://intranet.hp.com/Sites/SOA/TechnicalDocs/WPAPortlet/Pages/framework.aspx"><code>http://intranet.hp.com/Sites/SOA/TechnicalDocs/WPAPortlet/Pages/framework.aspx</code></a></p>

<a name="overview.other.spring">
<h4>1.3.2. Spring Portlet MVC</h4>
</a>

<p>WPAP in turn augments the open-source Spring Portlet MVC
framework. The basic workflow of an SPF portlet, for example, is
typically provided by Spring Portlet MVC. See the Spring Portlet MVC
developer's site here: <a
	href="http://static.springframework.org/spring/docs/2.0.x/reference/portlet.html"><code>http://static.springframework.org/spring/docs/2.0.x/reference/portlet.html</code></a></p>

<a name="overview.other.portlet">
<h4>1.3.3. Portlet 2.0 (JSR 286)</h4>
</a>

<p>The SPF portlet utilities are compatible with JSR 286, the
Portlet 2.0 specification. They are built with the Portlet 2.0 API's.
Most features rely only on JSR 168 (Portlet 1.0); but some key features
(notably, access to use data) do require Portlet 2.0. Please use the
Portlet 2.0 API's for your project. Except where noted in this guide,
only JSR 168 is required.</p>

<a name="overview.other.spf.common">
<h4>1.3.4. SPF Common Utilities</h4>
</a>

<p>The SPF common utilities, used both by SPF portlets and portal
components (ie Vignette components), contain a number of useful API's
for SPF portlet developers, including:</p>

<ul>
	<li>building portal page URLs, including portal page URLs which
	target portlets on those pages and pass them parameters</li>
	<li>managing your application's configuration properties using
	hot-reloadable external files</li>
	<li>performing miscellaneous
	internationalization/localization-related tasks such as localized
	display of names (user, locale, timezone) in SPF-standard format, and
	transformation between locales, HP Passport language codes, and RFC
	3066 language tags</li>
	<li>and more</li>
</ul>

<p>These functionalities are in a separate package so that they can
be used by SPF's Vignette portal components as well. In some cases they
are inherited into the SPF portlet utilities (so you get them too when
you import the SPF portlet utility class), and in other cases you have
to import them directly.</p>

<p>See the SPF Common Utilities Developer's Guide here: <a
	href="http://samson.atl.hp.com:8080/hudson/job/spf-common-utilities/site/apidocs/overview-summary.html#top"><code>http://samson.atl.hp.com:8080/hudson/job/spf-common-utilities/site/apidocs/overview-summary.html</code></p>

<a name="overview.other.spf.htmlviewer">
<h4>1.3.5. SPF <code>htmlviewer</code> Portlet</h4>
</a>

<p>The Shared Portal Framework includes a portlet application, <code>htmlviewer</code>,
which you can use with minimal customization. This portlet renders a
text file, such as an HTML file (containing arbitrary HTML, JavaScript,
and/or CSS), to the user.</p>

<ul>
	<li>The file rendered is the best-fit localized version available
	for the user amongst a bundle of files located inside the application
	WAR, or on the server filesystem outside of it (eg where deposited an
	administrator).</li>

	<li>The file may also include <i>special markup tokens</i> for
	certain dynamic functionality, as per the SPF portlet utilities' <a
		href="#file">text interpolation</a> capabilities. For example, you can
	permission content in the file by group or role; include
	possibly-localized images and other static resources; etc.</li>

	<li>The <code>htmlviewer</code> portlet's <code>view</code> mode
	renders the file, and its <code>config</code> mode lets the portlet
	administrator configure the portlet (eg specify which bundle of HTML
	files to render).</li>
</ul>

<p>The <code>htmlviewer</code> portlet is often a quick and easy
basis for developing a simple, static or mostly-static portlet for your
SPF portal site. You don't write any code or configure any Spring or
portlet XML files; you just supply the text files for it to display.</p>

<p>For more information, see the SPF HTML Viewer Portlet
Administration and Developer's Guide here: <a
	href="http://samson.atl.hp.com:8080/hudson/job/spf-html-viewer/site/overview.html"><code>http://samson.atl.hp.com:8080/hudson/job/spf-html-viewer/site/overview.html</code></a></p>

<!-- The following is not true anymore; we have moved the classes into
the portlet WAR and not made them available for extension any longer.
DSJ 2009/5/28 -->

<!-- 
<blockquote>
<p><b>Note:</b> The Java classes for the <code>htmlviewer</code>
portlet are actually contained inside the SPF portlet utilities, so if
necessary you can extend them for your own Web application. This is not
covered in this guide. Please see the package, class and method
documentation for the following packages in the SPF portlet utilities,
if you are interested in this option:</p>

<dl>
	<dt>{@link com.hp.it.spf.xa.htmlviewer.portlet.web}</dt>
	<dd>This package contains the Spring controller classes for the <code>htmlviewer</code>
	portlet. The {@link
	com.hp.it.spf.xa.htmlviewer.portlet.web.ViewController} is the <code>view</code>
	mode controller, and the {@link
	com.hp.it.spf.xa.htmlviewer.portlet.web.ConfigController} is the <code>config</code>
	mode controller.</dd>
	<dt>{@link com.hp.it.spf.xa.htmlviewer.portlet.util}</dt>
	<dd>This package contains utility methods and constants used by
	the <code>htmlviewer</code> portlet classes and JSP's.</dd>
	<dt>{@link com.hp.it.spf.xa.htmlviewer.portlet.exception}</dt>
	<dd>This package contains exception classes used by the <code>htmlviewer</code>
	portlet classes and JSP's.
</dl>

<p>All other artifacts for the portlet - its JSP's, message
properties, deployment descriptor, etc - are inside the <code>htmlviewer</code>
WAR, for your reference.</p>
</blockquote>
-->

<hr>

<a name="i18n">
<h2>2. Internationalization</h2>
</a>

<p>Spring Portlet MVC (the basis of the SPF portlet utilities and
WPAP) provides basic support for internationalizing text strings
(message resources) in your portlet application. The SPF portlet
utilities (primarily the {@link
com.hp.it.spf.xa.i18n.portlet.I18nUtility} class) extend the Spring
functionality primarily in these directions:</p>

<ul>
	<li>internationalizing access to other static resources (images,
	PDF's, etc)</li>
	<li>injecting contextual help into your message resources</li>
	<li>placing no-localization reminders into your message resources</li>
	<li>supporting placement of all of these resources both internal
	and external to your portlet application</li>
	<li>miscellaneous useful methods, inherited from the common {@link
	com.hp.it.spf.xa.i18n.I18nUtility} class (see <a
		href="#i18n.other.common">using the common <code>I18nUtility</code></a>
	at the end of this section)</li>
</ul>

<p>This chapter describes these extensions.</p>

<hr>

<a name="i18n.resources">
<h3>2.1. Kinds of resources</h3>
</a>

<p>With the SPF portlet utilities, you can internationalize access
to your text strings (message resources) and other static resources
(supporting resources like images, HTML, PDF, etc), so that they can be
localized.</p>

<a name="i18n.resources.message">
<h4>2.1.1. Message resources (message properties)</h4>
</a>

<p><i>Message resources</i> (sometimes just called messages) are
text strings used in your UI. They are managed in Java message property
files as per the usual Java {@link java.util.ResourceBundle} standard.
If your application's messages are going to be sourced elsewhere - in a
database, an XML file, etc - you will have to arrange to export them
into Java message property format before they can be accessed through
SPF (or Spring).</p>

<p>SPF has a well-defined process for localizing your message
resources: translating them from a <i>base locale</i> (typically US
English) into the various other locales you need. See <a
	href="#i18n.l10n">localizing your resources</a>, below.</p>

<a name="i18n.resources.supporting">
<h4>2.1.2. Supporting resources (images, HTML, PDF, etc)</h4>
</a>

<p>In addition to message resources, the SPF portlet utilities
provide a solution for internationalized access to <i>supporting
resources</i>: static files like images, HTML, PDF, MS Word documents, etc.</p>

<p>SPF's localization process works for these files too, letting you
get them translated from a <i>base locale</i> (again, typically US
English) into the various other locales you need. See the discussion
around the <a href="#i18n.l10n.spf">SPF localization process</a>, below.</p>

<a name="i18n.resources.bundles">
<h4>2.1.3 Resource bundles</h4>
</a>

<p>Whether message property files, or supporting files, in SPF you
organize them into <i>resource bundles</i>. These are collections of
files containing identical content, just localized for different
locales. The <i>base file</i> contains the content for the base locale
(typically US English). The other files in the bundle each contain a
translation of that content for another locale. As with the Java
standard for {@link java.util.ResourceBundle}, the base file should <b>not</b>
have any locale tag, while the other files should be tagged according to
their locale, as follows:</p>

<blockquote><pre>
<i>base-filename</i>_<i>lang</i>_<i>CC</i>.<i>extension</i>
</pre></blockquote>

<ul>
	<li><i><code>lang</code></i> is the 2-character <a
		href="http://www.loc.gov/standards/iso639-2/php/English_list.php">ISO
	639-1</a> language code for the locale (lowercase)</li>
	<li><i><code>CC</code></i> is the 2-character <a
		href="http://www.iso.org/iso/country_codes/iso_3166_code_lists/english_country_names_and_code_elements.htm">ISO
	3166-1</a> country code for the locale (uppercase)</li>
</ul>

<p>For example, here is a collection of files constituting a message
resource bundle, where <code>messages.properties</code> is the <i>base
filename</i>:</p>

<blockquote><pre>
messages.properties         &lt;-- the base file
messages_ja_JP.properties   &lt;-- the same file localized for Japan - Japanese
messages_zh_CN.properties   &lt;-- the same file localized for China - Chinese
messages_zh_TW.properties   &lt;-- the same file localized for Taiwan - Chinese
</pre></blockquote>

<p>Here is a collection of files constituting an image resource
bundle, where <code>picture.jpg</code> is the base filename:</p>

<blockquote><pre>
picture.jpg         &lt;-- the base file
picture_ja_JP.jpg   &lt;-- the same file localized for Japan - Japanese
picture_zh_CN.jpg   &lt;-- the same file localized for China - Chinese
picture_zh_TW.jpg   &lt;-- the same file localized for Taiwan - Chinese
</pre></blockquote>

<p><b>Note:</b> SPF will generally use full (ie language- and
country-specific) locales. Your resource bundles are encouraged to do
likewise. However if you want to offer localization at the level of
language-only, you can do that. For example, while users of your portlet
may present with both France - French (<code>fr-FR</code>) and France -
Canada (<code>fr-CA</code>), if there is no difference in those
translations you could just have one file in your resource bundle for
them. Just drop the country code from the tagged locale:</p>

<blockquote><pre>
picture.jpg         &lt;-- the base file
picture_fr.jpg      &lt;-- the same file localized for country-generic French
picture_ja_JP.jpg   &lt;-- the same file localized for Japan - Japanese
picture_zh_CN.jpg   &lt;-- the same file localized for China - Chinese
picture_zh_TW.jpg   &lt;-- the same file localized for Taiwan - Chinese
</pre></blockquote>

<p>As with the Java standard for {@link java.util.ResourceBundle},
all of the SPF (and Spring) internationalization utilities will search
for the most-specific match for the user's locale first, ultimately
falling back upon your base file.</p>

<hr>
<a name="i18n.location">
<h3>2.2. Where to put your resources</h3>
</a>

<p>You have a choice where you put your resource bundles. You may
put them into your portlet application (WAR) where they would
traditionally go (we call these <i>internal resources</i>). But you may
also put them outside, into a well-known folder on the portlet server
called the <i>portlet resource bundle folder</i> - we call these <i>external
resources</i>.</p>

<a name="i18n.location.internal">
<h4>2.2.1. Internal resources (portlet application)</h4>
</a>

<p>You may put your message properties and supporting resource files
into your portlet WAR where they traditionally go:</p>

<ol>
	<li>
	<p>Your message properties would go into your <code>WEB-INF/</code>
	folder, under some appropriate sub-path accessible to your Spring
	configuration. For example:</p>

	<blockquote><pre>
	<i>&lt;root&gt;</i>
	    WEB-INF/
	        i18n/
       	        messages.properties
       	        messages_fr_FR.properties
       			...
	</pre></blockquote>

	<p>Also, be sure to configure Spring properly in your portlet
	application, so that can find those message properties. For example, if
	you use Spring's {@link
	org.springframework.context.support.ReloadableResourceBundleMessageSource}
	class, you would put this into your application context configuration
	for a bundle of message properties with basename of <code>messages</code>
	(eg <code>messages.properties</code>, <code>messages_fr_FR.properties</code>,
	etc):</p>

	<blockquote><pre>
	&lt;bean id="messageSource"
		class="org.springframework.context.support.ReloadableResourceBundleMessageSource"&gt;
		&lt;property name="basenames"&gt;
			&lt;list&gt;
				&lt;value&gt;
					WEB-INF/i18n/messages
				&lt;/value&gt;
				...  &lt;-- other message bundles in the basenames list go here
			&lt;/list&gt;
		&lt;/property&gt;
	&lt;/bean&gt;
	</pre></blockquote>

	<blockquote>
	<p><b>Note:</b> Whatever your message source configuration, be sure
	to put it into the root application context file for your portlet
	application. Do not put it into an application context file you have
	defined specifically for a portlet. Doing so will work with the Spring
	standard message API's and tags, but not with the SPF ones. Putting
	your message source configuration into the root application context
	file will work with both the Spring-standard and SPF API's and tags.</p>
	</blockquote>
	</li>

	<li>
	<p>Your other static resource files (images, videos, PDF's, etc)
	would go into respective folders at the root of your portlet WAR. For
	example, if you have a bundle of HTML files (<code>text.html</code>, <code>text_es_MX.html</code>,
	etc) and a bundle of images (<code>picture.jpg</code>, <code>picture_ja.jpg</code>,
	etc), they could go into your portlet WAR as follows:</p>

	<blockquote><pre>
	<i>&lt;root&gt;</i>
	    html/
	        text.html
	        text_es_MX.html
	        ...
	    images/
	        picture.jpg
	        picture_ja.jpg
	        ...
	</pre></blockquote>
	</li>
</ol>

<p>Then when you use the standard Spring message API's, or the SPF
portlet message API's in {@link
com.hp.it.spf.xa.i18n.portlet.I18nUtility}, or the tag libraries for
either, they will find your message resources inside your portlet WAR.
And when you use the localized file access API's in <code>I18nUtility</code>,
they will find your static resource files there likewise.</p>

<a name="i18n.location.external">
<h4>2.2.2. External resources (portlet resource bundle folder)</h4>
</a>

<p>You may instead put your messages and other resources <i>outside</i>
of your portlet WAR. Why? Doing so may have some advantages - for
example, it may make for easier administration of the resources.
Currently the SPF supports you putting them into what is called the <i>portlet
resource bundle folder</i>, which is any folder on the portlet server's
filesystem to which the portlet JVM has at least read access.</p>

<ol>
	<li>
	<p>Put the path for your portlet bundle folder into the classpath
	of your server's JVM. Or, put some parent path for it into the
	classpath. If you are using an application-hosting service (like SASU),
	they may already have defined for you a standard path from which to
	load so-called "global resources" (like externally-administered
	configuration files), and they may have put that into the classpath
	already. In any event, we recommend making the portlet bundle folder be
	a subfolder of your "global resources" classpath folder.</p>

	<p>For example, if you are using SASU, it may be that <code>/opt/sasuapps/sp/global_resources</code>
	is already your assigned classpath folder for all global resources (eg
	configuration files). If that is the case, we recommend creating the
	subfolder <code>portlet/i18n/</code> underneath it, so that <code>/opt/sasuapps/sp/global_resources/portlet/i18n/</code>
	is your portlet bundle folder (which matches the default assumed by the
	SPF portlet utilities, see point 3 below).</p>
	</li>

	<li>
	<p>Put your message properties and other resource files into your
	portlet bundle folder. We recommend you use subfolders for further
	organization - for example, you could put message properties in the
	portlet bundle folder proper; images in its <code>images/</code>
	subfolder; etc. Like this (example):</p>

	<blockquote><pre>
    /opt/sasuapps/sp/global_resources/ &lt;-- this is in the classpath
        ...                            &lt;-- misc other external config files can go here, like i18n_portlet_config.properties
        portlet/i18n/                  &lt;-- this is your portlet bundle folder
            html/                      &lt;-- this is your portlet bundle HTML subfolder
                text.html
                text_es_MX.html
                ...
            images/                    &lt;-- this is your portlet bundle images subfolder
                picture.jpg
                picture_ja.jpg
                ...
            messages.properties
            messages_fr_FR.properties
            ...
	</pre></blockquote>
	</li>

	<li>
	<p>Configure Spring properly so it can find those externalized
	message properties relative to the classpath. We recommend you use
	Spring's {@link
	org.springframework.context.support.ReloadableResourceBundleMessageSource}
	class, since that makes your message properties hot-reloadable (ie your
	administrator can update your message bundles without restarting the
	JVM). Your Spring application context configuration would look similar
	to the one for <a href="#i18n.location.internal">internal resources</a>
	- but be sure to specify loading from the <code>classpath:</code> and
	specify a positive <code>cacheSeconds</code>, like this:</p>

	<blockquote><pre>
	&lt;bean id="messageSource"
		class="org.springframework.context.support.ReloadableResourceBundleMessageSource"&gt;
		&lt;property name="cacheSeconds" value="1"/&gt;
		&lt;property name="basenames"&gt;
			&lt;list&gt;
				&lt;value&gt;
					classpath:portlet/i18n/messages
				&lt;/value&gt;
				...  &lt;-- other message bundles in the basenames list go here
			&lt;/list&gt;
		&lt;/property&gt;
	&lt;/bean&gt;
	</pre></blockquote>

	<blockquote>
	<p><b>Note:</b> Whatever your message source configuration, be sure
	to put it into the root application context file for your portlet
	application. Do not put it into an application context file you have
	defined specifically for a portlet. Doing so will work with the Spring
	standard message API's and tags, but not with the SPF ones. Putting
	your message source configuration into the root application context
	file will work with both the Spring-standard and SPF API's and tags.</p>
	</blockquote>
	</li>

	<li>
	<p>If you chose a non-default location for the portlet bundle
	folder, configure it in <a href="#i18n.other.i18n_portlet_config"><code>i18n_portlet_config.properties</code></a>
	(see below). The default location is hardcoded in {@link
	com.hp.it.spf.xa.i18n.portlet.I18nUtility#BUNDLE_DIR_DEFAULT}, which is
	<code>/opt/sasuapps/sp/global_resources/portlet/i18n</code> (as in the
	above example) at this time of writing.</p>
	</li>

	<li>
	<p>Finally, if you have non-message static resources (images, etc)
	in your portlet bundle folder, and you will be using {@link
	com.hp.it.spf.xa.i18n.portlet.I18nUtility} to make URL's for them (eg
	to render in the browser), note that SPF uses a <i>file relay
	servlet</i> (see <a href="#i18n.supporting.relay">discussion below</a>) to
	service those URL's. Deploy that relay servlet in any Web application
	which is <i>both</i> accessible to the end-user browser, and has access
	to the portlet bundle folder. For example, if you are using local
	portlets, you could deploy it in your portal application. By default,
	SPF assumes you have deployed it in your portlet application, mapped
	under the hardcoded {@link
	com.hp.it.spf.xa.i18n.portlet.I18nUtility#RELAY_PATH_DEFAULT} path. See
	the <a href="#i18n.supporting.relay">discussion below</a> for more
	information about deploying this servlet. If you deploy it in a
	non-default location, you will need to configure that in <a
		href="#i18n.other.i18n_portlet_config"><code>i18n_portlet_config.properties</code></a>,
	too.</p>
	</li>
</ol>

<p>Then when you use the standard Spring message API's, or the SPF
portlet message API's in {@link
com.hp.it.spf.xa.i18n.portlet.I18nUtility}, or the tag libraries for
either, they will find your message resources in your portlet bundle
folder. And when you use the localized file access API's in <code>I18nUtility</code>,
they will find your static resource files there likewise.</p>

<a name="i18n.location.both">
<h4>2.2.3. Mixing internal and external resources</h4>
</a>

<p>Note that you can mix both the internal and external approaches
for resource management, if you like:</p>

<ul>
	<li>
	<p>If you want to put some resource bundles inside your portlet WAR
	while keeping others external, you can do that. For example, you can
	keep your message bundles inside the WAR while keeping all your images
	in the portlet bundle folder.</p>
	</li>
	<li>
	<p>If you want to split a bundle across locations - eg keeping the
	English (base) files inside the portlet WAR and only keeping your
	localized versions outside - you can also do that.</p>
	</li>
	<li>
	<p>Finally, you can even have identically-named bundle files in
	both locations. For example, you can keep a "default" / "fallback" set
	of bundles inside your portlet WAR, and put "overrides" for them
	outside. SPF will search the portlet bundle folder first, only
	falling-back to look inside the portlet WAR if the resource was not
	found outside.</p>

	<blockquote>
	<p>There are some caveats to this regarding message properties,
	however. SPF uses Spring for access to message resources, and Spring
	searches these in the order set by the system classloader. For the
	"fallback" approach to work, this classloader needs to check inside
	your portlet application <i>last</i>, only after having <i>first</i>
	checked the classpath. You may or may not be able to control the load
	order used by the system classloader in your application server. Test
	it.</p>
	</blockquote>
	</li>
</ul>

<hr>
<a name="i18n.messages.java">
<h3>2.3. Accessing message resources using Java code</h3>
</a>

<p>Once your message resources have been created and placed <a
	href="#i18n.location">as discussed above</a>, you can begin to access
best-fit localized text strings for your user from them in your Java
code. You may use either the standard Spring API's for doing this, or
(recommended) the SPF API's.</p>

<p><b>Note:</b> In either case, be sure you have configured Spring
to load your message resource, as described above. And (if your message
resources are external to your portlet WAR) be sure you have configured
the <i>portlet resource bundle folder</i> where you put them, in your
JVM classpath.</p>

<p><b>Note:</b> In both cases, JSP tag libraries are available for
you to use instead of the raw Java API's. See the <a
	href="#i18n.messages.tags">discussion on this</a> below.</p>

<a name="i18n.messages.java.spring.getMessage">
<h4>2.3.1. Using Spring (eg <code>MessageSource.getMessage</code>)</h4>
</a>

<p>See the Spring documentation for any class implementing {@link
org.springframework.context.MessageSource} - for example, {@link
org.springframework.context.ApplicationContext}. You use one of the <code>getMessage</code>
API's, such as {@link
org.springframework.context.ApplicationContext#getMessage(String,Object[],String,Locale)}.</p>

<p><b>Note:</b> If you use the Spring API's, you will not benefit
from any of the <a href="#i18n.messages.java.spf.getMessage">enhanced
message capabilities</a> supported by the SPF portlet utilities' {@link
com.hp.it.spf.xa.i18n.portlet.I18nUtility} class.</p>

<a name="i18n.messages.java.spf.getMessage">
<h4>2.3.2. Using SPF (<code>I18nUtility.getMessage</code>)</h4>
</a>

<p>SPF's <code>I18nUtility.getMessage</code> API's wrap around
Spring and provide the following extra capability:</p>

<ul>
	<li>
	<p>In the <a href="#i18n.l10n.spf">SPF localization process</a>,
	you can mark sections of your messages which you do <b>not</b> want the
	translators to localize, using the special <code>&lt;no_localization&gt;...&lt;/no_localization&gt;</code>
	tags. The SPF <code>I18nUtility.getMessage</code> API's automatically
	remove these for you; Spring does not.</p>
	<p>For example, in your message properties you can have:</p>
	<blockquote><pre>
key=This part should be translated &lt;no_localization&gt;but this part should not&lt;/no_localization&gt;.
</pre></blockquote>
	<p>SPF's <code>I18nUtility.getMessage</code> API's will
	automatically remove the special <code>&lt;no_localization&gt;...&lt;/no_localization&gt;</code>
	markup from this, if the translator did not do so already.</p>
	</li>
	<li>
	<p>The SPF <code>I18nUtility.getMessage</code> API's let you <i>inject</i>
	<a href="#help.kinds.contextual">contextual help</a> into the middle of
	a message. This can be very useful when you need to use contextual
	help, because by definition contextual help is typically help content
	that is embedded inline with broader text. If you break such text
	apart, so that you can generate standalone contextual help around just
	the text unit needing it, the broader text might become difficult to
	translate correctly. Leaving the text intact, and injecting the
	contextual help into it, is the proper way to do it, and is supported
	by the SPF <code>I18nUtility.getMessage</code> API's.</p>
	<p>For example, you can have the following in your message
	properties:</p>
	<blockquote><pre>
key=Here is some &lt;contextual_help&gt;help&lt;/contextual_help&gt; for you.
</pre></blockquote>
	<p>The SPF <code>I18nUtility.getMessage</code> API's will
	automatically inject the contextual help which you provide around the
	content surrounded by the special <code>&lt;contextual_help&gt;...&lt;/contextual_help&gt;</code>
	markup ("help" in this example). More on this below.</p>
	</li>
</ul>

<p>The <code>I18nUtility.getMessage</code> API's are:</p>

<dl>
	<dt>{@link
	com.hp.it.spf.xa.i18n.portlet.I18nUtility#getMessage(PortletRequest,String)}</dt>
	<dt>{@link
	com.hp.it.spf.xa.i18n.portlet.I18nUtility#getMessage(PortletRequest,String,boolean)}</dt>
	<dt>{@link
	com.hp.it.spf.xa.i18n.portlet.I18nUtility#getMessage(PortletRequest,String,ContextualHelpProvider[])}</dt>
	<dt>{@link
	com.hp.it.spf.xa.i18n.portlet.I18nUtility#getMessage(PortletRequest,String,Locale)}</dt>
	<dt>{@link
	com.hp.it.spf.xa.i18n.portlet.I18nUtility#getMessage(PortletRequest,String,Object[])}</dt>
	<dt>{@link
	com.hp.it.spf.xa.i18n.portlet.I18nUtility#getMessage(PortletRequest,String,String)}</dt>
	<dt>{@link
	com.hp.it.spf.xa.i18n.portlet.I18nUtility#getMessage(PortletRequest,String,String,Object[],ContextualHelpProvider[],Locale,boolean)}</dt>
</dl>

<p>The last one is the core API which all the others feed into. Here
is a summary of the parameters it takes; the others take a subset of
these. See the method documentation for more information.</p>
<ul>
	<li>
	<p>The current {@link javax.portlet.PortletRequest} (required).</p>
	</li>

	<li>
	<p>The desired message key (required).</p>
	</li>

	<li>
	<p>A <code>String</code> default message value, to be returned
	automatically to you if the given message key is not found. (If no
	explicit default value is provided, then the message key itself is
	returned in that case.)</p>
	</li>

	<li>
	<p>An <code>Object[]</code> array containing any objects whose <code>toString</code>
	values should be inserted into any {@link java.text.MessageFormat}
	placeholders in the message. For example, in your message properties
	you can have:</p>

	<blockquote><pre>
	key=Your user ID is {0}.
	</pre></blockquote>

	<p>Then in your Java code, where <code>request</code> is the <code>PortletRequest</code>
	and <code>userID</code> is the user ID:</p>

	<blockquote><pre>
import com.hp.it.spf.xa.i18n.portlet.I18nUtility;
...
String[] args = new String[] { userID };
String msg = I18nUtility.getMessage(request, "key", args);
	</pre></blockquote>
	</li>

	<li>
	<p>A <code>ContextualHelpProvider[]</code> array containing any
	contextual help you wish to inject into the message. (What is
	contextual help, and what does it mean to inject it? See the <a
		href="#help.kinds.contextual">introduction to contextual help</a>
	later in this document.)</p>

	<p>For example, let's say you need to produce a UI message like
	this (where the word "secure" links to some contextual help not shown
	yet):</p>

	<img
		src="com/hp/it/spf/xa/i18n/portlet/doc-files/contextualHelpLink.jpg">

	<p>Using the SPF <code>I18nUtility.getMessage</code> API's, you can
	have the following in your message properties:</p>

	<blockquote><pre>
key=Your sign-in is &lt;contextual_help&gt;secure&lt;/contextual_help&gt;
</pre></blockquote>

	<p>Then, in your Java code, you can create a <a
		href="#help.contextual.java"><code>ContextualHelpProvider</code></a>
	(such as a <a
		href="#help.contextual.java.classicContextualHelpProvider"><code>ClassicContextualHelpProvider</code></a>)
	and pass it in this array. The <code>I18nUtility.getMessage</code>
	method will wrap the contextual-help HTML which that <code>ContextualHelpProvider</code>
	yields, around the part of the message surrounded by the special
	&lt;contextual_help&gt;...&lt;/contextual_help&gt; markup - ie the word
	"secure". So then you can just output that message and it will contain
	the embedded contextual help, too.</p>

	<p>Returning to the example, your message properties could look
	like this:</p>

	<blockquote><pre>
key=Your sign-in is &lt;contextual_help&gt;secure&lt;/contextual_help&gt;
key.help.title=Service Portal and your security
key.help.content=Internet security is important to us...
		</pre></blockquote>

	<p>And your code would look like this, where <code>request</code>
	and <code>response</code> are your {@link javax.portlet.PortletRequest}
	and {@link javax.portlet.PortletResponse}, respectively. <b>Note:</b>
	this demonstration uses a <a
		href="#help.contextual.java.classicContextualHelpProvider"><code>ClassicContextualHelpProvider</code></a>
	and does not override any of the default style.</p>

	<blockquote><pre>
import com.hp.it.spf.xa.i18n.portlet.I18nUtility;
import com.hp.it.spf.xa.help.portlet.ClassicContextualHelpProvider;
...
// First get the title for the contextual help.
String helpTitle = I18nUtility.getMessage(request, "key.help.title");
// Now get the main content for the contextual help.
String helpContent = I18nUtility.getMessage(request, "key.help.content");
// Now make the classic contextual help object.  Note we don't have to set
// the link content, as I18nUtility will infer that from the special markup
// in the message.
ClassicContextualHelpProvider cchp = new ClassicContextualHelpProvider(request, response);
cchp.setTitleContent(helpTitle);
cchp.setHelpContent(helpContent);
// Now get the main message, with the contextual help embedded automatically
// inside it.
ClassicContextualHelpProvider[] cchps = new ClassicContextualHelpProvider[] {cchp};
String msg = I18nUtility.getMessage(request, "key", cchps);
		</pre></blockquote>

	<p>So then you could output the <code>msg</code> string to the user
	- it would look like above when rendered in the user's browser. And
	when the user clicked on the "secure" hyperlink, it would look like
	this:</p>

	<img src="com/hp/it/spf/xa/i18n/portlet/doc-files/contextualHelp.jpg"></li>

	<p>Please see the <code>I18nUtility.getMessage</code> method
	documentation for more details about passing contextual help providers.
	Also see the discussion on <a href="#help.kinds.contextual">contextual
	help</a> later in this guide and in the JavaDocs - eg see the {@link
	com.hp.it.spf.xa.help.portlet.ClassicContextualHelpProvider}
	documentation.</p>

	<p>Also, note that the above example illustrates the use of the
	SPF-provided "classic" rendition of contextual help (ie the {@link
	com.hp.it.spf.xa.help.portlet.ClassicContextualHelpProvider} class).
	The SPF contextual-help framework is extensible to custom formats of
	contextual help, where you write and then utilize your own contextual
	help provider - see the discussion below about <a
		href="#help.contextual.java.contextualHelpProvider">creating your
	own contextual help provider</a>.</p>

	<blockquote>
	<p><b>Note:</b> The classic rendition of contextual help utilizes
	an "X" image on which the user can click to close the window. This is a
	GIF image which you must supply (either inside your portlet
	application, or in the external resource bundle folder). You can
	localize the image if desired. Name the base file for the image <code>btn_close.gif</code>
	and put it in the <code>images/</code> subfolder (of your portlet WAR
	or the external folder). Management of this image is the same as for
	any other supporting resource file.</p>

	<p>The SPF portlet utilities JAR contains a sample <code>btn_close.gif</code>.
	(It is the same one shown in the example above.)</p>
	</blockquote>

	<li>
	<p>A <code>Locale</code> for which to find the best-fitting message
	resource. (By default, the method uses the locale contained inside your
	<code>PortletRequest</code>.)</p>
	</li>

	<li>
	<p>A <code>boolean</code> switch which controls whether to escape
	any HTML meta-characters, like <code>&lt;</code> and <code>&gt;</code>,
	found in the message string. For example, if your message property is
	this:</p>

	<blockquote><pre>
key=This is an HTML &lt;head&gt; tag.
</pre></blockquote>

	<p>Then the following code would escape the HTML inside the message
	string (where <code>request</code> is your current {@link
	javax.portlet.PortletRequest}:</p>

	<blockquote><pre>
import com.hp.it.spf.xa.i18n.portlet.I18nUtility;
...
String msg = I18nUtility.getMessage(request, "key", true);
// Now msg is: This is an HTML&amp;lt;head&amp;gt; tag.
	</pre></blockquote>

	<p>If you use this with a message string that contains contextual
	help, note that this policy will apply to the contextual help's title
	and content as well.</p>
	</li>
</ul>

<hr>

<a name="i18n.messages.tags">
<h3>2.4. Accessing message resources using JSP tag libraries</h3>
</a>

<p>Once your message resources have been created and placed <a
	href="#i18n.location">as discussed above</a>, you can begin to access
best-fit localized text strings for your user from them in your JSP's.
You may use either the standard Spring JSP tag libraries for doing this,
or (recommended) the SPF ones.</p>

<p><b>Note:</b> In either case, be sure you have configured Spring
to load your message resource, as described above. And (if your message
resources are external to your portlet WAR) be sure you have configured
the <i>portlet resource bundle folder</i> where you put them, in your
JVM classpath. See the <a href="#i18n.location">discussion above</a>.</p>

<p><b>Note:</b> In both cases, raw Java API's are available for you
to use if you prefer, instead of the JSP tag libraries. See the <a
	href="#i18n.messages.java">API descriptions</a> above.</p>

<a name="i18n.messages.jsp.spring.message">
<h4>2.4.1. Using Spring (<code>&lt;spring:message&gt;</code>)</h4>
</a>

<p>See the Spring documentation for any Spring JSP tag interface for
{@link org.springframework.context.MessageSource} - for example, <a
	href="http://static.springframework.org/spring/docs/1.1.5/taglib/tag/MessageTag.html"><code>&lt;spring:message&gt;</code></a>.
</p>

<p><b>Note:</b> If you use the Spring tags, you will not benefit
from any of the <a href="#i18n.messages.jsp.spf.message">enhanced
message capabilities</a> supported by the SPF portlet utility tags.</p>

<a name="i18n.messages.jsp.spf.message">
<h4>2.4.2. Using SPF (<code>&lt;spf-i18n-portlet:message&gt;</code>,
<code>&lt;spf-i18n-portlet:param&gt;</code>, and <code>&lt;spf-i18n-portlet:classicContextualHelpParam&gt;</code>)</h4>
</a>

<p>The SPF portlet utilities provide a JSP tag library which wraps
around <a href="#i18n.java.spf.getMessage"><code>I18nUtility.getMessage</code></a>
to offer the same extended message-handling capabilities. Just as with <code>I18nUtility.getMessage</code>,
with the SPF portlet utilities' message-handling JSP tags, you can:</p>

<ul>
	<li>
	<p>Use <code>&lt;no_localization&gt;...&lt;/no_localization&gt;</code>
	in your message values to signal to translators that they should leave
	the contents untranslated - the SPF will automatically remove that
	markup if the translator did not do so already.</p>
	</li>

	<li>
	<p>Use <code>&lt;contextual_help&gt;...&lt;/contextual_help&gt;</code>
	in your message values to inject contextual help into the middle of a
	message (thus avoiding possible translation problems which could occur
	if you broke the message into pieces and used standalone contextual
	help).</p>
	</li>
</ul>

<p>The SPF message-handling tags are thoroughly documented in the <a
	href="com/hp/it/spf/xa/i18n/portlet/tag/package-summary.html#message">package
description</a>. Briefly, they are:</p>

<dl>
	<dt>
	<p><a
		href="com/hp/it/spf/xa/i18n/portlet/tag/package-summary.html#message"><code>&lt;spf-i18n-portlet:message&gt;</code></a></p>
	</dt>

	<dd>
	<p>This tag is the main message tag for the SPF. It takes a message
	key and (optionally) a default value and a boolean switch for
	HTML-escaping the message value. The usage is:</p>

	<blockquote><pre>
&lt;%@ taglib prefix="spf-i18n-portlet" uri="/spf-i18n-portlet.tld" %&gt;
...
&lt;spf-i18n-portlet:message
	key="<i>message-key</i>"
	defaultValue="<i>default-value</i>"
	escape="<i>true-or-false</i>"
	/&gt;
</pre></blockquote>
	</dd>

	<p>For example, consider this message property in your resource
	bundle:</p>

	<blockquote><pre>
key=This is an HTML &lt;head&gt; tag.
</pre></blockquote>

	<p>If you wanted the HTML embedded inside the message value to
	render literally, you would use this:</p>

	<blockquote><pre>
&lt;%@ taglib prefix="spf-i18n-portlet" uri="/spf-i18n-portlet.tld" %&gt;
...
&lt;spf-i18n-portlet:message key="key" escape="true" /&gt;
</pre></blockquote>

	<p>In addition, the body of the <code>&lt;spf-i18n-portlet:message&gt;</code>
	tag may contain either or both of the following tags, zero or more
	times.</p>

	<dt>
	<p><a
		href="com/hp/it/spf/xa/i18n/portlet/tag/package-summary.html#param"><code>&lt;spf-i18n-portlet:param&gt;</code></a></p>
	</dt>
	<dd>
	<p>This tag is only used inside the tag body of <code>&lt;spf-i18n-portlet:message&gt;</code>.
	You use it to pass a string into a {@link java.test.MessageFormat}
	placeholder in the message value. The usage is:</p>

	<blockquote><pre>
&lt;%@ taglib prefix="spf-i18n-portlet" uri="/spf-i18n-portlet.tld" %&gt;
...
&lt;spf-i18n-portlet:param value="<i>string</i>" /&gt;
</pre></blockquote>

	<p>For example, if your message properties contain this:</p>

	<blockquote><pre>
key=Your name is {0} and your age is {1}.
</pre></blockquote>

	<p>Then you would populate the parameters with the <code>name</code>
	and <code>age</code> variables as follows:</p>

	<blockquote><pre>
&lt;%@ taglib prefix="spf-i18n-portlet" uri="/spf-i18n-portlet.tld" %&gt;
...
&lt;spf-i18n-portlet:message key="key"&gt;
	&lt;spf-i18n-portlet:param value="&lt;%= name %&gt;" /&gt;
	&lt;spf-i18n-portlet:param value="&lt;%= age %&gt;" /&gt;
&lt;/spf-i18n-portlet:message&gt;
</pre></blockquote>
	</dd>

	<dt>
	<p><a href="#help.contextual.jsp.classicContextualHelpParam"><code>&lt;spf-i18n-portlet:classicContextualHelpParam&gt;</code></a></p>
	</dt>
	<dd>
	<p>This tag is only used inside the tag body of <code>&lt;spf-i18n-portlet:message&gt;</code>.
	You use it to inject contextual help into the message value, where the
	special <code>&lt;contextual_help&gt;...&lt;/contextual_help&gt;</code>
	markup is found. The format of contextual help which is injected is the
	"classic" rendition.</p>

	<p>This tag is documented in the <a href="#help">Online Help</a>
	section in this guide. Please see the <a
		href="#help.contextual.jsp.classicContextualHelpParam"><code>&lt;spf-i18n-portlet:classicContextualHelpParam&gt;</code></a>
	documentation there.</p>
	</dd>

	<dt>
	<p><a href="#help.contextual.jsp.contextualHelpProvider">Parameters
	for custom renditions of contextual help</a></p>
	</dt>
	<dd>
	<p>The SPF provides you with the <code>&lt;spf-i18n-portlet:classicContextualHelpParam&gt;</code>
	(see above) which gives you a JSP tag for injecting the "classic"
	rendition of contextual help into a message. The SPF contextual help
	framework is extensible, however, and you can create your own rendition
	of contextual help instead. First you would <a
		href="#help.contextual.java.contextualHelpProvider">create your
	custom contextual help provider</a>, then you would <a
		href="#help.contextual.jsp.contextualHelpProvider">create a custom
	contextual help provider parameter tag</a> for it. Please see the
	documentation below.</p>
	</dd>
</dl>

<p>The SPF message-handling tags are thoroughly documented in the <a
	href="com/hp/it/spf/xa/i18n/portlet/tag/package-summary.html#message">package
description</a>. Please see that documentation for more information.</p>

<hr>

<a name="i18n.supporting.java">
<h3>2.5. Accessing supporting resources using Java code</h3>
</a>

<p>Once your supporting resources have been created and placed <a
	href="#i18n.location.supporting">as discussed above</a>, you can begin
to access them using the SPF portlet <code>I18nUtility</code>. There are
3 ways of access supported:</p>

<ul>
	<li>
	<p>You can get a URL pointing to the particular supporting resource
	file in a bundle which best-fits the user's locale. You can then output
	that URL to the user - for example, inside an HTML <code>&lt;IMG&gt;</code>
	tag as the <code>SRC</code> attribute, to display the proper localized
	version of any image to the user. Use the <a
		href="#i18n.supporting.java.getLocalizedFileURL"><code>I18nUtility.getLocalizedFileURL</code></a>
	methods for this.</p>
	</li>

	<li>
	<p>If you need to process the file server-side instead, you can get
	an {@link java.io.InputStream} for the particular one which best-fits
	the user's locale. Use the <a
		href="#i18n.supporting.java.getLocalizedFileStream"><code>I18nUtility.getLocalizedFileStream</code></a>
	methods for this.</p>
	</li>

	<li>
	<p>If you need to just check what the best-fit localized file in a
	particular supporting resource would be, and whether it exists, then
	you can use the <a href="#i18n.supporting.java.getLocalizedFileName"><code>I18nUtility.getLocalizedFileName</code></a>
	methods for this.</p>
	</li>
</ul>

<p><b>Note:</b> In all of these cases, if you are putting your
supporting resource files in the portlet bundle folder outside of the
WAR, you will need to configure <a
	href="#i18n.other.i18n_portlet_config"><code>i18n_portlet_config.properties</code></a>
properly if your portlet bundle folder is not in the default location
(indicated in {@link
com.hp.it.spf.xa.i18n.portlet.I18nUtility#BUNDLE_DIR_DEFAULT}).</p>

<a name="i18n.supporting.java.getLocalizedFileURL">
<h4>2.5.1. Using <code>I18nUtility.getLocalizedFileURL</code></h4>
</a>

<blockquote>
<p><b>Note:</b> There is an SPF-provided JSP tag library for this -
see <a href="#i18n.supporting.jsp.localizedFileURL"><code>&lt;spf-i18n-portlet:localizedFileURL&gt;</code></a>
description below.</p>
</blockquote>

<p>These methods return a URL string which the user's browser can
use to access the proper localized version of a supporting resource for
the user's locale. Your bundle of supporting resource files can be
located inside your portlet WAR, or in the <i>portlet resource
bundle directory</i> outside of the WAR, or in both locations, <a
	href="#i18n.location.supporting">as discussed above</a>.</p>

<p>The returned URL string will be properly encoded for the portlet
(taking into account WSRP and the portal as needed), and thus ready to
output to the user (eg, in the <code>SRC</code> attribute of an HTML <code>&lt;IMG&gt;</code>
tag).</p>

<ul>
	<li>
	<p>If the best-fit localized file is found in the portlet bundle
	folder outside of the WAR, then the returned URL string will be a relay
	servlet URL pointing to that file. This URL will be built pointing to
	the URL for the relay servlet which you configured in <a
		href="#i18n.other.i18n_portlet_config"><code>i18n_portlet_config.properties</code></a>
	(or, by default, it will be assumed to be deployed under the {@link
	com.hp.it.spf.xa.i18n.portlet.I18nUtility#RELAY_PATH_DEFAULT} in the
	current portlet application). Be sure you have configured and deployed
	the relay servlet properly at that URL. See the <a
		href="#i18n.supporting.relay">discussion below</a> for more
	information.</p>
	</li>
	<li>
	<p>If the best-fit localized file is found inside the portlet WAR
	itself, then the returned URL string will be a static resource string
	pointing to that file.</p>
	</li>
</ul>

<p>The <code>I18nUtility.getLocalizedFileURL</code> methods are:</p>

<dl>
	<dt>{@link
	com.hp.it.spf.xa.i18n.portlet.I18nUtility#getLocalizedFileURL(PortletRequest,PortletResponse,String)}</dt>
	<dt>{@link
	com.hp.it.spf.xa.i18n.portlet.I18nUtility#getLocalizedFileURL(PortletRequest,PortletResponse,String,boolean)}</dt>
	<dt>{@link
	com.hp.it.spf.xa.i18n.portlet.I18nUtility#getLocalizedFileURL(PortletRequest,PortletResponse,String,Locale,boolean)}</dt>
	<dd>
	<p>These methods take the base filename of the supporting resource
	bundle. That filename may include any subfolder (relative to the
	portlet bundle directory / portlet WAR root) where the bundle is
	located. The methods use the Java-standard {@link
	java.util.ResourceBundle} sequence for finding the best-fit file in
	your bundle for the user's locale, looking across first your external
	resources, then your internal resources.</p>

	<p>For example, to get the best-fit localized URL for the <code>picture.jpg</code>
	image, where the bundle is stored (externally or internally) in the <code>images/</code>
	subfolder (and where <code>request</code> and <code>response</code> are
	the {@link javax.portlet.PortletRequest} and {@link
	javax.portlet.PortletResponse} respectively):</p>

	<blockquote><pre>
import com.hp.it.spf.xa.i18n.portlet.I18nUtility;
...
String url = I18nUtility.getLocalizedFileURL(request, response, "/images/picture.jpg");
	</pre></blockquote>

	<p>If the best-fit localized version of <code>picture.jpg</code>
	was found in the portlet bundle folder, then <code>url</code> in this
	example would be a file-relay servlet URL pointing to that file. For
	example, if <code>picture_pt_BR.jpg</code> (ie the Brazil Portuguese
	version of the file) was the best candidate, then <code>url</code>
	would get a URL string containing the portlet-encoded form of <code>/relay/images/picture_pt_BR.jpg</code>
	(assuming the default setup of the relay servlet, which is under the <code>/relay</code>
	location mapping in the current portlet application).</p>

	<p>On the other hand, if the best-fit localized version of <code>picture.jpg</code>
	was found inside the portlet WAR, then <code>url</code> in this example
	would be a static resource URL pointing to it. For example, it would be
	the portlet-encoded form of <code>/images/picture_pt_BR.jpg</code>.</p>

	<p>If the resource bundle for the given base name simply is not
	found, then a static resource URL pointing to the basename (eg <code>/images/picture.jpg</code>)
	would be returned by default. (This will cause a 404 error if later
	opened by the browser, making a missing resource obvious and detectable
	during testing.)</p>

	<p>{@link
	com.hp.it.spf.xa.i18n.portlet.I18nUtility#getLocalizedFileURL(PortletRequest,PortletResponse,String,Locale,boolean)}
	is the core API which all the others feed into. Here is a summary of
	the parameters it takes; the others take a subset of these. See the
	method documentation for more information.</p>

	<ul>
		<li>
		<p>The current {@link javax.portlet.PortletRequest} (required).</p>
		</li>
		<li>
		<p>The current {@link javax.portlet.PortletResponse} (required).</p>
		</li>
		<li>
		<p>The base filename (required).</p>
		</li>
		<li>
		<p>The {@link java.util.Locale} to use when searching for the
		best-fit candidate file. By default, the locale inside the <code>PortletRequest</code>
		is used.</p>
		</li>
		<li>
		<p>The boolean switch, set to <code>false</code>, lets you just
		lookup the given base file itself, without attempting to find the best
		candidate. By default, this switch is <code>true</code> (enabling the
		best-localized-candidate search).</p>
		</li>
	</ul>
	</dd>

	<dt>{@link
	com.hp.it.spf.xa.i18n.portlet.I18nUtility#getLocalizedFileURL(PortletRequest,PortletResponse,String,String)}</dt>
	<dt>{@link
	com.hp.it.spf.xa.i18n.portlet.I18nUtility#getLocalizedFileURL(PortletRequest,PortletResponse,String,String,Locale)}</dt>
	<dd>
	<p>These methods get the localized file differently. You give them
	a message key and they lookup that message in your message resource
	bundles. This message lookup proceeds as described for the <a
		href="#i18n.messages.java.spf.getMessage"><code>I18nUtility.getMessage</code></a>
	API's above. The message value is then treated as the name of the
	localized (not base) file. The subfolder relative to the portlet bundle
	folder or portlet WAR, where the file is located, may be part of that
	value. If no actual file exists (as either an external or internal
	resource) matching that value, then a static resource URL pointing to
	it anyway will be returned. (As above, this will intentionally cause a
	404 error should the browser open it.)</p>

	<blockquote>
	<p><b>Note:</b>These methods offer no real advantage over the
	others, since they are more cumbersome to setup (you need to make sure
	that the proper localized filenames for each locale get put - eg by the
	translators - into the message properties file for that locale).
	Therefore we recommend using the other methods.</p>
	</blockquote>

	<p>{@link
	com.hp.it.spf.xa.i18n.portlet.I18nUtility#getLocalizedFileURL(PortletRequest,PortletResponse,String,String,Locale)}
	is the core API which the other method feeds into. Here is a summary of
	the parameters it takes; the other method takes a subset of these. See
	the method documentation for more information.</p>

	<ul>
		<li>
		<p>The current {@link javax.portlet.PortletRequest} (required).</p>
		</li>
		<li>
		<p>The current {@link javax.portlet.PortletResponse} (required).</p>
		</li>
		<li>
		<p>The message key string for the localized filename (required).</p>
		</li>
		<li>
		<p>The default value string to use for the localized filename, if
		the message is not found.</p>
		<li>
		<p>The {@link java.util.Locale} to use when searching for the
		best-fit candidate file. By default, the locale inside the <code>PortletRequest</code>
		is used.</p>
		</li>
	</ul>
	</dd>
</dl>

<a name="i18n.supporting.java.getLocalizedFileStream">
<h4>2.5.2. Using <code>I18nUtility.getLocalizedFileStream</code></h4>
</a>

<p>Instead of returning a URL string, these methods return an {@link
java.io.InputStream} for the proper localized version of a supporting
resource, given the user's locale. If no appropriate file could be
found, then they return <code>null</code>. Otherwise they operate the
same as the <a href="#i18n.supporting.java.getLocalizedFileURL"><code>I18nUtility.getLocalizedFileURL</code></a>
methods (see above).
<p>The <code>I18nUtility.getLocalizedFileStream</code> methods are:</p>

<dl>
	<dt>{@link
	com.hp.it.spf.xa.i18n.portlet.I18nUtility#getLocalizedFileStream(PortletRequest,String)}</dt>
	<dt>{@link
	com.hp.it.spf.xa.i18n.portlet.I18nUtility#getLocalizedFileStream(PortletRequest,String,boolean)}</dt>
	<dt>{@link
	com.hp.it.spf.xa.i18n.portlet.I18nUtility#getLocalizedFileStream(PortletRequest,String,Locale,boolean)}</dt>
	<dd>
	<p>These methods take the base filename of the supporting resource
	bundle. Building on the above example, here is how we get an <code>InputStream</code>
	for the <code>something.xml</code> file. This file (and its localized
	versions) in this example are stored in the <code>xml/</code> subfolder
	of either the portlet WAR or the <i>portlet resource bundle folder</i>.</p>

	<blockquote><pre>
import com.hp.it.spf.xa.i18n.portlet.I18nUtility;
...
InputStream file = I18nUtility.getLocalizedFileStream(request, "/xml/something.xml");
	</pre></blockquote>

	<p>So, if the best-fit localized file in the <code>something.xml</code>
	bundle was <code>something_ja_JP.xml</code>, then that is the <code>InputStream</code>
	that will be returned. <code>null</code> is returned if no good
	candidate exists.</p>

	<p>{@link
	com.hp.it.spf.xa.i18n.portlet.I18nUtility#getLocalizedFileStream(PortletRequest,String,Locale,boolean)}
	is the core API which the others feed into. Here is a summary of the
	parameters it takes; the others take a subset of these. See the method
	documentation for more information.</p>

	<ul>
		<li>
		<p>The current {@link javax.portlet.PortletRequest} (required).</p>
		</li>
		<li>
		<p>The base filename (required).</p>
		</li>
		<li>
		<p>The {@link java.util.Locale} to use when searching for the
		best-fit candidate file. By default, the locale inside the <code>PortletRequest</code>
		is used.</p>
		</li>
		<li>
		<p>The boolean switch, set to <code>false</code>, lets you just
		lookup the given base file itself, without attempting to find the best
		candidate. By default, this switch is <code>true</code> (enabling the
		best-localized-candidate search).</p>
		</li>
	</ul>
	</dd>

	<dt>{@link
	com.hp.it.spf.xa.i18n.portlet.I18nUtility#getLocalizedFileStream(PortletRequest,String,String)}</dt>
	<dt>{@link
	com.hp.it.spf.xa.i18n.portlet.I18nUtility#getLocalizedFileStream(PortletRequest,String,String,Locale)}</dt>
	<dd>
	<p>This method gets the localized file differently. You give it a
	message key and it looks up that message in your message resource
	bundles. The message value is then treated as the name of the localized
	(not base) file, and an <code>InputStream</code> is returned for it (or
	<code>null</code> if it does not exist).</p>

	<blockquote>
	<p><b>Note:</b>Using this method offers no real advantage over the
	others, and is more cumbersome to setup (you need to make sure that the
	proper localized filenames for each locale, get into the message
	properties file for that locale). Therefore we recommend using the
	other methods.</p>
	</blockquote>

	<p>{@link
	com.hp.it.spf.xa.i18n.portlet.I18nUtility#getLocalizedFileStream(PortletRequest,String,String,Locale)}
	is the core API which the other method feeds into. Here is a summary of
	the parameters it takes; the other method takes a subset of these. See
	the method documentation for more information.</p>

	<ul>
		<li>
		<p>The current {@link javax.portlet.PortletRequest} (required).</p>
		</li>
		<li>
		<p>The message key string for the localized filename (required).</p>
		</li>
		<li>
		<p>The default value string to use for the localized filename, if
		the message is not found.</p>
		<li>
		<p>The {@link java.util.Locale} to use when searching for the
		best-fit candidate file. By default, the locale inside the <code>PortletRequest</code>
		is used.</p>
		</li>
	</ul>
	</dd>
</dl>

<a name="i18n.supporting.java.getLocalizedFileName">
<h4>2.5.3. Using <code>I18nUtility.getLocalizedFileName</code></h4>
</a>

<p>Instead of returning either a URL string or an {@link
java.io.InputStream}, these methods just lookup the best-fit localized
version of the file for the user's locale, and return its filename. The
filename is returned relative to the location where the file was found
(ie, relative to the <i>portlet resource bundle folder</i> or portlet
WAR root). The methods return <code>null</code> if no good candidate was
found. These methods are most useful as a test of whether a particular
resource exists, and where it exists (is it internal or external).</p>

<p>The <code>I18nUtility.getLocalizedFileName</code> methods are:</p>

<dl>
	<dt>{@link
	com.hp.it.spf.xa.i18n.portlet.I18nUtility#getLocalizedFileName(PortletRequest,String)}</dt>
	<dt>{@link
	com.hp.it.spf.xa.i18n.portlet.I18nUtility#getLocalizedFileName(PortletRequest,String,boolean)}</dt>
	<dt>{@link
	com.hp.it.spf.xa.i18n.portlet.I18nUtility#getLocalizedFileName(PortletRequest,String,Locale,boolean)}</dt>
	<dd>
	<p>These methods take the base filename of the supporting resource
	bundle, and <b>only</b> look inside the portlet application WAR.
	Building on the above example, here is how we check whether any
	good-candidate localized version of <code>something.xml</code> exists
	in the portlet WAR (in the <code>xml/</code> subfolder):</p>

	<blockquote><pre>
import com.hp.it.spf.xa.i18n.portlet.I18nUtility;
...
if (I18nUtility.getLocalizedFileName(request, "/xml/something.xml") != null) {
... // exists in portlet WAR
}
	</pre></blockquote>

	<p>{@link
	com.hp.it.spf.xa.i18n.portlet.I18nUtility#getLocalizedFileName(PortletRequest,String,Locale,boolean)}
	is the core API which the others feed into. Here is a summary of the
	parameters it takes; the others take a subset of these. See the method
	documentation for more information.</p>

	<ul>
		<li>
		<p>The current {@link javax.portlet.PortletRequest} (required).</p>
		</li>
		<li>
		<p>The base filename (required).</p>
		</li>
		<li>
		<p>The {@link java.util.Locale} to use when searching for the
		best-fit candidate file. By default, the locale inside the <code>PortletRequest</code>
		is used.</p>
		</li>
		<li>
		<p>The boolean switch, set to <code>false</code>, lets you just
		lookup the given base file itself, without attempting to find the best
		candidate. By default, this switch is <code>true</code> (enabling the
		best-localized-candidate search).</p>
		</li>
	</ul>
	</dd>

	<dt>{@link
	com.hp.it.spf.xa.i18n.portlet.I18nUtility#getLocalizedFileName(String,Locale)}</dt>
	<dt>{@link
	com.hp.it.spf.xa.i18n.portlet.I18nUtility#getLocalizedFileName(String,Locale,boolean)}</dt>
	<dd>
	<p>These methods take the base filename of the supporting resource
	bundle, and <b>only</b> look in the <i>portlet resource bundle
	folder</i>. Building on the above example, here is how we check whether any
	good-candidate localized version of <code>something.xml</code> exists
	in the portlet bundle folder (in the <code>xml/</code> subfolder):</p>

	<blockquote><pre>
import com.hp.it.spf.xa.i18n.portlet.I18nUtility;
...
if (I18nUtility.getLocalizedFileName("/xml/something.xml", request.getLocale()) != null) {
... // exists in portlet bundle folder
}
	</pre></blockquote>

	<p>{@link
	com.hp.it.spf.xa.i18n.portlet.I18nUtility#getLocalizedFileName(String,Locale,boolean)}
	is the core API which the other method feeds into. Here is a summary of
	the parameters it takes; the other method takes a subset of these. See
	the method documentation for more information.</p>

	<ul>
		<li>
		<p>The base filename (required).</p>
		</li>
		<li>
		<p>The {@link java.util.Locale} to use when searching for the
		best-fit candidate file (required)</p>
		</li>
		<li>
		<p>The boolean switch, set to <code>false</code>, lets you just
		lookup the given base file itself, without attempting to find the best
		candidate. By default, this switch is <code>true</code> (enabling the
		best-localized-candidate search).</p>
		</li>
	</ul>
	</dd>
</dl>

<hr>

<a name="i18n.supporting.jsp">
<h3>2.6. Accessing supporting resources using JSP tag libraries</h3>
</a>

<p>Once your supporting resources have been created and placed <a
	href="#i18n.location.supporting">as discussed above</a>, you can begin
to generate best-fit localized URL's for them in your JSP's. For
example, you can stick them into HTML <code>&lt;IMG&gt;</code> tag <code>SRC</code>
attributes.</p>

<p><b>Note:</b> Remember, if you are putting your supporting
resource files in the portlet bundle folder outside of the WAR, you will
need to configure <a href="#i18n.other.i18n_portlet_config"><code>i18n_portlet_config.properties</code></a>
properly if your portlet bundle folder is at a non-default location (the
default is indicated in {@link
com.hp.it.spf.xa.i18n.portlet.I18nUtility#BUNDLE_DIR_DEFAULT}). You will
likewise need to configure <a href="#i18n.other.i18n_portlet_config"><code>i18n_portlet_config.properties</code></a>
with the location for the relay servlet, if that is at a non-default
location. And finally, you will need to configure and deploy that
servlet at that location - see <a href="#i18n.supporting.relay">discussion
below</a>.</p>

<a name="i18n.supporting.jsp.localizedFileURL">
<h4>2.6.1. Using <code>&lt;spf-i18n-portlet:localizedFileURL&gt;</code></h4>
</a>

<p>The SPF portlet utilities provide a JSP tag, <code>&lt;spf-i18n-portlet:localizedFileURL&gt;</code>,
which wraps around <a href="#i18n.java.spf.getLocalizedFileURL"><code>I18nUtility.getLocalizedFileURL</code></a>
to offer most of the same capabilities. It is thoroughly documented in
the <a
	href="com/hp/it/spf/xa/i18n/portlet/tag/package-summary.html#getLocalizedFileURL">package
description</a>. Briefly:</p>

<dl>
	<dt>
	<p><a
		href="com/hp/it/spf/xa/i18n/portlet/tag/package-summary.html#localizedFileURL"><code>&lt;spf-i18n-portlet:localizedFileURL&gt;</code></a></p>
	</dt>

	<dd>
	<p>This tag takes the base filename (including any subfolder path
	relative to the portlet resource bundle folder / portlet WAR root), or
	(optionally) a message key for a message resource which indicates the
	localized file name. The usage is:</p>

	<blockquote><pre>
&lt;%@ taglib prefix="spf-i18n-portlet" uri="/spf-i18n-portlet.tld" %&gt;
...
&lt;spf-i18n-portlet:localizedFileURL
	file="<i>base-file</i>"
	fileKey="<i>localized-file-message-key</i>"
	/&gt;
</pre></blockquote>

	<p>The <code>file</code> attribute lets you provide the base
	filename (same as the {@link
	com.hp.it.spf.xa.i18n.portlet.I18nUtility#getLocalizedFileURL(PortletRequest,PortletResponse,String)}
	method). The <code>fileKey</code> attribute lets you alternatively
	provide a message key pointing to the localized filename (same as the
	{@link
	com.hp.it.spf.xa.i18n.portlet.I18nUtility#getLocalizedFileURL(PortletRequest,PortletResponse,String,String)}
	method). The <code>file</code> attribute takes priority. As mentioned
	above, there usually is no reason to prefer doing this using the <code>fileKey</code>
	attribute.</p>

	<p>For example, imagine we have the <code>picture.jpg</code> bundle
	of images in our <code>images/</code> folder. The following JSP code
	displays the proper localized version of that image in the browser:</p>

	<blockquote><pre>
&lt;%@ taglib prefix="spf-i18n-portlet" uri="/spf-i18n-portlet.tld" %&gt;
...
&lt;img src='&lt;spf-i18n-portlet:localizedFileURL file="/images/picture.jpg" /&gt;'&gt;
</pre></blockquote>

	<p>If you put the localized file into the <i>portlet resource
	bundle folder</i>, this URL will be a relay servlet URL (properly
	portlet-encoded for WSRP and the portal, as needed). Otherwise (ie you
	put the localized file into your portlet application), this URL will be
	a static resource URL for your application (again, properly-encoded).</p>

	<p>See the tag documentation, in the <a
		href="com/hp/it/spf/xa/i18n/portlet/tag/package-summary.html#localizedFileURL">package
	description</a>, for more information.</p>
	</dd>
</dl>

<hr>

<a name="i18n.supporting.relay">
<h3>2.7. Providing download service for external resources using <code>RelayServlet</code></h3>
</a>

<p>The <i>file relay servlet</i> is an SPF-provided servlet which
services download requests for supporting resource files in the <i>portlet
resource bundle folder</i>. If you are using <a
	href="#i18n.location.external">external resources</a> for supporting
files like images, video, etc, then when you use <a
	href="#i18n.supporting.java.getLocalizedFileURL"><code>I18nUtility.getLocalizedFileURL</code></a>
(or the <a href="#i18n.supporting.jsp.localizedFileURL"><code>&lt;spf-i18n-portlet:localizedFileURL&gt;</code></a>
tag) you will get a URL pointing to this servlet (with the actual
filename as a parameter in the URL). So if you give that URL to a
browser to open, it will be the relay servlet which services that
request.</p>

<p>The relay servlet itself is provided with the SPF portlet
utilities, {@link com.hp.it.spf.xa.relay.servlet.RelayServlet}. All you
need to do is configure and deploy it somewhere. We recommend you deploy
it as part of your portlet application WAR. Alternatively, you can
deploy it in another Web application (such as your portal application,
if your portal server has access to the portlet bundle folder - as in
the case of local portlets). The basic requirements are that, if you do
deploy it elsewhere, that Web application must have access to the
portlet bundle folder, and must in turn be accessible from the user
browser.</p>

<p>The basic steps for configuring and deploying the relay servlet
are documented fully in the <a
	href="com/hp/it/spf/xa/relay/servlet/package-summary.html">package
description</a>. Briefly, they are:</p>

<ol>
	<li><a
		href="com/hp/it/spf/xa/relay/servlet/package-summary.html#web.xml">Configure
	<code>web.xml</code></a> - provide the deployment descriptor for the
	servlet</li>
	<li><a
		href="com/hp/it/spf/xa/relay/servlet/package-summary.html#init_relay.properties">Configure
	<code>init_relay.properties</code> (optional)</a> - provide any non-default
	permitted file extensions and their MIME types</li>
	<li><a
		href="com/hp/it/spf/xa/relay/servlet/package-summary.html#i18n_portlet_config.properties">Configure
	<code>i18n_portlet_config.properties</code> (optional)</a> - provide any
	non-default portlet bundle folder or relay servlet location</li>
	<li><a
		href="com/hp/it/spf/xa/relay/servlet/package-summary.html#deployment">Assembling
	the application</a> - assemble the needed artifacts into the application
	WAR</li>
</ol>

<p>Please see the above-referenced documentation for more
information.</p>

<hr>

<a name="i18n.l10n">
<h3>2.8. Localizing your resources</h3>
</a>

<p>You can localize your resources (message property files, images,
HTML files, etc) in whatever way you see fit. The only requirements are:
</p>

<ul>
	<li>
	<p>For text resources, you must use UTF-8 character encoding.</p>
	</li>

	<li>
	<p>For Java message property files only, remember that Java's
	standard {@link java.util.Properties} class is the basis for loading
	those files into the system, and this class cannot load non-ASCII,
	UTF-8 characters natively. Therefore you must use the Java-standard <a
		href="http://java.sun.com/j2se/1.4.2/docs/tooldocs/solaris/native2ascii.html"><code>native2ascii</code></a>
	tool to convert your non-ASCII UTF-8-encoded characters into ASCII
	representation (specifically, into Java's supported <code>\uXXXX</code>
	string format for Unicode escape sequences).</p>
	</li>

	<li>
	<p>All localized resource files must be tagged with their
	respective locale as per the Java standard for {@link
	java.util.ResourceBundle}. This was already described in the section
	about <a href="#i18n.resources.bundles">resource bundles</a>, earlier
	in this document.</p>
	</li>
</ul>

<a name="i18n.l10n.spf">
<h4>2.8.1 The SPF localization process</h4>
</a>

<p>The Shared Portal Framework provides tools and support for a
localization process using HP's Translation and Localization (T&L) team.
This is a batch (not real-time) process combining manual and automated
activities. In this process:</p>

<ol>
	<li>
	<p>You <i>extract</i> your base (English) message and supporting
	resource files requiring localization from the system. You can do this
	in the lab (eg checkout from a your revision-control system) or in a
	run-time environment (eg extract from the base files already deployed
	in production).</p>
	</li>

	<li>
	<p>You <i>convert and pack</i> the base files for the T&L team,
	using an SPF-provided perl script, <code>xlate_send.pl</code>. For
	example, this removes any Vignette-internal message properties that
	never need localization, and packs your files into the T&L team's
	required format.</p>
	</li>

	<li>
	<p>You <i>send</i> the packed base files to the T&L team and
	request the needed locales.</p>
	</li>

	<li>
	<p>The T&L team <i>translates</i> them for you.</p>
	</li>

	<li>
	<p>You <i>receive</i> the translated files from the T&L team.</p>
	</li>

	<li>
	<p>You <i>unpack and convert</i> the translated files from the T&L
	team, using an SPF-provided perl script, <code>xlate_receive.pl</code>.
	For example, this unpacks the files from the T&L team's delivery
	format, and runs <a
		href="http://java.sun.com/j2se/1.4.2/docs/tooldocs/solaris/native2ascii.html"><code>native2ascii</code></a>
	for you against the translated message property files.</p>
	</li>

	<li>
	<p>Finally, you <i>deploy</i> your translations to the system. You
	can do this in the lab (eg checkin to your revision-control system) or
	in a run-time environment (eg deploy the translations directly to
	production).
	</li>
</ol>

<p>This process is not further documented in this guide. It is
covered in the <b>SPF Localization Guide</b>.</p>

<hr>

<a name="i18n.other">
<h3>2.9. Other internationalization topics</h3>
</a>

<p>This section covers miscellaneous other topics in the subject
area of internationalization.</p>

<a name="i18n.other.locale.get">
<h4>2.9.1. Getting the locale</h4>
</a>

<p>Use the Java portlet standard API for this, {@link
javax.portlet.PortletRequest#getLocale()}. As follows (where <code>request</code>
is your <code>PortletRequest</code>):</p>

<blockquote><pre>
Locale loc = request.getLocale();
</pre></blockquote>

<p>This returns the locale to use in general when handling this
portlet request. Many of the internationalization API's and tags
documented above assume this locale (but the API's all provide
signatures letting you pass another locale if needed).</p>

<p>Where does the locale come from? In SPF, for simplicity, the user
is considered to have one preferred locale at any given time. The SPF
portal framework has the responsibility of resolving that locale from
numerous sources:</p>

<ol>
	<li>The SPF locale resolver accepts desired locales from the user
	according to the following inputs (in order):
	<ol>
		<li>The HP.com-standard <code>lang</code> and <code>cc</code>
		query parameters on the URL.</li>
		<li>The HP.com-standard <code>lang</code> and <code>cc</code>
		cookies.</li>
		<li>The HP Passport core user profile attribute, <code>langCode</code>.
		(Note that the HP Passport <code>residentCountryCode</code> core
		profile attribute is not used by HPP itself for locale determination,
		so is not used by SPF either.)</li>
		<li>The HTTP-standard <code>Accept-Language:</code> request
		header.</li>
	</ol>
	</li>
	<li>The SPF locale resolver filters the above inputs by the <i>available
	locales</i> for your portal site. (When you configure your portal site in
	the SPF portal, you can specify the <i>default locale</i> to use at
	your site, as well as any <i>additional locales</i> to support at the
	site.)
	<ul>
		<li>The locale from the first input found to match one of the
		available locale(s) for the portal site, is the one resolved.</li>
		<li>If none of the inputs provide locale(s) that match the
		available ones, then the default locale for the portal site is
		resolved.</li>
	</ul>
	</li>
</ol>

<p>Once the SPF portal has resolved the locale, that is the locale
which is passed to your portlet inside the <code>PortletRequest</code>.</p>

<blockquote>
<p><b>Note:</b> Your <code>portlet.xml</code> does not need to
specify the JSR-standard <code>&lt;supported-locale&gt;...&lt;/supported-locale&gt;</code>
elements in order to have visibility to this locale.</p>
</blockquote>

<a name="i18n.other.locale.set">
<h4>2.9.2. Setting the locale</h4>
</a>

<p>Generally there is no need for you to be concerned with setting
the locale. Typically you will just use the <a
	href="#i18n.other.locale.get">locale you get</a>. It is the SPF
portal's responsibility to set the locale (including providing the user
with a locale selector widget with which the user can set his/her own
locale). In fact, in the Java portlet API's there are no standard
methods for setting the locale in the response, since that is delegated
to the portal.</p>

<p>If you have a use case where your portlet must set the locale,
the only way you can do this is by calling the portal. The locale
setting will only take effect on subsequent request lifecycles (ie <code>PortletRequest.getLocale</code>
will not start returning the new locale until subsequent requests in the
session) and it will take effect throughout the portal, not just in your
portlet. Consider this carefully before deciding to implement such a use
case.</p>

<p>To call the portal to set a new locale, you must make a {@link
com.hp.it.spf.xa.portalurl.PortalURL} with the new locale set as a
parameter in the URL. Then convert that <code>PortalURL</code> into a
string, and cause the user browser to open that URL string. (For
example, redirect to that URL, or present it as a link or form action to
submit.)</p>

<p>Depending on the type of portal page, and the parameters you
pass, your setting will take effect with varying degrees of persistence:</p>

<ul>
	<li>
	<p>To make the setting last for the rest of the session (until the
	user restarts his/her browser):</p>
	<ol>
		<li>
		<p>Create a {@link com.hp.it.spf.xa.portalurl.PortalURL} for any
		page at your portal site. This is the page where you want the user to
		go after the new locale has been set.</p>
		</li>
		<li>
		<p>Set the HP.com-standard <code>lang</code> and <code>cc</code>
		parameters as portal parameters on that <code>PortalURL</code>, using
		{@link
		com.hp.it.spf.xa.portalurl.PortalURL#setParameter(java.lang.String,
		java.lang.String)}.</p>
		<ul>
			<li>The <code>lang</code> parameter should be the <a
				href="http://www.loc.gov/standards/iso639-2/php/English_list.php">ISO
			639-1</a> language code for the new locale (use {@link
			java.util.Locale#getLanguage()}).</li>
			<li>The <code>cc</code> should be the <a
				href="http://www.iso.org/iso/country_codes/iso_3166_code_lists/english_country_names_and_code_elements.htm">ISO
			3166-1</a> country code (use {@link java.util.Locale#getCountry()} (or
			can be omitted if the locale does not include a country).</li>
		</ul>
		</li>
		<li>
		<p>When the user's browser opens this <code>PortalURL</code>, the
		SPF portal's locale resolver will resolve that new locale (see <a
			href="#i18n.other.locale.get">discussion above</a>) for the rest of
		the session, until the browser is restarted.</p>
		</li>
	</ol>
	</li>
	<li>
	<p>To make the setting last persistently (ie set it remains even
	after browser restart), just as if the user had chosen it with the SPF
	locale selector in the portal:</p>
	<ol>
		<li>
		<p>Create a {@link com.hp.it.spf.xa.portalurl.PortalURL} for any
		page at your portal site. This is the page where you want the user to
		go after the new locale has been set.</p>
		</li>
		<li>
		<p>Create another <code>PortalURL</code> for the SPF locale
		selector secondary page process-action. The friendly URI for this is
		the value of {@link
		com.hp.it.spf.xa.misc.portlet.Consts#PAGE_FRIENDLY_URI_SELECT_LOCALE}.</p>
		</li>
		<li>
		<p>In the SPF locale selector <code>PortalURL</code>, set the
		following parameters using the {@link
		com.hp.it.spf.xa.portalurl.PortalURL#setParameter(java.lang.String,
		java.lang.String)} method:</p>
		<ul>
			<li>The value of the first parameter should be the <a
				href="http://www.faqs.org/rfcs/rfc3066.html">RFC 3066</a> language
			tag for the new locale (use {@link
			com.hp.it.spf.xa.i18n.I18nUtility#localeToLanguageTag(Locale)}). The
			name of this parameter should be the value of {@link
			com.hp.it.spf.xa.misc.portlet.Consts#PARAM_SELECT_LOCALE}.</li>
			<li>The value of the second parameter should be the string of
			the first URL (ie where you want the user to be taken after the new
			locale has been set). The name of this parameter should be the value
			of {@link
			com.hp.it.spf.xa.misc.portlet.Consts#PARAM_SELECT_LOCALE_TARGET}.</li>
		</ul>
		</li>
		<li>
		<p>When the user's browser opens this SPF locale selector <code>PortalURL</code>,
		the SPF locale selector secondary page will set that new locale
		persistently.</p>
		</li>
	</ol>
	<li>
	<p><b>Note:</b> Neither of the above techniques works-around the
	fact that you can only set locales which are configured as available in
	the portal site.</p>
	</li>
</ul>

<a name="i18n.other.i18n_portlet_config">
<h4>2.9.3. Configuring <code>i18n_portlet_config.properties</code>
(optional)</h4>
</a>

<blockquote>
<p><b>Note:</b> You only need to concern yourself with <code>i18n_portlet_config.properties</code>
if you have <a href="#i18n.location.external">external supporting
resources</a> <b>and</b> you are either putting the <i>portlet resource
bundle folder</i> in a non-default location, <b>or</b> you are deploying the
<i>file relay servlet</i> in a non-default location.</p>
</blockquote>

<p>The <code>i18n_portlet_config.properties</code> lets you
configure the location of the portlet resource bundle folder, on the
portlet server, and the location of the file relay servlet.</p>

<dl>
	<dt><code>portlet.bundleDirectory</code></dt>
	<dd>
	<p>This property gives the fully-qualified pathname of the <i>portlet
	resource bundle folder</i> on the portlet server. For example:</p>
	<blockquote><pre>
portlet.bundleDirectory=/var/my_portlet/my_resources
</pre></blockquote>
	<p>The default value for this property is {@link
	com.hp.it.spf.xa.i18n.portlet.I18nUtility#BUNDLE_DIR_DEFAULT} and you
	do not need to configure this property if you accept the default.</p>
	</dd>
	<dt><code>servlet.fileRelay.url</code></dt>
	<dt><code>servlet.fileRelay.included</code></dt>
	<dd>
	<p>These properties give the location of the <i>file relay
	servlet</i>. The <code>servlet.fileRelay.url</code> property gives the URI,
	and the <code>servlet.fileRelay.included</code> property indicates if
	that URI is inside your portlet application (<code>true</code>) or
	somewhere else (<code>false</code>).</p>
	<p>For example, if you are deploying the relay servlet inside your
	portlet application (as is recommended), put your servlet mapping path
	into the <code>servlet.fileRelay.url</code> property and set the <code>servlet.fileRelay.included</code>
	property to <code>true</code>, like this (eg where you have used <code>&lt;servlet-mapping&gt;/getFile/*</code>
	in your deployment descriptor for the servlet):</p>
	<blockquote><pre>
servlet.fileRelay.url=/getFile
servlet.fileRelay.included=true
	</pre></blockquote>
	<p>As another example, if you are deploying the relay servlet in
	the SPF portal application (but remember it must have access to the
	portlet bundle folder, so this typically only works with a
	local-portlet architecture), then likewise put your servlet mapping
	path here, like this (eg where the SPF portal application is deployed
	under <code>/portal</code> and the relay servlet is under <code>&lt;servlet-mapping&gt;/relay/*</code>):</p>
	<blockquote><pre>
servlet.fileRelay.url=/portal/relay
servlet.fileRelay.included=false
	</pre></blockquote>
	<p>The default value for these properties are {@link
	com.hp.it.spf.xa.i18n.portlet.I18nUtility#RELAY_PATH_DEFAULT} and
	{@link
	com.hp.it.spf.xa.i18n.portlet.I18nUtility#RELAY_INCLUDED_DEFAULT} and
	you do not need to configure the properties if you accept their
	defaults.</p>
	</dd>
</dl>

<a name="i18n.other.init_relay">
<h4>2.9.4. Configuring <code>init_relay.properties</code>
(optional)</h4>
</a>

<blockquote>
<p><b>Note:</b> You only need to concern yourself with <code>init_relay.properties</code>
if you have <a href="#i18n.location.external">external supporting
resources</a> <b>and</b> you are dis-satisfied with the configuration in <code>init_relay_default.properties</code>
(which is delivered inside the SPF portlet utilities JAR). See the
discussion in the <a
	href="com/hp/it/spf/xa/relay/servlet/package-summary.html#init_relay.properties">package
description</a> for the relay servlet.</p>
</blockquote>

<p>The properties in <code>init_relay.properties</code> list all of
the allowed file extensions which the relay servlet will permit to be
downloaded from anywhere underneath the <i>portlet resource bundle
folder</i>. They also map to the MIME type which the servlet should specify
(on the HTTP <code>Content-Type:</code> response header) when
downloading that particular type of file to the user. The properties use
the following format:</p>

<blockquote><pre>
contentType.<i>file-extension</i>=<i>mime-type</i>
</pre></blockquote>

<p>For example:</p>

<blockquote><pre>
contentType.mov=video/quicktime # For Apple quicktime format using .mov extension
</pre></blockquote>

<p>This means that all <code>*.mov</code> files in the portlet
bundle folder will be permissible for download, and <code>Content-Type:
video/quicktime</code> will be used in the download.</p>

<a name="i18n.other.common">
<h4>2.9.5. Using the common <code>I18nUtility</code></h4>
</a>

<p>Above we have seen the various internationalization API's and
tags provided by the SPF portlet utilities, primarily in the {@link
com.hp.it.spf.xa.i18n.portlet.I18nUtility} class. Be aware that class
inherits from the common {@link com.hp.it.spf.xa.i18n.I18nUtility}, part
of the <a
	href="http://samson.atl.hp.com:8080/hudson/job/spf-common-utilities/site/apidocs/overview-summary.html">SPF
common utilities</a>. And the common <code>I18nUtility</code> provides
numerous miscellaneous methods related to internationalization,
encompassing:</p>

<ul>
	<li>Localized display of locale names, timezone names, user names,
	etc, in SPF-standard format</li>
	<li>Transformation between locales, HP Passport languages, and RFC
	3066 language tags</li>
	<li>And more.</li>
	<li><b>Note:</b> these inherited methods are documented in the <a
		href="http://samson.atl.hp.com:8080/hudson/job/spf-common-utilities/site/apidocs/overview-summary.html#top">SPF
	Common Utilities Developer's Guide</a> as well as in the JavaDoc for the
	{@link com.hp.it.spf.xa.i18n.portlet.I18nUtility} class.</li>
</ul>

<hr>

<a name="help">
<h2>3. Online Help</h2>
</a>

<p>The SPF portlet utilities' online help framework is discussed
here. These are the utilities with which you can develop online help for
your portlet's users.</p>

<hr>

<a name="help.kinds">
<h3>3.1. Kinds of online help</h3>
</a>

<p>The Shared Portal Framework provides for 3 levels of online help:
contextual, portlet, and global.</p>

<a name="help.kinds.contextual">
<h4>3.1.1. Contextual help (classic and custom; standalone and
injected)</h4>
</a>

<p><i>Contextual help</i> is a small amount of online help linked
directly from a screen element (eg text, image, form input label, etc)
and generally providing a definition or other kind of help about that
element. Contextual help is meant to be brief and specific about the
particular screen element from which it is linked.</p>

<p>SPF provides a contextual help framework for helping you develop
your contextual help. SPF comes with a "classic" rendition of contextual
help, where the linked screen element opens a DHTML popup window (table)
which is click-and-dragable by the user. Inside the popup window are a
brief help title, some brief help content, and an "X" image with which
to dismiss the window. An optional <code>ALT</code> can be provided for
the "X" image. For non-scripted browsers, "classic" contextual help
provides a no-script action on the link, which takes the user to a page
you provide, or your portlet's <code>help</code> mode by default (if
your portlet supports that mode).</p>

<p>For example, the text for "classic" contextual help might look
like this - notice the word <code>secure</code> is the linked screen
element in question:</p>

<img
	src="com/hp/it/spf/xa/i18n/portlet/doc-files/contextualHelpLink.jpg">

<p>When the user clicks on the link, the "classic" contextual help
popup might look like this:</p>

<img src="com/hp/it/spf/xa/i18n/portlet/doc-files/contextualHelp.jpg">

<p>With "classic" contextual help, the SPF-provided API's and JSP
tags let you define your own link, title, and help content, as well as
the no-script URL (or document fragment), window size, and style
(colors, etc).</p>

<p>What if you are not satisfied with the "classic" rendering of
contextual help? The SPF contextual help framework is extensible; you
can implement your own (ie custom) rendition of contextual help. (This
is explained in the section about <a
	href="#help.contextual.java.contextualHelpProvider">extending a <code>ContextualHelpProvider</code></a>.)</p>

<p>In any case, regardless of whether you are using classic or
custom contextual help, SPF lets you use it "standalone" around a screen
element, as well as "injected" into a message. With standalone
contextual help, the text or other HTML markup inside the
contextual-help hyperlink is expected to be its own unit, which can
stand alone for localization purposes. This is often the case when the
linked screen element is an image, or the label for a form input
element, for example.</p>

<p>Often, however, you may want to just link to contextual help from
a mere word or two within a sentence (as in the above example, where the
link surrounds the word <code>secure</code> within a broader sentence).
Trying to treat that as standalone would cause you to have to break the
sentence into pieces, perhaps making it difficult to translate. So SPF
lets you keep the sentence intact, as a single localizable message in
your message resources, and inject the contextual help around just the
part of the sentence needing to be linked.</p>

<p>Injection of contextual help into a message, is mostly discussed
in the <a href="#i18n">Internationalization</a> section above. See the <a
	href="#i18n.messages.java.spf.getMessage"><code>I18nUtility.getMessage</code></a>
Java API's and the <a href="#i18n.messages.jsp.spf.message"><code>&lt;spf-i18n-portlet:message&gt;</code></a>
JSP tag discussions above.</p>

<p>The remaining documentation for contextual help is covered in
this section, including the <a href="#help.contextual.java">Java
API's</a> and <a href="#help.contextual.jsp">JSP tags</a> for classic and
custom, standalone and injected forms.</p>

<a name="help.kinds.portlet">
<h4>3.1.2. Portlet help (help mode)</h4>
</a>

<p>The Java portlet standards support the concept of <code>help</code>
mode: an optional portlet mode you can implement, the purpose of which
is to display help about your portlet (or portlet application) to the
user. Using WPAP and Spring Portlet MVC you can readily implement
controllers and views for <code>help</code> mode to meet your needs.</p>

<p>Often, however, the purpose of your <code>help</code> mode will
simply be to display some largely-static help content to the user. SPF
assists you with this by letting you just author your help content as a
mostly-static HTML file, in which you can put text, image references,
CSS, JavaScript, and <i>special markup tokens</i> for certain dynamic
server-side behaviors. You just write this content, and then use one of
the SPF's <a href="#file">text interpolation</a> utilities to render it
for the user for <code>help</code> mode. See the <a href="#help.portlet">discussion
below</a>.</p>

<a name="help.kinds.global">
<h4>3.1.3. Portal help (global help)</h4>
</a>

<p>Finally, the SPF portal supports the concept of site-wide or <i>global
help</i>, which is online help content that covers your whole portal site
rather than a specific in-context screen element, or a specific portlet.</p>

<p>As it is site-wide, this is implemented in SPF at the portal
level rather than the portlet level. SPF provides a Vignette secondary
page and secondary page type for global help. The SPF portal owns and
operates these components, but each portal site can provide its own HTML
content file for it. As briefly discussed with <a
	href="#help.kinds.portlet">portlet help</a> above, this file can
contain whatever text, image references, CSS, JavaScript, and defined
dynamic behavior (ie special markup tokens) you need. You just write the
content and import it into the global help secondary page component in
Vignette. Because this is not a portlet developer's task, it is not
described further here.</p>

<blockquote>
<p><b>Note:</b></p>
As a general principle, portlets are discouraged from linking to global
help (although it is technically feasible to do so using the SPF common
utilities' {@link com.hp.it.spf.xa.portalurl.PortalURL} class - how to
do so is left as an exercise to the reader). Portlets should confine
themselves to <a href="#help.kinds.contextual">contextual help</a> and <a
	href="#help.kinds.portlet">portlet help</a> instead.</blockquote>

<hr>

<a name="help.contextual.java">
<h3>3.2. Producing contextual help using Java code</h3>
</a>

<p>The SPF portlet utilities include a Java class which implements
the "classic" rendering of contextual help for you, {@link
com.hp.it.spf.xa.help.portlet.ClassicContextualHelpProvider}. Or, if you
need to create your own rendition of contextual help, you can extend the
SPF contextual help framework to do so, by extending any class in the
{@link com.hp.it.spf.xa.help.ContextualHelpProvider} hierarchy.</p>

<a name="help.contextual.java.classicContextualHelpProvider">
<h4>3.2.1. Using <code>ClassicContextualHelpProvider</code></h4>
</a>

<blockquote>
<p><b>Note:</b> There is an SPF-provided JSP tag library for this -
see the <a href="#help.contextual.jsp.classicContextualHelp"><code>&lt;spf-help-portlet:classicContextualHelp&gt;</code></a>
description below for standalone help, and the <a
	href="#help.contextual.jsp.classicContextualHelpParam"><code>&lt;spf-i18n-portlet:classicContextualHelpParam&gt;</code></a>
description below for injected help.</p>
</blockquote>

<p>{@link
com.hp.it.spf.xa.help.portlet.ClassicContextualHelpProvider} is a Java
class in the SPF portlet utilities which knows how to render-out the
"classic" version of contextual help. Usage is as follows:</p>

<ol>
	<li>
	<p>First, you construct the object using the current {@link
	javax.portlet.PortletRequest} and {@link
	javax.portlet.PortletResponse}.</p>
	</li>

	<li>
	<p>Then, you set the attributes for the contextual help. The
	following setters are available:</p>

	<dl>
		<dt>{@link
		com.hp.it.spf.xa.help.portlet.ClassicContextualHelpProvider#setLinkContent(String)}</dt>
		<dd>
		<p>Sets the content of the contextual-help hyperlink. Pass in
		whatever HTML (text and markup) you want to be included inside the
		hyperlink. Use this if you are doing <i>standalone</i> contextual
		help. If you are <i>injecting</i> contextual help into a message,
		leave it unset.</p>
		</dd>

		<dt>{@link
		com.hp.it.spf.xa.help.portlet.ClassicContextualHelpProvider#setTitleContent(String)}</dt>
		<dd>
		<p>Sets the content for the title in the contextual-help popup.
		Pass in whatever HTML (text and markup) you need, but keep it very
		brief so that it fits well in the table.</p>
		</dd>

		<dt>{@link
		com.hp.it.spf.xa.help.portlet.ClassicContextualHelpProvider#setHelpContent(String)}</dt>
		<dd>
		<p>Sets the main help content in the contextual-help popup. Pass
		in whatever HTML (text and markup) you need, but keep it brief so that
		it fits well within the table.</p>
		</dd>

		<dt>{@link
		com.hp.it.spf.xa.help.portlet.ClassicContextualHelpProvider#setNoScriptHref(String)}</dt>
		<dd>
		<p>Optional. Provides a URL or document fragment to use in the
		link in the case of a no-script browser. If you pass in anything
		besides a document fragment (ie anything but a string beginning with <code>#</code>),
		then that will be used as the URL to open when the link is clicked in
		the no-script case. If you pass in a document fragment, or do not even
		call this setter at all, and your portlet supports <code>help</code>
		mode, then the contextual help no-script markup will point to your
		portlet's <code>help</code> mode (and pass your given fragment name,
		if any, as a render parameter named {@link
		com.hp.it.spf.xa.misc.portlet.Consts#PARAM_FRAGMENT}).</p>
		</dd>

		<dt>{@link
		com.hp.it.spf.xa.help.portlet.ClassicContextualHelpProvider#setWidth(int)}</dt>
		<dd>
		<p>Optional. Use this to set a non-default width for the popup, in
		pixels (the default width is {@link
		com.hp.it.spf.xa.help.portlet.ClassicContextualHelpProvider#DEFAULT_WIDTH},
		currently 300 pixels).</p>
		</dd>

		<dt>{@link
		com.hp.it.spf.xa.help.portlet.ClassicContextualHelpProvider#setBorderStyle(String)}</dt>
		<dt>{@link
		com.hp.it.spf.xa.help.portlet.ClassicContextualHelpProvider#setBorderClass(String)}</dt>
		<dd>
		<p>Optional. Use these to set an inline CSS style or refer to a
		CSS class, for the border properties. If you use the <code>setBorderStyle</code>
		method, you should pass one or more CSS properties which pertain to
		HTML <code>&lt;TABLE&gt;</code> borders, like <code>border-color:red;border-width:1px</code>.
		If you use the <code>setBorderClass</code> method, you should pass the
		name of a CSS class where you defined such properties. Basically, the
		strings you pass to these setters are used as the HTML <code>&lt;STYLE&gt;</code>
		and <code>&lt;CLASS&gt;</code> attributes for the HTML <code>&lt;TABLE&gt;</code>
		that defines the popup. The default border style is {@link
		com.hp.it.spf.xa.help.portlet.ClassicContextualHelpProvider#DEFAULT_BORDER_STYLE},
		currently 1-pixel solid black; if you want to reset this without
		providing any replacement style of your own, just call these setters
		with a blank string.</p>
		</dd>

		<dt>{@link
		com.hp.it.spf.xa.help.portlet.ClassicContextualHelpProvider#setTitleStyle(String)}</dt>
		<dt>{@link
		com.hp.it.spf.xa.help.portlet.ClassicContextualHelpProvider#setTitleClass(String)}</dt>
		<dd>
		<p>Optional. Use these to set an inline CSS style or refer to a
		CSS class, for the contextual help title. If you use the <code>setTitleStyle</code>
		method, you should pass one or more CSS properties which pertain to
		HTML <code>&lt;TD&gt;</code> cells, like <code>background-color:yellow;color:black</code>.
		If you use the <code>setTitleClass</code> method, you should pass the
		name of a CSS class where you defined such properties. Basically, the
		strings you pass to these setters are used as the HTML <code>&lt;STYLE&gt;</code>
		and <code>&lt;CLASS&gt;</code> attributes for the HTML <code>&lt;TD&gt;</code>
		cells that constitute the title inside the popup. The default title
		style is {@link
		com.hp.it.spf.xa.help.portlet.ClassicContextualHelpProvider#DEFAULT_TITLE_STYLE},
		currently bold white font on a blue background; if you want to reset
		this without providing any replacement style of your own, just call
		these setters with a blank string.</p>
		</dd>

		<dt>{@link
		com.hp.it.spf.xa.help.portlet.ClassicContextualHelpProvider#setHelpStyle(String)}</dt>
		<dt>{@link
		com.hp.it.spf.xa.help.portlet.ClassicContextualHelpProvider#setHelpClass(String)}</dt>
		<dd>
		<p>Optional. Use these to set an inline CSS style or refer to a
		CSS class, for the main contextual help content area. These work like
		<code>setTitleStyle</code> and <code>setTitleClass</code> do, except
		on the main help content area instead of the title. The default style
		is {@link
		com.hp.it.spf.xa.help.portlet.ClassicContextualHelpProvider#DEFAULT_HELP_STYLE},
		currently normal black font on a white background.</p>
		</dd>
	</dl>
	</li>

	<li>
	<p>Finally, you are ready to generate the contextual help:</p>

	<ul>
		<li>
		<p>If you are doing <i>standalone</i> contextual help, just call
		the {@link
		com.hp.it.spf.xa.help.portlet.ClassicContextualHelpProvider#getHTML(boolean)}
		method now. This will return the large HTML string containing all the
		HTML and JavaScript and CSS necessary to generate the contextual help
		link and its (initially hidden) popup, by calling the {@link
		com.hp.it.spf.xa.help.portlet.ClassicContextualHelpProvider#getHTML(boolean)}
		method. The boolean switch, if set <code>true</code>, enables
		HTML-escaping in the link, title, and main help content (ie any HTML
		meta-characters there like <code>&lt;</code> will be converted to
		their HTML escape sequences so as to be displayed literally in the
		browser).</p>
		</li>
		<li>
		<p>If you are <i>injecting</i> contextual help, just pass your <code>ContextualHelpProvider</code>
		into the <a href="#i18n.messages.java.spf.getMessage"><code>I18nUtility.getMessage</code></a>
		method. See the <a href="#i18n.messages.java.spf.getMessage">discussion
		above</a> for an example of this. The <code>getMessage</code> method will
		supply the link content from the message itself.</p>
		</li>
	</ul>
	</li>

	<li>
	<p>You can reuse the same <code>ClassicContextualHelpProvider</code>
	numerous times if you wish, The main JavaScript making the popup
	click-and-dragable will only be included the first time, unless you
	call the {@link
	com.hp.it.spf.xa.help.portlet.ClassicContextualHelpProvider#resetHTML()}
	method.</p>
	</li>
</ol>

<p>An example of injecting contextual help was shown above, in the
description of the <a href="#i18n.messages.java.spf.getMessage"><code>I18nUtility.getMessage</code></a>
methods. Standalone contextual help is very similar. For example,
imagine we have the following in our message properties:</p>

<blockquote><pre>
key.help.title=Service Portal and your security
key.help.content=Internet security is important to us...
</pre></blockquote>

<p>To provide that content as standalone classic contextual help
around an image (possibly localized) whose base name was <code>question_mark.gif</code>
(in the <code>images/</code> subfolder), with a gray title bar with
heavy black font, your code might look like this (where <code>request</code>
is your {@link javax.portlet.PortletRequest} and <code>response</code>
is your {@link javax.portlet.PortletResponse}):</p>

<blockquote><pre>
import com.hp.it.spf.xa.help.portlet.ClassicContextualHelpProvider;
...
// First get the title for the contextual help.
String helpTitle = I18nUtility.getMessage(request, "key.help.title");
// Now get the main content for the contextual help.
String helpContent = I18nUtility.getMessage(request, "key.help.content");
// Now make the HTML &lt;img&gt; tag for the link content.
String imgURL = I18nUtility.getLocalizedFileURL(request, response, "/images/question_mark.gif");
String imgTag = "&lt;IMG SRC='" + imgURL + "'&gt;"; 
// Now make the classic contextual help object and set its contents.
ClassicContextualHelpProvider cchp = new ClassicContextualHelpProvider(request, response);
cchp.setLinkContent(imgTag);
cchp.setTitleContent(helpTitle);
cchp.setHelpContent(helpContent);
// We want a gray title bar with bold black font.  It would be more flexible if we did this
// through a CSS class (and used cchp.setTitleClass) instead of hardcoding the style like this!
cchp.setTitleStyle("background-color:gray;color:black;font-weight:bold;font-style:italic");
// Now get the HTML for the whole contextual help link, image, and initially-hidden popup.
String html = cchp.getHTML(false);
</pre></blockquote>

<p>The resulting contextual help popup (when the user clicks on the
question-mark image) looks like this:</p>

<img
	src="com/hp/it/spf/xa/i18n/portlet/doc-files/contextualHelpGrayTitle.jpg">

<p>If the browser was unscripted, though, clicking on the link would
open your portlet's <code>help</code> mode. If your portlet has no <code>help</code>
mode, then the link would be inoperable (ie just the question-mark image
would display, with no contextual-help link around it at all).</p>

<p>Note that the classic contextual help popup includes an "X" image
on which the user can click to close the popup. Your portlet application
is expected to be deployed with that image (either as an external
resource, in the <i>portlet resource bundle folder</i>, or inside the
portlet WAR). The image must be named <code>btn_close.gif</code> and
must be in the <code>images/</code> subfolder. The SPF portlet utilities
JAR contains a sample <code>btn_close.gif</code> which you can copy, if
desired (it is the image seen in the examples here).</p>

<p>Your "X" image can optionally have an <code>ALT</code> text
string displayed with it when the user hovers the mouse over it. Put
your desired <code>ALT</code> message into one of your message resource
bundles, using the <code>contextualHelp.close.alt</code> message key.</p>

<p>See the {@link
com.hp.it.spf.xa.help.portlet.ClassicContextualHelpProvider} class
documentation, and the <a
	href="com/hp/it/spf/xa/i18n/portlet/package-summary.html">package
description</a>, for more information.</p>

<a name="help.contextual.java.contextualHelpProvider">
<h4>3.2.2. Extending a <code>ContextualHelpProvider</code> to
create a custom rendition</h4>
</a>

<p>If you need to create a custom version of contextual help, you
should extend either of these classes in the <a
	href="#overview.other.spf.common">SPF common utilities</a>: {@link
com.hp.it.spf.xa.help.ClassicContextualHelpProvider} or {@link
com.hp.it.spf.xa.help.ContextualHelpProvider}. The common {@link
com.hp.it.spf.xa.help.ClassicContextualHelpProvider} provides behavior
very close to the one <a
	href="#help.contextual.java.classicContextualHelpProvider">discussed
above</a>. The {@link com.hp.it.spf.xa.help.ContextualHelpProvider} is much
more generic. Basically, in each case you need to implement the abstract
methods, and potentially override any other methods to impose your
desired functionality.</p>

<p>Please read the class and method documentation for each class, in
order to familiarize yourself with their provided and abstract
functionality, so that you can decide which would be best for you to
extend.</p>

<hr>

<a name="help.contextual.jsp">
<h3>3.3. Producing contextual help using JSP tag libraries</h3>
</a>

<p>The SPF portlet utilities include two JSP tags which implements
the "classic" rendering of contextual help for you. One is for
standalone classic contextual help (<code>&lt;spf-help-portlet:classicContextualHelp&gt;</code>)
and the other is for injecting classic contextual help into a
surrounding message (<code>&lt;spf-help-portlet:classicContextualHelpParam&gt;</code>.
Or, if you have created a custom contextual help provider, you can
create your own JSP tag to wrap around it.</p>

<a name="help.contextual.jsp.classicContextualHelp">
<h4>3.3.1. Using <code>&lt;spf-help-portlet:classicContextualHelp&gt;</code>
for standalone classic contextual help</h4>
</a>

<p>You use this tag to express standalone contextual help with a
"classic" rendering. It wraps around the {@link
com.hp.it.spf.xa.help.portlet.ClassicContextualHelpProvider} to provide
the same capabilities for standalone help. The usage is:</p>

<blockquote><pre>
&lt;%@ taglib prefix="spf-help-portlet" uri="/spf-help-portlet.tld" %&gt;
...
&lt;spf-help-portlet:classicContextualHelp
	anchor="<i>link-content</i>"
	anchorKey="<i>link-content-message-key</i>"
	anchorImg="<i>link-image-url</i>"
	anchorImgKey="<i>link-image-base-file</i>"
	anchorImgAlt="<i>link-image-alt-text</i>"
	anchorImgAltKey="<i>link-image-alt-text-message-key</i>"
	title="<i>help-title</i>"
	titleKey="<i>help-title-message-key</i>"
	content="<i>help-content</i>"
	contentKey="<i>help-content-message-key</i>"
	noScriptHref="<i>uri</i>"
	width="<i>pixels</i>"
	borderStyle="<i>inline-style</i>'
	borderClass="<i>css-classname</i>"
	titleStyle="<i>inline-style</i>"
	titleClass="<i>css-classname</i>"
	contentStyle="<i>inline-style</i>"
	contentClass="<i>css-classname</i>"
	/&gt;
</pre></blockquote>

<p>Most of the tag attributes are optional. For example, suppose
your message properties contain this:</p>

<blockquote><pre>
key.help.title=Service Portal and your security
key.help.content=Internet security is important to us...
key.help.image.alt=Click for help
</pre></blockquote>

<p>And suppose you need to generate some standalone contextual help
with that content, linked from an image (possibly localized) whose base
name is <code>question_mark.gif</code> (in the <code>images/</code>
subfolder). Suppose that the contextual help title bar should use a gray
background with heavy black font. Then you could generate the image,
link, and (initially hidden) classic contextual help popup, using JSP
like this:</p>

<blockquote><pre>
&lt;%@ taglib prefix="spf-help-portlet" uri="/spf-help-portlet.tld" %&gt;
...
&lt;spf-help-portlet:classicContextualHelp 
	anchorImgKey="/images/question_mark.gif"
	anchorImgAltKey="key.help.image.alt"
	titleKey="key.help.title"
	contentKey="key.help.content"
	titleStyle="background-color:gray;color:black;font-weight:bold;font-style:italic"
	/&gt;
</pre></blockquote>

<p>This JSP would generate an HTML &lt;IMG&gt; tag, with the <code>SRC</code>
pointing at the properly-localized and portlet-encoded <code>question_mark.gif</code>
URL, and with the <code>ALT</code> showing the properly-localized
version of the <code>Click for help</code> message. When the user
clicked on the image, the resulting contextual help popup would look
like this:</p>

<img
	src="com/hp/it/spf/xa/i18n/portlet/doc-files/contextualHelpGrayTitle.jpg">

<p>If the browser was unscripted, though, clicking on the link would
open your portlet's <code>help</code> mode. If your portlet has no <code>help</code>
mode, then the link would be inoperable (ie just the image would
display, with no contextual-help link around it at all).</p>

<p>For more detailed description of this tag, see the tag
documentation, in the <a
	href="com/hp/it/spf/xa/help/portlet/tag/package-summary.html#classicContextualHelp">package
description</a>, for more information.</p>

<blockquote>
<p><b>Note:</b> The classic rendition of contextual help utilizes an
"X" image on which the user can click to close the window. This is a GIF
image which you must supply (either inside your portlet application, or
in the external resource bundle folder). You can localize the image if
desired. Name the base file for the image <code>btn_close.gif</code> and
put it in the <code>images/</code> subfolder (of your portlet WAR or the
external folder). Management of this image is the same as for any other
supporting resource file.</p>

<p>The SPF portlet utilities JAR contains a sample <code>btn_close.gif</code>
which you can copy. (It is the same one shown in the example above.)</p>
</blockquote>

<a name="help.contextual.jsp.classicContextualHelpParam">
<h4>3.3.2. Using <a
	href="com/hp/it/spf/xa/i18n/portlet/tag/package-summary.html#classicContextualHelpParam"><code>&lt;spf-i18n-portlet:classicContextualHelpParam&gt;</code></a>
for injected classic contextual help</h4>
</a>

<p>This tag is only used inside the tag body of <a
	href="#i18n.messages.jsp.spf.message"><code>&lt;spf-i18n-portlet:message&gt;</code></a>.
It wraps around the {@link
com.hp.it.spf.xa.help.portlet.ClassicContextualHelpProvider} to provide
the same capabilities for injected help. You use it to inject contextual
help into the message value, where the special <code>&lt;contextual_help&gt;...&lt;/contextual_help&gt;</code>
markup is found. The format of contextual help which is injected is the
"classic" rendition. The usage is:</p>

<blockquote><pre>
&lt;%@ taglib prefix="spf-i18n-portlet" uri="/spf-i18n-portlet.tld" %&gt;
...
&lt;spf-i18n-portlet:classicContextualHelpParam
	title="<i>help-title</i>"
	titleKey="<i>help-title-message-key</i>"
	content="<i>help-content</i>"
	contentKey="<i>help-content-message-key</i>"
	noScriptHref="<i>uri</i>"
	width="<i>pixels</i>"
	borderStyle="<i>inline-style</i>'
	borderClass="<i>css-classname</i>"
	titleStyle="<i>inline-style</i>"
	titleClass="<i>css-classname</i>"
	contentStyle="<i>inline-style</i>"
	contentClass="<i>css-classname</i>"
	/&gt;
</pre></blockquote>

<p>Most of the tag attributes are optional. For example, if your
message properties contain this:</p>

<blockquote><pre>
key=Your sign-in is &lt;contextual_help&gt;secure&lt;/contextual_help&gt;
key.help.title=Service Portal and your security
key.help.content=Internet security is important to us...
</pre></blockquote>

<p>Then you could generate the message, with classic contextual help
injected, in your JSP like this:</p>

<blockquote><pre>
&lt;%@ taglib prefix="spf-i18n-portlet" uri="/spf-i18n-portlet.tld" %&gt;
...
&lt;spf-i18n-portlet:message key="key"&gt;
	&lt;spf-i18n-portlet:classicContextualHelpParam titleKey="key.help.title" contentKey="key.help.content" /&gt;
&lt;/spf-i18n-portlet:message&gt;
</pre></blockquote>

<p>This JSP would generate a message looking in the user's browser
like this:</p>

<img
	src="com/hp/it/spf/xa/i18n/portlet/doc-files/contextualHelpLink.jpg">

<p>When the user clicked on the link, then the classic-rendition
contextual help would pop open:</p>

<img src="com/hp/it/spf/xa/i18n/portlet/doc-files/contextualHelp.jpg">

<p>Most of the other tag attributes can be used to change the style
(color, font, size) of the classic contextual help popup. See the tag
documentation, in the <a
	href="com/hp/it/spf/xa/i18n/portlet/tag/package-summary.html#classicContextualHelpParam">package
description</a>, for more information.</p>

<blockquote>
<p><b>Note:</b> The classic rendition of contextual help utilizes an
"X" image on which the user can click to close the window. This is a GIF
image which you must supply (either inside your portlet application, or
in the external resource bundle folder). You can localize the image if
desired. Name the base file for the image <code>btn_close.gif</code> and
put it in the <code>images/</code> subfolder (of your portlet WAR or the
external folder). Management of this image is the same as for any other
supporting resource file.</p>

<p>The SPF portlet utilities JAR contains a sample <code>btn_close.gif</code>
which you can copy. (It is the same one shown in the example above.)</p>
</blockquote>

<a name="help.contextual.jsp.contextualHelpProvider">
<h4>3.3.3. Creating a tag library for a custom rendition</h4>
</a>

<p>If you need to create a custom version of contextual help, you
can create a tag class to reference it. First, develop your custom
contextual help provider as described above, by <a
	href="#help.contextual.java.contextualHelpProvider">extending a <code>ContextualHelpProvider</code>
class</a> of your choosing.</p>

<p>Then create a tag class for it. Just as the SPF provides a class
hierarchy for the provider classes themselves, it provides a class
hierarchy for their tag classes.</p>

<ul>
	<li>If you extend {@link
	com.hp.it.spf.xa.help.ClassicContextualHelpProvider} then the tag class
	to extend is {@link
	com.hp.it.spf.xa.help.tag.ClassicContextualHelpBaseTag} (for a tag for
	standalone help) or {@link
	com.hp.it.spf.xa.i18n.tag.ClassicContextualHelpParamBaseTag} (for a tag
	for injected help).</li>
	<li>If you extend {@link
	com.hp.it.spf.xa.help.ContextualHelpProvider} then the tag class to
	extend is {@link com.hp.it.spf.xa.help.tag.ContextualHelpBaseTag} (for
	a tag for standalone help) or {@link
	com.hp.it.spf.xa.i18n.tag.ContextualHelpParamBaseTag} (for a tag for
	injected help).</li>
</ul>

<p>As you would expect, the <code>ClassicContextualHelpBaseTag</code>
and <code>ClassicContextualHelpParamBaseTag</code> provide behavior very
close to the <a href="#help.contextual.jsp.classicContextualHelp"><code>&lt;spf-help-portlet:classicContextualHelp&gt;</code></a>
and <a href="#help.contextual.jsp.classicContextualHelpParam"><code>&lt;spf-i18n-portlet:classicContextualHelpParam&gt;</code></a>
tags discussed above. The <code>ContextualHelpBaseTag</code> and <code>ContextualHelpParamBaseTag</code>
are much more generic. Basically, in each case you need to implement the
abstract methods, and potentially override any other methods to impose
your desired functionality. You also need to create your TLD file.</p>

<p>Please read the class and method documentation for each class, in
order to familiarize yourself with their provided and abstract
functionality, so that you can decide which would be best for you to
extend.</p>

<hr>

<a name="help.portlet">
<h3>3.4. Producing portlet help (help mode)</h3>
</a>

<p>For portlet-wide help, SPF portlet developers simply build a <code>help</code>
mode for their portlet as per the JSR portlet specification. First, in
your <code>portlet.xml</code> you add:</p>

<blockquote><pre>
&lt;supports&gt;
    ...    &lt;-- other "supports" configuration for your portlet
    &lt;portlet-mode&gt;help&lt;/portlet-mode&gt;
&lt;/supports&gt;
</pre></blockquote>

<p>Then you use Spring Portlet MVC, WPAP, and the SPF portlet
utilities to write your <code>help</code> mode artifacts (eg JSP,
possibly a controller, etc) and configure them in your application
context as you would for any other portlet mode. Finally, you use the
JSR-standard {@link javax.portlet.MimeResponse#createRenderURL()} and
{@link
javax.portlet.PortletURL#setPortletMode(javax.portlet.PortletMode)} to
then make a hyperlink URL pointing to your <code>help</code> mode.</p>

<p>What specific to portlet <code>help</code> mode does the SPF
offer? We realize that the job of <code>help</code> mode across many
portlets is often quite similar: to simply display some largely-static
localized text, possibly with images, video or other <a
	href="#i18n.resources.supporting">supporting resources</a> (themselves
potentially localized), to the user. Dynamic behaviors in the text are
often limited to displaying different help content corresponding to what
the user is authorized to see or do in the portlet.</p>

<p>If that description fits your portlet help, we advise you to use
SPF's <a href="#file">text interpolation</a> framework as the basis for
implementing your portlet help! It will save you some work.</p>

<ol>
	<li>
	<p>First, create an HTML file containing your help content. Also
	create any supporting resources (images, CSS files, video, etc) that go
	with it. In your HTML file, include whatever literal text, HTML tags,
	CSS style, JavaScript, etc your help content requires. Use the <a
		href="#file.author">special markup tokens</a> supported by the SPF
	file interpolator for dynamic behaviors such as:</p>

	<ul>
		<li><a href="#file.author.token.url">referencing proper
		localized URLs</a> for supporting resources in your <code>&lt;IMG&gt;</code>,
		<code>&lt;LINK&gt;</code>, etc tags
		<li><a href="#file.author.token.auth">limiting content to
		applicable users</a> - those who are authenticated (or not), who are in
		certain roles, etc</li>
	</ul>

	<p>For example, consider a portlet which is accessible to anonymous
	users, but has additional features only available to authenticated
	users. It also has a button (image) labeled "Go get it!" which, when
	clicked, performs some action. Here is an HTML file for portlet <code>help</code>
	mode for this. We have assumed that the "Go get it!" image is
	potentially localized, with a base name of <code>goGetIt.gif</code>, in
	the <code>images/</code> subfolder. We have also used the special
	tokens <code>{LOGGED-OUT}...{/LOGGED-OUT}</code> and <code>{LOCALIZED-CONTENT-URL:<i>pathname</i>}</code>
	which you can <a href="#file.author">read about below</a>. (As usual
	when writing HTML markup for a portlet, do not include the <code>&lt;HTML&gt;</code>,
	<code>&lt;HEAD&gt;</code>, or <code>&lt;BODY&gt;</code> tags.)</p>

	<blockquote><pre>
&lt;h1&gt;About this portlet&lt;/h1&gt;

{LOGGED-OUT}
&lt;blockquote&gt;
    &lt;font color="red"&gt;&lt;b&gt;You should login to have access to all features.&lt;/b&gt;&lt;/font&gt;
&lt;/blockquote&gt;
{/LOGGED-OUT}

&lt;p&gt;
    Here is how to use the 
    &lt;img src="{LOCALIZED-CONTENT-URL:/images/goGetIt.gif}" alt="Go get it!"&gt;
    button: ...
&lt;/p&gt;
</pre></blockquote>
	</li>

	<li>
	<p>Next you can localize your HTML file (and other supporting
	resources, like the <code>goGetIt.gif</code> image in the above
	example), resulting in a <a href="#i18n.resources.bundles">resource
	bundle</a> for it (and for the other supporting resources, as discussed
	earlier). Put your resource bundles (the base and localized files) into
	either the external <i>portlet resource bundle folder</i>, or inside
	your portlet WAR, also <a href="#i18n.location">as discussed
	earlier</a>.</p>
	</li>

	<li>
	<p>Now write and configure your code to render that interpolated
	HTML file when the user requests <code>help</code> mode. The steps here
	vary and are covered in the next sections. Remember that in any case,
	you have to configure your <code>portlet.xml</code> as discussed at the
	top of this section. (Likewise, to make a URL for a hyperlink pointing
	to <code>help</code> mode, use the Java-standard portlet API's
	mentioned at the top of this section.)</p>
	</li>
</ol>

<a name="help.portlet.jsp.interpolate">
<h4>3.4.1. Using <code>&lt;spf-file-portlet:interpolate&gt;</code>
for portlet help</h4>
</a>

<p>The easiest way to render an interpolated HTML file for your <code>help</code>
mode is using the <a href="#file.display.jsp.interpolate"><code>&lt;spf-file-portlet:interpolate&gt;</code></a>
JSP tag, provided in the SPF portlet utilities. Using this tag, you just
write a JSP wrapper around it, then configure Spring to map to that JSP
when <code>help</code> mode is invoked, and you're done.</p>

<p>Let's continue the example from above. Say that the basename for
the HTML file is <code>my_help.html</code>, and you put that HTML bundle
(eg <code>my_help.html</code>, <code>my_help_zh_CN.html</code>, etc)
into your <code>html/</code> subfolder (of your portlet application root
in the portlet WAR, or your external portlet bundle folder). Recall that
file referenced an image bundle, with base filename <code>goGetIt.gif</code>
in the <code>images/</code> subfolder - so assume that bundle (eg <code>goGetIt.gif</code>,
<code>goGetIt_zh_CN.gif</code>, etc) has also been put there, into the <code>images/</code>
subfolder.</p>

<p>Your JSP would then look like this:</p>

<blockquote><pre>
&lt;%@ taglib prefix="spf-file-portlet" uri="/spf-file-portlet.tld" %&gt;

&lt;spf-file-portlet:interpolate file="/html/my_help.html" /&gt;
</pre></blockquote>

<p>Then, to render that JSP directly through Spring Portlet MVC when
<code>help</code> mode is invoked in the render phase (eg by the user
clicking on your <code>help</code> mode hyperlink), just configure 2
Spring artifacts in your application context. (This could go in the main
<code>applicationContext.xml</code>, or in a portlet-specific one as is
commonly practiced when your application contains multiple portlets.)</p>

<ol>
	<li>
	<p>First, configure an instance of Spring's <code>ParameterizableViewController</code>
	so that it returns your JSP name (minus the file extension) as the view
	name. For example, assuming that your JSP (above) was named <code>my_help.jsp</code>:</p>

	<blockquote><pre>
&lt;bean id="myHelpForwarder"                       &lt;-- "id" is any value you choose
         class="org.springframework.web.portlet.mvc.ParameterizableViewController"&gt;
    &lt;property name="viewName" value="my_help"/&gt;  &lt;-- "value" attribute is your JSP name
&lt;/bean&gt;</pre></blockquote>

	<p><b>Note:</b> This is assuming you have already configured a
	JSP-capable view resolver for your portlet application. Doing so is
	basic Spring Portlet MVC and is not shown here.</p>
	</li>

	<li>
	<p>Then, use Spring's <code>PortletModeHandlerMapping</code> to map
	<code>help</code> mode requests into your <code>ParameterizableViewController</code>
	instance:</p>

	<blockquote><pre>
&lt;bean id="portletModeHandlerMapping" class="org.springframework.web.portlet.handler.PortletModeHandlerMapping"&gt;
    &lt;property name="portletModeMap"&gt;
        &lt;map&gt;
            ...                                  &lt;-- other entries for other modes go here
            &lt;entry key="help"&gt;
                &lt;ref bean="myHelpForwarder"/&gt;    &lt;-- "bean" is your "id" from above
            &lt;/entry&gt;
        &lt;/map&gt;
    &lt;/property&gt;
&lt;/bean&gt;</pre></blockquote>
	</li>
</ol>

<p>For more general information about using the <a
	href="#file.display.jsp.interpolate"><code>&lt;spf-file-portlet:interpolate&gt;</code></a>
tag, see the discussion later in this document.</p>

<a name="help.portlet.java.fileInterpolatorController">
<h4>3.4.2. Using <code>FileInterpolatorController</code> for
portlet help</h4>
</a>

<p>Another way to render an interpolated help HTML file for your <code>help</code>
mode is using the <a
	href="#file.display.java.fileInterpolatorController"><code>FileInterpolatorController</code></a>
base class, part of the SPF portlet utilities. You extend this base
class to implement your own controller. In your class, you implement at
least the following:</p>

<ul>
	<li>
	<p>One method ({@link
	com.hp.it.spf.xa.interpolate.portlet.web.FileInterpolatorController#getFilename(RenderRequest)})
	invoked during the render phase to return the base filename for the
	localized bundle of HTML help files.</p>
	</li>

	<li>
	<p>Another method ({@link
	com.hp.it.spf.xa.interpolate.portlet.web.FileInterpolatorController#execute(RenderRequest,RenderResponse,String)}),
	invoked after interpolating that file during the render phase. This
	method is passed the already-localized and interpolated content from
	the bundle, and is supposed to return a Spring <code>ModelAndView</code>
	for the dispatcher to forward. You can further manipulate the
	interpolated content in this method, or perform whatever other business
	logic your portlet help might require. You would set the interpolated
	content as a model element in the <code>ModelAndView</code> before
	returning.
	</li>
</ul>

<p>You would also implement the JSP (or other view artifact) which
finally presents the content.</p>

<p>This approach is more work for you to code than using <a
	href="#help.portlet.jsp.interpolate"><code>&lt;spf-file-portlet:interpolate&gt;</code></a>
(see above), so you would probably only use it when your portlet help
requirements involve additional business logic.</p>

<p>For more information on how to extend and implement <code>FileInterpolatorController</code>,
see the <a href="#file.display.java.fileInterpolatorController">discussion
in the next chapter</a>. Once you have your controller and view artifact (eg
JSP) ready, you would configure them in your Spring application context
as usual:</p>

<ol>
	<li>
	<p>First, configure an instance of your help controller class
	(named <code>com.hp.my.helpController</code> in this example).
	Depending on your actual implementation, you would probably set your
	JSP file name (minus the extension) as your <code>viewName</code>
	property, as usual. (This is assuming you have already configured a
	JSP-capable view resolver for your portlet application - doing so is
	basic Spring Portlet MVC and is not shown here.) For example, assuming
	that your JSP was named <code>my_help.jsp</code>:</p>

	<blockquote><pre>
&lt;bean id="myHelpController"                      &lt;-- "id" is any value you choose
      class="com.hp.my.helpController"&gt;          &lt;-- "class" is your controller (subclass of FileInterpolatorController)
    &lt;property name="viewName" value="my_help"/&gt;  &lt;-- "value" is your JSP name
&lt;/bean&gt;</pre></blockquote>
	</li>

	<li>
	<p>Then, use Spring's <code>PortletModeHandlerMapping</code> to map
	<code>help</code> mode requests into that instance of your help
	controller class:</p>

	<blockquote><pre>
&lt;bean id="portletModeHandlerMapping" class="org.springframework.web.portlet.handler.PortletModeHandlerMapping"&gt;
    &lt;property name="portletModeMap"&gt;
        &lt;map&gt;
            ...                                  &lt;-- other entries for other modes go here
            &lt;entry key="help"&gt;
                &lt;ref bean="myHelpController"/&gt;   &lt;-- "bean" is your "id" from above
            &lt;/entry&gt;
        &lt;/map&gt;
    &lt;/property&gt;
&lt;/bean&gt;</pre></blockquote>
	</li>
</ol>

<hr>

<a name="file">
<h2>4. Text Interpolation</h2>
</a>

<p>The SPF portlet utilities' text interpolation capabilities are
discussed in this chapter.</p>
<hr>

<a name="file.about">
<h3>4.1. About text interpolation</h3>
</a>

<blockquote>
<p><i><b>interpolate</b> (verb) - <b>1 a:</b> to alter ... (as a
text) by inserting new or foreign matter; <b>1 b:</b> to insert (words)
into a text... (ref: <a
	href="http://www.merriam-webster.com/dictionary/interpolate">http://www.merriam-webster.com/dictionary/interpolate</a>)</i>
</p>
</blockquote>

<p>The SPF portlet utilities include an engine for interpolating
text: parsing text strings for <i>special markup tokens</i> and
dynamically substituting, inserting, or deleting content accordingly.
The token language supports the following basic capabilities:</p>

<ul>
	<li><a href="#file.author.token.url">inserting dynamic URL's</a>
	for portal/portlet artifacts, such as the portal site home page URL,
	and URLs for <a href="#i18n.resources.supporting">supporting
	resources</a> like localized images (<a href="#i18n.location">external
	or internal</a>)
	<li><a href="#file.author.token.user">inserting user
	information</a>, such as name, email, language, or any other user property</li>
	<li><a href="#file.author.token.auth">permissioning content</a> so
	it is included only for authorized users (based on groups, roles, or
	logged-in status)</li>
	<li><a href="#file.author.token.consolidate">consolidating
	content</a> for ease of management (eg offloading common content into a
	separate properties file)</li>
	<li><a href="#file.author.token.misc">miscellaneous</a></li>
</ul>

<p>The SPF portlet utilities give you Java and JSP interfaces for
accessing this engine. You can access with raw strings, or you can
access and interpolate whole files (where those files too can be
localized and managed as external or internal supporting resources /
bundles).</p>

<hr>

<a name="file.display.java">
<h3>4.2. Interpolating text using Java code</h3>
</a>

<p>The SPF portlet utilities include a Java class for interpolating
text already loaded into a string (<a
	href="#file.display.java.tokenParser"><code>TokenParser</code></a>). Or
you can use <a href="#file.display.java.fileInterpolator"><code>FileInterpolator</code></a>
to load your text first from a (possibly localized file). A Spring
Portlet MVC controller, <a
	href="#file.display.java.fileInterpolatorController"><code>FileInterpolatorController</code></a>,
is also provided, which wraps-around that and which you can easily
bolt-into your portlet application (eg for implementing any portlet mode
which basically just displays text or whose dynamic behavior is within
the bounds of the <a href="#file.author">token language</a>).</p>

<a name="file.display.java.fileInterpolator">
<h4>4.2.1. Using <code>FileInterpolator</code> to interpolate text
from files</h4>
</a>

<blockquote>
<p><b>Note:</b> There is an SPF-provided JSP tag library for this -
see <a href="#file.display.jsp.interpolate"><code>&lt;spf-file-portlet:interpolate&gt;</code></a>
description below.</p>
</blockquote>

<p>The portlet {@link
com.hp.it.spf.xa.interpolate.portlet.FileInterpolator} is a plain Java
object which implements text interpolation for files. All of the other
file interpolation artifacts in the SPF portlet utilities wrap around
this one. (In turn, the <code>FileInterpolator</code> wraps around the <a
	href="#file.display.java.tokenParser"><code>TokenParser</code></a>
which interpolates text in strings.)</p>

<p>To use the <code>FileInterpolator</code>, first you construct it,
then you call its <code>interpolate</code> method. Here are the relevant
methods:</p>

<dl>
	<dt>{@link
	com.hp.it.spf.xa.interpolate.portlet.FileInterpolator#FileInterpolator(PortletRequest,PortletResponse,String)}</dt>
	<dt>{@link
	com.hp.it.spf.xa.interpolate.portlet.FileInterpolator#FileInterpolator(PortletRequest,PortletResponse,String,String)}</dt>
	<dt>{@link
	com.hp.it.spf.xa.interpolate.portlet.FileInterpolator#FileInterpolator(PortletRequest,PortletResponse,Locale,String,String)}</dt>
	<dd>
	<p>Use one of these constructors to instantiate the class. The
	arguments are:</p>

	<ul>
		<li>
		<p>Your current {@link javax.portlet.PortletRequest} object.</p>
		</li>
		<li>
		<p>Your current {@link javax.portlet.PortletResponse} object.</p>
		</li>
		<li>
		<p>The {@link java.util.Locale} you want to use during the file
		interpolation (ie to find the proper localized file, as well as to
		perform locale-dependent token substitutions within it). By default
		(ie if you do not specify this, or leave it null) the locale inside
		the portlet request is assumed.</p>
		</li>
		<li>
		<p>A string giving the base filename for the text file to
		interpolate. This is a base name for a bundle of one or more external
		or internal supporting resource files, potentially localized, as
		described in the <a href="#i18n.resources.bundles">resource bundle</a>
		discussion in this document. The files <b>must</b> be UTF-8 encoded
		and may contain any of the special markup tokens supported by <code>TokenParser</code>
		- see the discussion on <a href="#file.author">authoring text</a>
		below.</p>

		<p>If your files are contained in a subfolder of the <i>portlet
		resource bundle folder</i> or your portlet WAR, then the base filename
		string should include the subfolder as relative path.</p>
		</li>
		<li>
		<p>An optional string for a <i>token substitutions</i> property
		file. As discussed in the section about <a
			href="#file.author.token.consolidate">authoring text</a>, one of the
		special markup tokens (<code>{INCLUDE:<i>key</i>}</code>) substitutes
		values from this property file. By default, the name of the property
		file is considered to be <code>default_includes.properties</code>,
		with no subfolder, but you can override that with this parameter. If
		you will not be using the special <code>{INCLUDE:<i>key</i>}</code> or
		will use the default filename, you can ignore this parameter.</p>
		</li>
	</ul>
	</dd>

	<dt>{@link
	com.hp.it.spf.xa.interpolate.portlet.FileInterpolator#interpolate()}</dt>
	<dd>
	<p>You use this method to open the file and get its interpolated
	content. If you did not provide the {@link java.util.Locale}, then the
	one inside the portlet request is assumed.</p>

	<ol>
		<li>
		<p>First, the method finds the best-fit localized file for the
		base filename that was provided to the constructor. This proceeds as
		discussed for the <a
			href="#i18n.supporting.java.getLocalizedFileStream"><code>I18nUtility.getLocalizedFileStream</code></a>
		methods above.</p>
		</li>
		<li>
		<p>Then, the method parses the file content (using the <a
			href="#file.display.java.tokenParser"><code>TokenParser</code></a>)
		and performs all of the special markup processing described in the
		section about <a href="#file.author">authoring text</a>. If the file
		could not be found or read, or was empty, then null is returned (and a
		warning is logged).</p>
		</li>
	</ol>
	</dd>
</dl>

<p>For example, consider a <code>text.html</code> file with the
following content and special markup tokens:</p>

<blockquote><pre>
&lt;h1&gt;This is the base version&lt;/h1&gt;
&lt;ul&gt;
  &lt;li&gt;Your language:  {LANGUAGE-TAG}&lt;/li&gt;
  &lt;li&gt;The HP.com URL: {INCLUDE:url.hp}&lt;/li&gt;
{LOGGED-IN}
  &lt;li&gt;Your name:      {NAME}&lt;/li&gt;
{/LOGGED-IN}
&lt;/ul&gt;
</pre></blockquote>

<p>The <code>text_ja_JP.html</code> file is similar, except it has
been localized into Japanese for Japan (represented here identically,
except for mention of <code>Japanese</code> inside the &lt;H1&gt; tag,
for readability):</p>

<blockquote><pre>
&lt;h1&gt;This is the Japanese version&lt;/h1&gt;
&lt;ul&gt;
  &lt;li&gt;Your language:  {LANGUAGE-TAG}&lt;/li&gt;
  &lt;li&gt;The HP.com URL: {INCLUDE:url.hp}&lt;/li&gt;
{LOGGED-IN}
  &lt;li&gt;Your name:      {NAME}&lt;/li&gt;
{/LOGGED-IN}
&lt;/ul&gt;
</pre></blockquote>

<p>Also consider that we have put the HP.com homepage URL into a
token substitutions file named <code>my_tokens.properties</code>, as
follows:</p>

<blockquote><pre>
url.hp=http://www.hp.com
</pre></blockquote>

<p>Finally, consider that we have installed <code>my_tokens.properties</code>
somewhere accessible to the classloader. And consider that the 2 files
in the <code>text.html</code> bundle have been installed in the <code>html/</code>
subfolder of either the portlet bundle folder, or the portlet WAR.</p>

<p>To interpolate this bundle for the current user in his/her
current locale, using the portlet <code>FileInterpolator</code>, we use
the following code (where <code>request</code> is our {@link
javax.portlet.PortletRequest} and <code>response</code> is our {@link
javax.portlet.PortletResponse}):</p>

<blockquote><pre>
import com.hp.it.spf.xa.interpolate.portlet.FileInterpolator;
...
FileInterpolator file = new FileInterpolator(request, response, 
    "html/text.html",
    "my_tokens.properties");
String content = file.interpolate();
</pre></blockquote>

<p>For a logged-in Japanese user (first name <code>Bob</code>, last
name <code>Smith</code>), the returned <code>content</code> string is:</p>

<blockquote><pre>
&lt;h1&gt;This is the Japanese version&lt;/h1&gt;
&lt;ul&gt;
  &lt;li&gt;Your language:  ja-JP&lt;/li&gt;
  &lt;li&gt;The HP.com URL: http://www.hp.com&lt;/li&gt;

  &lt;li&gt;Your name:      Smith Bob&lt;/li&gt;

&lt;/ul&gt;
</pre></blockquote>

<p>(The name is displayed with the last name first, since that is
conventional for Japan. See {@link
com.hp.it.spf.xa.i18n.I18nUtility#getUserDisplayName(String,String,Locale)}.)</p>

<p>For a logged-out German user, the returned <code>content</code>
string is:</p>

<blockquote><pre>
&lt;h1&gt;This is the base version&lt;/h1&gt;
&lt;ul&gt;
  &lt;li&gt;Your language:  de-DE&lt;/li&gt;
  &lt;li&gt;The HP.com URL: http://www.hp.com&lt;/li&gt;

&lt;/ul&gt;
</pre></blockquote>

<p>Please see the class documentation for more information.</p>

<blockquote>
<p><b>Note:</b> These examples demonstrated only some of the special
markup tokens. For a good overview of all of them, see the discussion
below about <a href="#file.author">authoring text</a>.</p>
</blockquote>

<a name="file.display.java.fileInterpolatorController">
<h4>4.2.2. Using <code>FileInterpolatorController</code> to display
interpolated file content</h4>
</a>

<p>The {@link
com.hp.it.spf.xa.interpolate.portlet.web.FileInterpolatorController} is
an abstract instance of Spring's {@link
org.springframework.web.portlet.mvc.AbstractController}, which
implements file interpolation during the <i>render phase</i>, using the
portlet <a href="#file.display.java.fileInterpolator"><code>FileInterpolator</code></a>.
Many portal sites have at least a few portlets, or at least a few
portlet modes, which just basically display static text - or text with
some minor dynamic behavior. The <code>FileInterpolatorController</code>
lets you implement those use cases with the SPF text interpolation
capabilities integrated directly into Spring Portlet MVC.</p>

<p>The render-phase handler for this controller:</p>

<ol>
	<li>gets the base filename to display (an abstract method you
	implement),</li>
	<li>interpolates the proper localized file for the given base
	filename and the current request (locale, user attributes, etc),</li>
	<li>then passes the interpolated content to a custom <code>execute</code>
	method (and returns the Spring <code>ModelAndView</code> from that
	method) (another abstract method you implement).</li>
</ol>

<p>There are 2 abstract methods for you to implement:</p>

<dl>
	<dt>{@link
	com.hp.it.spf.xa.interpolate.portlet.web.FileInterpolatorController#getFilename(RenderRequest)}</dt>
	<dd>
	<p>Implement this method to return the base filename for the file
	to interpolate. This is used as the base filename parameter for the <code>FileInterpolator</code>.
	See the <a href="#file.display.java.fileInterpolator">above
	discussion</a> for more information.</p>

	<p>Depending on your use case and desired business logic, you may
	just hardcode this method to return the desired filename; get the
	desired filename from {@link javax.portlet.PortletPreferences}; etc.
	However you get it, just return it from this method. If you return null
	or a non-existent or empty file, then the interpolated file content
	will be null.</p>
	</dd>

	<dt>{@link
	com.hp.it.spf.xa.interpolate.portlet.web.FileInterpolatorController#execute(RenderRequest,RenderResponse,String)}</dt>
	<dd>
	<p>This method, which you implement, is given the string of
	interpolated content from the file, and is expected to return the
	Spring {@link org.springframework.web.portlet.ModelAndView} for Spring
	to forward for view processing. If there was a problem interpolating
	your file content (eg the file was non-existent or empty), the given
	string will be null.</p>

	<p>For example, in this method you could just copy the interpolated
	string into an attribute of that model. Or you could do whatever custom
	logic you need.</p>
	</dd>
</dl>

<p>In both of these methods, if you encounter an error, you can
throw an exception back. Your exception will be thrown by <code>FileInterpolatorController</code>
back to Spring, which will handle it according to the exception handling
you have setup for your Spring portlet.</p>

<p>There is also one class attribute you may wish to override:</p>

<dl>
	<dt>{@link
	com.hp.it.spf.xa.interpolate.portlet.web.FileInterpolatorController#includeFileName}</dt>
	<dd>
	<p>If desired, override this attribute (eg,inside your constructor
	or your <code>getFilename</code> method) and set it to the name (plus
	any needed relative path) of the <i>token substitution</i> property
	file to use during the interpolation. This is used as a parameter to
	the <code>FileInterpolator</code>. See the <a
		href="#file.display.java.fileInterpolator">above discussion</a> for
	more information. If your file to interpolate does not contain any <code>{INCLUDE:<i>key</i>}</code>
	tokens, or you are willing to use the default property file, you do not
	need to set this attribute.</p>
	</dd>
</dl>

<p>For example, here is a simple extension/implementation of the <code>FileInterpolatorController</code>.
This example class is for the same scenario as discussed for <code>FileInterpolator</code>
above. After interpolating, it sets the content as an element named <code>fileContent</code>
in the <code>ModelAndView</code> for the <code>fileDisplay</code> view,
where the JSP for that view will later be able to find it.</p>

<blockquote><pre>
package com.hp.it.my.package;
...
import com.hp.it.spf.xa.interpolate.portlet.web.FileInterpolatorController;
...
public class MyFileInterpolatorController extends FileInterpolatorController {

	public MyFileInterpolatorController() {
	    includeFileName = "my_tokens.properties";    
	}
    
	public String getFilename(PortletRequest request) {
		return ("html/text.html");
	}
	
	public ModelAndView execute(PortletRequest request,
	                            PortletResponse response,
	                            String content) throws Exception {
	    ModelAndView modelView = new ModelAndView("fileDisplay");
		modelView.addObject("fileContent", content);
		return modelView;
	} 
}
</pre></blockquote>

<p>For more information on extending/implementing {@link
com.hp.it.spf.xa.interpolate.portlet.web.FileInterpolatorController},
please see the class documentation.</p>

<p>After you have extended/implemented <code>FileInterpolatorController</code>,
remember that you need to configure it in your Spring application
context so that it is invoked for your desired portlet mode. Also,
presumably, you will want it to forward to some JSP or other view
resolver - don't forget that you need to configure that, too. (For an
example of this, for portlet <code>help</code> mode, see the <a
	href="#help.portlet.java.fileInterpolatorController">discussion
above</a>.)</p>

<a name="file.display.java.tokenParser">
<h4>4.2.3. Using <code>TokenParser</code> to interpolate strings</h4>
</a>

<p>The portlet {@link
com.hp.it.spf.xa.interpolate.portlet.TokenParser} is the engine at the
heart of text interpolation in the SPF portlet utilities. All of the
other classes and JSP tags perform text interpolation via this class.</p>

<p>With <code>TokenParser</code> you can perform text interpolation
against Java strings which you have already populated with content,
including any of the special markup tokens described in the <a
	href="#file.author">authoring discussion</a> below. First, you
construct your <code>TokenParser</code>, then you use any of its <code>parse</code>
methods to perform the desired interpolations.</p>

<p>Here are the relevant methods:</p>

<dl>
	<dt>{@link
	com.hp.it.spf.xa.interpolate.portlet.TokenParser#TokenParser(PortletRequest,PortletResponse)}</dt>
	<dt>{@link
	com.hp.it.spf.xa.interpolate.portlet.TokenParser#TokenParser(PortletRequest,PortletResponse,String)}</dt>
	<dt>{@link
	com.hp.it.spf.xa.interpolate.portlet.TokenParser#TokenParser(PortletRequest,PortletResponse,Locale,String)}</dt>
	<dd>
	<p>Use one of these constructors to instantiate the class. The
	arguments are:</p>

	<ul>
		<li>
		<p>Your current {@link javax.portlet.PortletRequest} object.</p>
		</li>
		<li>
		<p>Your current {@link javax.portlet.PortletResponse} object.</p>
		</li>
		<li>
		<p>The {@link java.util.Locale} you want to use during the string
		interpolation (ie when performing locale-dependent token substitutions
		within it). By default (ie if you do not specify this, or leave it
		null) the locale inside the portlet request is assumed.</p>
		</li>
		<li>
		<p>An optional string for a <i>token substitutions</i> property
		file. As discussed in the section about <a
			href="#file.author.token.consolidate">authoring text</a>, one of the
		special markup tokens (<code>{INCLUDE:<i>key</i>}</code>) substitutes
		values from this property file. By default, the name of the property
		file is considered to be <code>default_includes.properties</code>,
		with no subfolder, but you can override it with this parameter. If you
		will not be using the special <code>{INCLUDE:<i>key</i>}</code> or
		will use the default filename, you can ignore this parameter.</p>
		</li>
	</ul>
	</dd>

	<dt>{@link
	com.hp.it.spf.xa.interpolate.portlet.TokenParser#parse(String)}</dt>
	<dd>
	<p>You use this method to interpolate any string you provide. The
	parameters you gave the constructor will be used as the data sources
	for the inserted material. The <code>TokenParser.parse(String)</code>
	method performs all of the special markup processing described in the
	section about <a href="#file.author">authoring text</a>.</p>

	<p>Besides the <code>TokenParser.parse(String)</code> method, each
	individual token has its own parser method. For example, {@link
	com.hp.it.spf.xa.interpolate.portlet.TokenParser#parseEmail(String)} to
	just parse the given string for the <code>{EMAIL}</code> token. See the
	class documentation for a list of all the available methods. Generally
	you will want to use the full <code>TokenParser.parse(String)</code>
	method instead.</p>
	</dd>
</dl>

<p>For example, consider a string with the following content and
special markup tokens:</p>

<blockquote><pre>
&lt;ul&gt;
  &lt;li&gt;Your language:  {LANGUAGE-TAG}&lt;/li&gt;
  &lt;li&gt;The HP.com URL: {INCLUDE:url.hp}&lt;/li&gt;
{LOGGED-IN}
  &lt;li&gt;Your phone:     {USER-PROPERTY:PhoneNumber}&lt;/li&gt;
{/LOGGED-IN}
&lt;/ul&gt;
</pre></blockquote>

<p>(<code>PhoneNumber</code> is the defined user property key for
the phone number. See the authoring text discussion below, for how to
learn the names of the available user properties.)</p>

<p>Also consider that we have put the HP.com homepage URL into a
token substitutions file named <code>my_tokens.properties</code>, as
follows:</p>

<blockquote><pre>
url.hp=http://www.hp.com
</pre></blockquote>

<p>Finally, consider that we have installed <code>my_tokens.properties</code>
somewhere accessible to the classloader.</p>

<p>To interpolate this string for the current user in his/her
current locale, using the portlet <code>TokenParse</code>, we use the
following code (where <code>request</code> is our {@link
javax.portlet.PortletRequest}, <code>response</code> is our {@link
javax.portlet.PortletResponse}, and <code>raw</code> is the above string
of text):</p>

<blockquote><pre>
import com.hp.it.spf.xa.interpolate.portlet.TokenParser;
...
TokenParser parser = new TokenParser(request, response, "my_tokens.properties");
String interpolated = parser.parse(raw);
</pre></blockquote>

<p>For a logged-in French (Canada) user (with phone number <code>12345</code>),
the <code>interpolated</code> string is:</p>

<blockquote><pre>
&lt;ul&gt;
  &lt;li&gt;Your language:  fr-CA&lt;/li&gt;
  &lt;li&gt;The HP.com URL: http://www.hp.com&lt;/li&gt;

  &lt;li&gt;Your phone:     12345&lt;/li&gt;

&lt;/ul&gt;
</pre></blockquote>

<p>For a logged-out Italian (generic) user, the <code>interpolated</code>
string is:</p>

<blockquote><pre>
&lt;ul&gt;
  &lt;li&gt;Your language:  it&lt;/li&gt;
  &lt;li&gt;The HP.com URL: http://www.hp.com&lt;/li&gt;

&lt;/ul&gt;
</pre></blockquote>

<p>Please see the class documentation for more information.</p>

<blockquote>
<p><b>Note:</b> These examples demonstrated only some of the special
markup tokens. For a good overview of all of them, see the discussion
below about <a href="#file.author">authoring text</a>.</p>
</blockquote>

<hr>

<a name="file.display.jsp">
<h3>4.3. Interpolating text using JSP tag libraries</h3>
</a>

<p>The SPF portlet utilities include a JSP tag which wraps-around
the <a href="#file.display.java.fileInterpolator"><code>FileInterpolator</code></a>
for you: <code>&lt;spf-file-portlet:interpolate&gt;</code>.</p>

<a name="file.display.jsp.interpolate">
<h4>4.3.1. Using <code>&lt;spf-file-portlet:interpolate&gt;</code></h4>
</a>

<p>The SPF portlet utilities provide a JSP tag, <code>&lt;spf-file-portlet:interpolate&gt;</code>,
which wraps around <a href="#file.display.java.fileInterpolator"><code>FileInterpolator</code></a>
to offer most of the same capabilities. If you are authoring a portlet
mode which just needs to display some interpolated text from a file,
with dynamic behaviors limited to the bounds of the <a
	href="#file.author">supported token language</a>, then using this tag
is the the easiest way: you don't even need a controller class, just
write a JSP which calls this tag, and configure it into Spring.</p>

<p>The tag is thoroughly documented in the <a
	href="com/hp/it/spf/xa/interpolate/portlet/tag/package-summary.html#interpolate">package
description</a>. Briefly:</p>

<dl>
	<dt>
	<p><a
		href="com/hp/it/spf/xa/interpolate/portlet/tag/package-summary.html#interpolate"><code>&lt;spf-file-portlet:interpolate&gt;</code></a></p>
	</dt>

	<dd>
	<p>This tag takes the base filename (including any subfolder path
	relative to the portlet resource bundle folder / portlet WAR root), and
	(optionally) a filename for the <i>token substitutions</i> file. The
	usage is:</p>

	<blockquote><pre>
&lt;%@ taglib prefix="spf-file-portlet" uri="/spf-file-portlet.tld" %&gt;
...
&lt;spf-file-portlet:interpolate
	file="<i>base-file</i>"
	includeFile="<i>token-substitutions-file</i>"
	/&gt;
</pre></blockquote>

	<p>The <code>file</code> attribute lets you provide the base
	filename for the file to interpolate and display (same as the {@link
	com.hp.it.spf.xa.interpolate.portlet.FileInterpolator} constructors).</p>

	<p>The <code>includeFile</code> attribute lets you provide an
	override for the default token substitutions file, same as the {@link
	com.hp.it.spf.xa.interpolate.portlet.FileInterpolator#FileInterpolator(PortletRequest,PortletResponse,String,String)}
	constructor. This is used for any special <code>{INCLUDE:<i>key</i>}</code>
	tokens that might be found in the file content. (See the discussion on
	<a href="#file.author">authoring content</a> below, for a description
	of this and other dynamic tokens which the <code>FileInterpolator</code>
	supports.)</p>

	<p>For example, consider the sample scenario first described above,
	in the discussion around <a href="#file.display.java.fileInterpolator"><code>FileInterpolator</code></a>.
	Here is how we would express the interpolated content for that same
	file in JSP, using this tag:</p>

	<blockquote><pre>
&lt;%@ taglib prefix="spf-file-portlet" uri="/spf-file-portlet.tld" %&gt;
...
&lt;spf-file-portlet:interpolate file="/html/text.html" includeFile="my_tokens.properties" /&gt;
</pre></blockquote>

	<p>The selection of the proper localized file, and the subsequent
	interpolation, are performed using the attributes of the current
	request (its locale, user attributes, etc). See the tag documentation,
	in the <a
		href="com/hp/it/spf/xa/interpolate/portlet/tag/package-summary.html#interpolate">package
	description</a>, for more information.</p>
	</dd>
</dl>

<p>For an example of how you would configure your JSP which calls
this tag, directly into Spring without any controller class or other
Java code needed, see the the <a href="#help.portlet.jsp.interpolate">discussion
above</a> about portlet <code>help</code> mode.</p>

<hr>

<a name="file.display.htmlViewer">
<h3>4.4. Using the <code>htmlviewer</code> portlet to display
interpolated text from files</h3>
</a>

<p>The Shared Portal Framework includes a portlet application, <code>htmlviewer</code>,
which you can use with minimal customization. This portlet basically
wraps-around the file interpolation framework discussed above, at the
highest possible level: the portlet application.</p>

<p>If you have a portlet which needs to do nothing more than display
some basic text, with dynamic behaviors within the capabilities of the <a
	href="#file.author">text interpolation tokens</a>, then using <code>htmlviewer</code>
is the easiest way to inmplement. You write no Java code, no JSP, and no
Spring configuration. You just write the needed text file(s), and use
the Vignette site console to instantiate the needed portlet instance(s)
and configure them via the portlet's <code>config</code> mode so that
they use those file(s).</p>

<p>The <code>htmlviewer</code> portlet is covered in a separate
document, the <a
	href="http://samson.atl.hp.com:8080/hudson/job/spf-html-viewer/site/overview.html">SPF
HTML Viewer Portlet Administration and Developer's Guide</a> (see).</p>

<hr>

<a name="file.author">
<h3>4.5. Authoring text using interpolation tokens</h3>
</a>

<p>The text interpolation tokens supported by the SPF portlet
utilities are described briefly here. Each token is delimited by braces
<code>{...}</code> (although you can use angle-brackets instead of
braces, if you prefer <code>&lt;...&gt;</code>). Detailed information on
each token is provided in the class documentation for the {@link
com.hp.it.spf.xa.interpolate.portlet.FileInterpolator}.</p>

<blockquote>
<p><b>Important:</b> File interpolation only supports UTF-8 encoded
file content. If you are authoring your text in a file, be sure to use
UTF-8 encoding.</p>
</blockquote>

<blockquote>
<p><b>Note:</b> Many of the interpolation tokens take parameters.
You can use any of the tokens inside the parameters; they will be
interpolated before the parameter is used. Similarly, many of the tokens
get substituted with replacement values. Any tokens inside the inserted
values will also get interpolated. Finally, many of the tokens are
"container" tokens, which you use to surround content with to
conditionally include or exclude it. That surrounded content can contain
any of the tokens, including nested occurrences of the same token; they
will get interpolated too.
</blockquote>

<a name="file.author.token.url">
<h4>4.5.1. Referencing URLs (<code>{CONTENT-URL:<i>path</i>}</code>,
<code>{LOCALIZED-CONTENT-URL:<i>path</i>}</code>, <code>{REQUEST-URL}</code>,
<code>{REQUEST-URL:<i>spec</i>}</code>, <code>{SITE-URL}</code>, <code>{SITE-URL:<i>spec</i>}</code>)</h4>
</a>

<p>The following tokens can be used to interpolate URL's into your
text. Please click on the links for more documentation for each token.</p>

<dl>
	<dt><a
		href="com/hp/it/spf/xa/interpolate/portlet/FileInterpolator.html#content-url"><code>{CONTENT-URL:<i>pathname</i>}</code></a></dt>
	<dd>
	<p>Use this token to insert a URL for an <b>unlocalized</b>
	supporting resource file into the interpolated content. The file can be
	an <a href="#i18n.location">external or internal</a> <a
		href="#i18n.resources.supporting">supporting resource</a>, of any file
	type (for example, an image). If it is external, you will get a URL for
	the <i>file relay servlet</i>; if it is internal, you will get a static
	resource URL for your portlet application. In either case, the URL will
	be properly portlet-encoded for presentation to the user.</p>

	<p>The <code><i>pathname</i></code> in the token should give the
	name of the resource file, led by any subfolder(s) relative to the <i>portlet
	resource bundle folder</i> (for an external resource) or the portlet WAR
	root (for an internal resource). Here is some example HTML text using
	this token to help build an HTML &lt;IMG&gt; tag:</p>

	<blockquote><pre>
&lt;IMG SRC="{CONTENT-URL:/images/picture.jpg}"&gt;
</pre></blockquote>

	<p><b>Note:</b> If you are placing your resource files outside of
	the WAR, you must have <a href="#i18n.supporting.relay">configured
	and deployed</a> the relay servlet accordingly. You also must have <a
		href="#i18n.other.i18n_portlet_config">configured your <code>i18n_portlet_config.properties</code></a>
	with the locations of the portlet bundle folder and the relay servlet,
	if you are not using the defaults. See the previous discussion in this
	document.</p>
	</dd>

	<dt><a
		href="com/hp/it/spf/xa/interpolate/portlet/FileInterpolator.html#localized-content-url"><code>{LOCALIZED-CONTENT-URL:<i>pathname</i>}</code></a></dt>
	<dd>
	<p>Use this token to insert a URL for an <b>possibly localized</b>
	supporting resource file into the interpolated content. The file can be
	an <a href="#i18n.location">external or internal</a> <a
		href="#i18n.resources.supporting">supporting resource</a>, of any file
	type (for example, an image). If it is external, you will get a URL for
	the <i>file relay servlet</i>; if it is internal, you will get a static
	resource URL for your portlet application. In either case, the URL will
	be properly portlet-encoded for presentation to the user.</p>

	<p>The <code><i>pathname</i></code> in the token should give the
	base name of the <a href="#i18n.resources.bundles">resource bundle</a>
	containing the desired file. This name should include any subfolder(s)
	where the bundle files are located, relative to the <i>portlet
	resource bundle folder</i> (for an external resource) or the portlet WAR
	root (for an internal resource). The token will find the best-fit
	localized file in that bundle for the user's current locale, and
	include that filename in the expressed URL.</p>

	<p>Here is some example HTML text using this token to help build an
	HTML &lt;IMG&gt; tag:</p>

	<blockquote><pre>
&lt;IMG SRC="{LOCALIZED-CONTENT-URL:/images/picture.jpg}"&gt;
</pre></blockquote>

	<p><b>Note:</b> If you are placing your resource files outside of
	the WAR, you must have <a href="#i18n.supporting.relay">configured
	and deployed</a> the relay servlet accordingly. You also must have <a
		href="#i18n.other.i18n_portlet_config">configured your <code>i18n_portlet_config.properties</code></a>
	with the locations of the portlet bundle folder and the relay servlet,
	if you are not using the defaults. See the previous discussion in this
	document.</p>
	</dd>

	<dt><a
		href="com/hp/it/spf/xa/interpolate/portlet/FileInterpolator.html#request-url"><code>{REQUEST-URL}</code></a></dt>
	<dd>
	<p>Use this token to insert the current portal request URL into the
	interpolated content. This is a reconstruction of the URL which, if
	opened by the browser, would re-request the current portal page and
	portlet (including any form arguments). (The URL is for the current
	scheme; if you need to switch the scheme, see the next token.) Here is
	some sample HTML text, using this token to help build a hidden form
	input element containing the request URL as a return URL for the form
	handler:</p>

	<blockquote><pre>
&lt;INPUT TYPE="hidden" NAME="returnURL" VALUE="{REQUEST-URL}"&gt;
</pre></blockquote>
	</dd>

	<dt><a
		href="com/hp/it/spf/xa/interpolate/portlet/FileInterpolator.html#site-url_p"><code>{REQUEST-URL:<i>spec</i>}</code></a></dt>
	<dd>
	<p>Use this token to insert the current portal request URL into the
	interpolated content. Like the above token, this is a reconstruction of
	the URL which, if opened by the browser, would re-request the current
	portal page and portlet (including any form arguments). With this
	token, you can provide a <code><i>spec</i></code> to switch the scheme
	or port. The format of the <code><i>spec</i></code> is as follows:</p>

	<blockquote><pre>
<i>scheme</i>:<i>port</i>	
	</pre></blockquote>

	<p>Each element is optional.</p>
	<ul>
		<li>
		<p>You can specify a <code><i>scheme</i></code>, either <code>http</code>
		or <code>https</code>. By default the scheme of the current request is
		assumed.
		</li>
		<li>
		<p>You can provide a <code><i>port</i></code>. By default the port
		from the current request is assumed.
		</li>
	</ul>

	<p>Here is some sample HTML text, using this token to help build a
	hidden form input element containing the request URL as a return URL
	for the form handler. The request URL scheme has been forced to HTTPS:</p>

	<blockquote><pre>
&lt;INPUT TYPE="hidden" NAME="returnURL" VALUE="{REQUEST-URL:https}"&gt;
</pre></blockquote>
	</dd>

	<dt><a
		href="com/hp/it/spf/xa/interpolate/portlet/FileInterpolator.html#site-url"><code>{SITE-URL}</code></a></dt>
	<dd>
	<p>Use this token to insert the portal home page URL into the
	interpolated content. (The URL is for the current scheme; if you need
	to switch the scheme, see the next token.) Here is some sample HTML
	text, using this token to help build a hyperlink pointing to the home
	page:</p>

	<blockquote><pre>
Click &lt;A HREF="{SITE-URL}"&gt;here&lt;/A&gt; to go to the home page.
</pre></blockquote>
	</dd>

	<dt><a
		href="com/hp/it/spf/xa/interpolate/portlet/FileInterpolator.html#site-url_p"><code>{SITE-URL:<i>spec</i>}</code></a></dt>
	<dd>
	<p>Use this token to insert a URL pointing to any page in the
	portal site, by the site-relative URI for that page. You can also
	adjust the URL scheme (<code>http</code> or <code>https</code>) and
	port number with this token. The format of the <code><i>spec</i></code>
	is as follows:</p>

	<blockquote><pre>
<i>scheme</i>:<i>port</i>;<i>uri</i>	
	</pre></blockquote>

	<p>Each element is optional.</p>
	<ul>
		<li>
		<p>You can specify a <code><i>scheme</i></code>, either <code>http</code>
		or <code>https</code>. By default the scheme of the current request is
		assumed. When you don't provide a scheme or port, you don't need the <code>:</code>
		or <code>;</code> characters.</p>
		</li>
		<li>
		<p>You can provide a <code><i>port</i></code>. By default the port
		from the current request is assumed. When you don't provide a scheme
		or port, you don't need the <code>:</code> or <code>;</code>
		characters.</p>
		</li>
		<li>
		<p>You can provide a <code><i>uri</i></code>, which you use to
		indicate the page and/or portal site you wish to target with this URL.
		For example, your <code><i>uri</i></code> could be a Vignette
		"friendly URI" for the desired page. It could be a template name, for
		a secondary page. Your <code><i>uri</i></code> can also include any
		additional path or query string you might need. You can also use the <code><i>uri</i></code>
		to switch to another portal site: if your <code><i>uri</i></code>
		begins with <code>/</code>, it is considered relative to the current
		site, but otherwise the first part of the <code><i>uri</i></code> is
		considered to be the new "site DNS name" to use.</p>
		</li>
	</ul>

	<p>Here is some sample HTML text, using this token to help build a
	hyperlink pointing to the current site's Forums page (which in this
	example has a "friendly URI" of <code>/forums</code>):</p>

	<blockquote><pre>
Click &lt;A HREF="{SITE-URL:/forums}"&gt;here&lt;/A&gt; to go to the Forums.
</pre></blockquote>

	<p>To repeat the above example, but switch to the <code>itrc</code>
	site as well, use <code>{SITE-URL:itrc/forums}</code> instead.</p>

	<p>To repeat both of those examples, and force use of HTTPS in the
	URL, use {SITE-URL:https;/forums}<code>{SITE-URL:https;itrc/forums}</code>
	instead.</p>

	<p>To force use of HTTPS but otherwise generate just a home page
	URL for the current portal site (ie like <code>{SITE-URL}</code>
	without any parameters does), use <code>{SITE-URL:https;}</code>.</p>
	</dd>
</dl>

<a name="file.author.token.user">
<h4>4.5.2. Displaying user information (<code>{NAME}</code>, <code>{EMAIL}</code>,
<code>{LANGUAGE-CODE}</code>, <code>{LANGUAGE-CODE<i>case</i>}</code>, <code>{COUNTRY-CODE}</code>,
<code>{COUNTRY-CODE:<i>case</i>}</code>, <code>{LANGUAGE-TAG}</code>, <code>{LANGUAGE-TAG:<i>case</i>}</code>,
<code>{HPP-LANGUAGE-CODE}</code>, <code>{HPP-LANGUAGE-CODE:<i>case</i>}</code>,
<code>{USER-PROPERTY:<i>key</i>}</code>)</h4>
</a>

<p>The following tokens can be used to interpolate information about
the user into your text. Please click on the links for more
documentation for each token.</p>

<dl>
	<dt><a
		href="com/hp/it/spf/xa/interpolate/portlet/FileInterpolator.html#country-code"><code>{COUNTRY-CODE}</code></a></dt>
	<dt><a
		href="com/hp/it/spf/xa/interpolate/portlet/FileInterpolator.html#country-code"><code>{COUNTRY-CODE:<i>case</i>}</code></a></dt>
	<dd>
	<p>Use either of these tokens to insert the <a
		href="http://www.iso.org/iso/country_codes/iso_3166_code_lists/english_country_names_and_code_elements.htm">ISO
	3166-1</a> country code for the current user into the interpolated content.
	By default the inserted country code is uppercase; you can force the
	case using <code><i>lower</i></code> or <code><i>upper</i></code>
	accordingly. If the user's locale is not a country-specific locale (eg
	is simply French instead of France French, for example), then blank
	will be substituted. Here is some sample HTML text, using this token to
	help build a URL pointing to the another HP Web site, passing the
	country (and language) codes in the URL as per the <a
		href="https://h10014.www1.hp.com/hpweb/buildguide/locale_codes.html">HP.com
	standards</a>:</p>

	<blockquote><pre>
&lt;A HREF="http://other.hp.com/path?lang={LANGUAGE-CODE}&cc={COUNTRY-CODE}"&gt;...&lt;/A&gt;
</pre></blockquote>
	</dd>

	<dt><a
		href="com/hp/it/spf/xa/interpolate/portlet/FileInterpolator.html#email"><code>{EMAIL}</code></a></dt>
	<dd>
	<p>Use this token to insert the email address for the user into the
	interpolated content. The email is taken from the SPF-generated <i>user
	profile map</i>. An email address is only available when the user is
	logged-in; when the email is not available, blank will be substituted.
	For example:</p>
	<blockquote><pre>
The email address we have on record for you is: {EMAIL}
	</pre></blockquote>
	<p>(This is best used when wrapped inside the <code>{LOGGED-IN}</code>
	container token - <a href="#file.author.token.auth">see below</a>.)</p>
	</dd>

	<dt><a
		href="com/hp/it/spf/xa/interpolate/portlet/FileInterpolator.html#hpp-language-code"><code>{HPP-LANGUAGE-CODE}</code></a></dt>
	<dt><a
		href="com/hp/it/spf/xa/interpolate/portlet/FileInterpolator.html#hpp-language-code"><code>{HPP-LANGUAGE-CODE:<i>case</i>}</code></a></dt>
	<dd>
	<p>Use this token to insert the HP Passport standard language code
	for the current user into the interpolated content. Note that HP
	Passport does not exactly conform to the ISO 639-1 standard, which is
	why this token is provided; to work with HP Passport in all languages,
	your content must use this token instead of <code>{LANGUAGE-CODE}</code>.
	By default the inserted HPP language code is lowercase; you can force
	the case using <code><i>lower</i></code> or <code><i>upper</i></code>
	accordingly. Here is some sample HTML text, using this token to help
	build a URL pointing to an HP Passport login page, passing the language
	in the query string:</p>

	<blockquote><pre>
&lt;A HREF="https://passport2.hp.com/hppcf/login.do?lang={HPP-LANGUAGE-CODE}"&gt;...&lt;/A&gt;
</pre></blockquote>
	</dd>


	<dt><a
		href="com/hp/it/spf/xa/interpolate/portlet/FileInterpolator.html#language-code"><code>{LANGUAGE-CODE}</code></a></dt>
	<dt><a
		href="com/hp/it/spf/xa/interpolate/portlet/FileInterpolator.html#language-code"><code>{LANGUAGE-CODE:<i>case</i>}</code></a></dt>
	<dd>
	<p>Use this token to insert the <a
		href="http://www.loc.gov/standards/iso639-2/php/English_list.php">ISO
	639-1</a> language code for the current user into the interpolated content.
	By default the inserted language code is lowercase; you can force the
	case using <code><i>lower</i></code> or <code><i>upper</i></code>
	accordingly. Here is some sample HTML text, using this token to help
	build a URL pointing to the another HP Web site, passing the language
	(and country) codes in the URL as per the <a
		href="https://h10014.www1.hp.com/hpweb/buildguide/locale_codes.html">HP.com
	standards</a>:</p>

	<blockquote><pre>
&lt;A HREF="http://other.hp.com/path?lang={LANGUAGE-CODE}&cc={COUNTRY-CODE}"&gt;...&lt;/A&gt;
</pre></blockquote>

	<p><b>Note:</b> HP Passport does not fully conform to the ISO 639-1
	standard. To work with HP Passport in all languages, use the <code>{HPP-LANGUAGE-CODE}</code>
	token instead.</p>
	</dd>

	<dt><a
		href="com/hp/it/spf/xa/interpolate/portlet/FileInterpolator.html#language-tag"><code>{LANGUAGE-TAG}</code></a></dt>
	<dt><a
		href="com/hp/it/spf/xa/interpolator/portlet/FileInterpolator.html#language-tag"><code>{LANGUAGE-TAG:<i>case</i>}</code></a></dt>
	<dd>
	<p>Use this token to insert the <a
		href="http://www.faqs.org/rfcs/rfc3066.html">RFC 3066</a> language tag
	for the current user into the interpolated content. For a user with a
	country-specific locale, this will be a full language-country value (eg
	<code>es-MX</code> for Spanish in Mexico). For a user with a generic
	locale (ie no country indicated), this will be just the language code
	(eg <code>es</code> for generic Spanish). By default the inserted
	language tag uses mixed case (uppercase for country and lowercase for
	language). You can force the case to all-lowercase or all-uppercase,
	using <code><i>lower</i></code> or <code><i>upper</i></code>
	accordingly. Here is some sample HTML text, using this token to help
	build a URL pointing to the another HP Web site, passing the language
	tag:</p>

	<blockquote><pre>
&lt;A HREF="http://other.hp.com/path?lang={LANGUAGE-TAG}"&gt;...&lt;/A&gt;
</pre></blockquote>
	</dd>

	<dt><a
		href="com/hp/it/spf/xa/interpolate/portlet/FileInterpolator.html#name"><code>{NAME}</code></a></dt>
	<dd>
	<p>Use this token to insert the full name (both given and family
	names) for the user into the interpolated content. The given and family
	names are taken from the SPF-generated <i>user profile map</i>. The
	name is inserted in the customary order for the user's current locale:
	family-name-first in certain East Asian locales (eg <code>Smith
	Bob</code>) and the Western custom of given-name-first otherwise (eg <code>Bob
	Smith</code>). The name is only available when the user is logged-in; when the
	name is not available, blank will be substituted. For example:</p>
	<blockquote><pre>
Welcome, {NAME}!
	</pre></blockquote>
	<p>(This is best used when wrapped inside the <code>{LOGGED-IN}</code>
	container token - <a href="#file.author.token.auth">see below</a>. The
	display order is based on the configuration in the SPF common
	utilities' <code>i18n_config.properties</code> file; this is an
	internal file in the <a href="#overview.other.spf.common">SPF
	common utilities</a> JAR which you should not need to change.)</p>
	</dd>

	<dt><a
		href="com/hp/it/spf/xa/interpolate/portlet/FileInterpolator.html#user-property"><code>{USER-PROPERTY:<i>key</i>}</code></a></dt>
	<dd>
	<p>Use this token to insert any property in the SPF-generated <i>user
	profile map</i> for the user into the interpolated content. The <code><i>key</i></code>
	is the name of the property, as you would pass it to the SPF portlet
	utilities' <a href="#portal.user.props"><code>Utils.getUserProperty</code></a>
	method (see).</p>
	<p>These user properties include core user-identity attributes from
	HP Passport or HP Enterprise Directory, as well as extended attributes
	defined by Persona or UPS. The extended attributes are not part of the
	SPF framework and so are not listed here. For a list of the core
	user-identity attributes, see the documentation for <a
		href="#portal.user.props"><code>Utils.getUserProperty</code></a>
	below. Basically, all of the class constants in {@link
	com.hp.it.spf.xa.misc.portal.Consts} which start with <code>KEY_*</code>
	- except for those starting with <code>KEY_PORTAL_*</code> - are
	keynames for the core user-identity attributes.</p>

	<blockquote>
	<p><b>Note:</b> In the <code><i>key</i></code> for the <code>{USER-PROPERTY:<i>key</i>}</code>
	token, you must use the literal property name - you cannot use a Java
	constant/variable name for it.</p>
	</blockquote>

	<p>For example, from {@link
	com.hp.it.spf.xa.misc.portal.Consts#KEY_PHONE_NUMBER} we see that the
	value of this user property key is <code>PhoneNumber</code>. So we can
	reference the phone number in our interpolated text as follows:</p>
	<blockquote><pre>
The phone number we have on record for you is: {USER-PROPERTY:PhoneNumber}
	</pre></blockquote>
	<p>(When the user is not logged-in, the user properties are set to
	generic or blank values, depending on the particular property. So this
	token is probably best used when wrapped inside the <code>{LOGGED-IN}</code>
	container token - <a href="#file.author.token.auth">see below</a>.)</p>
	<p></p>
	</dd>

</dl>

<a name="file.author.token.auth">
<h4>4.5.3. Permissioning content for authorized users (<code>{LOGGED-IN}</code>,
<code>{LOGGED-OUT}</code>, <code>{ROLE:<i>role-names</i>}</code>, <code>{GROUP:<i>group-names</i>}</code>)</h4>
</a>

<p>The following tokens may be used to permission content against
the user. With these tokens, you specify various conditions the user
must satisfy in order for the content to pass-through the interpolation.
If the user does not safisfy the various conditions, the content is
removed during interpolation. Please click on the links for more
documentation for each token.</p>

<blockquote>
<p><b>Note:</b> The SPF lets you "nest" container tokens. Nested
containers form a "logical-AND" between their respective conditions. So,
for example, <code>{LOGGED-IN}{ROLE:abc}{ROLE:xyz}...{/ROLE}{/ROLE}{/LOGGED-IN}</code>
means the user must be logged-in <b>and</b> must be in roles <code>abc</code>
<b>and</b> <code>xyz</code> in order to see the <code>...</code> wrapped
content.
</blockquote>

<dl>
	<dt><a
		href="com/hp/it/spf/xa/interpolate/portlet/FileInterpolator.html#group"><code>{GROUP:<i>groups</i>}...{/GROUP}</code></a></dt>
	<dd>
	<p>Use this container token to permission the content inside the
	container based on the user's current set of groups. Use the <code><i>groups</i></code>
	parameter to list the names of the group(s) for which the wrapped
	content is permissioned. The user must be a member of at least one of
	the <code><i>groups</i></code> in order for the wrapped content to be
	included in the output. Group names are case-insensitive and are
	delimited with the <code>|</code> character. For example:</p>

	<blockquote><pre>
This text is for everybody.&lt;BR&gt;
{GROUP:abc|xyz}This text is only for members of the "abc" or "xyz" groups.{/GROUP}
	</pre></blockquote>

	<p>The actual group names will vary by application, over time, and
	according to the mappings which initially derive them. UGS, as the
	external grouping provider for SPF, will let application teams define
	their needed groups. The SPF framework does define and provide a few
	core groups - see the list in the discussion about <a
		href="#portal.user.groups"><code>Utils.getGroups</code></a>, below.</p>

	<blockquote>
	<p><b>Note:</b> In the <code><i>groups</i></code> for the <code>{GROUP:<i>groups</i>}</code>
	token, you must use the literal group name - you cannot use the Java
	constant/variable name for it.</p>
	</blockquote>

	<p><b>Background:</b> The SPF has 2 related concepts for
	authorization: groups and roles. Groups are portal-level constructs and
	are not JSR portlet standard; roles are portlet-level constructs which
	are JSR-standard. The SPF portal both forwards the user's groups as
	part of the {@link javax.portlet.PortletRequest}, and maps the groups
	into roles which are likewise part of the <code>PortletRequest</code>.
	The group-to-role mapping is specified when provisioning the portlet
	inside the portal. In SPF, groups themselves are generally mapped from
	other characteristics, either in the portal itself, or in UGS. Both
	groups and roles can exist apart from authentication; ie anonymous
	users can still be in groups/roles. This SPF authorization design is
	documented elsewhere.</p>
	</dd>

	<dt><a
		href="com/hp/it/spf/xa/interpolate/portlet/FileInterpolator.html#logged-in"><code>{LOGGED-IN}...{/LOGGED-IN}</code></a></dt>
	<dt><a
		href="com/hp/it/spf/xa/interpolate/portlet/FileInterpolator.html#logged-out"><code>{LOGGED-OUT}...{/LOGGED-OUT}</code></a></dt>
	<dd>
	<p>Use these container tokens to permission the content inside the
	container based on the user's current authentication status. The <code>{LOGGED-IN}...{/LOGGED-IN}</code>
	token will cause the wrapped content to be <b>included</b> in the
	interpolated content if the user is logged-in, and <b>omitted</b> if
	the user is not logged-in. The <code>{LOGGED-OUT}...{/LOGGED-OUT}</code>
	token will do the opposite. Here is some example HTML text using these
	tokens:</p>
	<blockquote><pre>
This text is for everybody.&lt;BR&gt;
{LOGGED-IN}This text is for logged-in users only.{/LOGGED-IN}
{LOGGED-OUT}This text is for logged-out users only.{/LOGGED-OUT}
	</pre></blockquote>
	</dd>

	<dt><a
		href="com/hp/it/spf/xa/interpolate/portlet/FileInterpolator.html#role"><code>{ROLE:<i>roles</i>}...{/ROLE}</code></a></dt>
	<dd>
	<p>Use this container token to permission the content inside the
	container based on the user's current roles. Use the <code><i>roles</i></code>
	parameter to list the names of the role(s) for which the wrapped
	content is permissioned. The user must be a member of at least one of
	the <code><i>roles</i></code> in order for the wrapped content to be
	included in the output. Role names are case-insensitive and are
	delimited with the <code>|</code> character. For example:</p>

	<blockquote><pre>
This text is for everybody.&lt;BR&gt;
{ROLE:abc|xyz}This text is only for users in the "abc" or "xyz" roles.{/ROLE}
	</pre></blockquote>

	<p>The actual role names will vary by application, over time, and
	according to the mappings which initially derive them in the portal
	from the groups. They are not documented here.</p>

	<p><b>Background:</b> For basic information about groups and roles,
	see the discussion for the <code>{GROUP:<i>groups</i>}</code> token
	above. Remember that even if the portal has mapped groups into roles,
	your portlet will not see those roles unless you have defined them in
	your application descriptors, per the JSR specification for <i>programmatic
	security</i>. At minimum:</p>

	<ol>
		<li>
		<p>You need to define your role names in your portlet
		application's <code>web.xml</code>, like this for the role named <code>abc</code>:</p>

		<blockquote><pre>
&lt;security-role&gt;
    &lt;role-name&gt;abc&lt;/role-name&gt;
&lt;/security-role&gt;
	</pre></blockquote>
		</li>
		<li>
		<p>And you need to reference those roles from your portlet
		application's <code>portlet.xml</code>, like this:</p>
		<blockquote><pre>
&lt;security-role-ref&gt;
    &lt;role-name&gt;abc&lt;/role-name&gt;
&lt;/security-role-ref&gt;
	</pre></blockquote>
		</li>
	</ol>

	<p>(You can additionally define optional <code>&lt;role-link&gt;</code>
	elements in <code>portlet.xml</code>, to introduce a level of
	indirection which lets the role names in <code>web.xml</code> and <code>portlet.xml</code>
	be different. Please see the JSR portlet specification for more
	information.)</p>
	</dd>

</dl>

<a name="file.author.token.consolidate">
<h4>4.5.4. Consolidating content for easier administration (<code>{PORTLET:<i>friendly-ids</i>}</code>,
<code>{PAGE:<i>friendly-ids</i>}</code>, <code>{SITE:<i>site-names</i>}</code>,
<code>{INCLUDE:<i>key</i>}</code>)</h4>
</a>

<p>The following tokens may be used to consolidate content, either
to reduce the number of files storing content for different portlets or
portal sites, or to provide referential integrity for content shared
between multiple files. Please click on the links for more documentation
for each token.</p>

<blockquote>
<p><b>Note:</b> The SPF lets you "nest" container tokens. Nested
containers form a "logical-AND" between their respective conditions. So,
for example, <code>{PORTLET:forums}{SITE:itrc}...{/SITE}{/PORTLET}</code>
means the current request must be for the <code>forums</code> portlet
instance in the portal site named <code>itrc</code>, in order to get the
<code>...</code> wrapped content.
</blockquote>

<dl>
	<dt><a
		href="com/hp/it/spf/xa/interpolate/portlet/FileInterpolator.html#token"><code>{INCLUDE:<i>key</i>}</code></a></dt>
	<dd>
	<p>Use this token to consolidate shared content into a separate
	properties file, and then include it into the interpolated content.
	First, you create a token substitutions property file with a simple
	key-value format:</p>

	<blockquote><pre>
<i>key</i>=<i>value</i>
</pre></blockquote>

	<p>Then you reference the <code><i>key</i></code> in your <code>{INCLUDE:<i>key</i>}</code>
	token. The interpolation engine substitutes the <code><i>value</i></code>
	from the properties file into your interpolated content. For example,
	assume you have the following in your property file:</p>

	<blockquote><pre>
url.hp=http://www.hp.com
	</pre></blockquote>

	<p>Then you can substitute <code>http://www.hp.com</code> into the
	content like this:</p>

	<blockquote><pre>
&lt;A HREF="{INCLUDE:url.hp}"&gt;Go to HP home page&lt;/A&gt;
	</pre></blockquote>

	<p>Your substitution property <code><i>value</i></code> can contain
	any content valid in a Java {@link java.util.Properties} file. It can
	even contain any of the other special markup tokens described in this
	guide (however it cannot contain other <code>{INCLUDE:<i>key</i>}</code>
	tokens).</p>

	<p>Your token substitutions property file may be located anywhere
	accessible to the system classloader. For example, if you are using
	SASU, you can put it in the "global resources" external folder
	configured on the JVM classpath. (Of course, you can always put it
	inside your portlet WAR, in <code>/WEB-INF/classes</code>.)</p>

	<p>Alternatively, the file may be treated as an <a
		href="#i18n.location">internal or external resource</a> and
	accordingly stored anywhere inside your portlet WAR or underneath the
	portlet resource bundle folder.</p>

	<p>The name of the token substitutions property file is assumed by
	the interpolator to be <code>default_includes.properties</code>, and it
	is assumed to not be stored in a subfolder, unless otherwise specified.
	You can specify a different name (and/or any subfolders relative to the
	location where you put it - see previous paragraphs) in different ways,
	depending on how you invoke the interpolator:</p>

	<ul>
		<li>If you invoke <a href="#file.display.java.tokenParser"><code>TokenParser</code></a>
		to interpolate from a string, you pass the token substitutions
		filename to the constructor.</li>
		<li>If you invoke <a href="#file.display.java.fileInterpolator"><code>FileInterpolator</code></a>
		to interpolate from a file, you also pass the filename to the
		constructor.</li>
		<li>If you use <a
			href="#file.display.java.fileInterpolatorController"><code>FileInterpolatorController</code></a>,
		you set the {@link
		com.hp.it.spf.xa.interpolate.portlet.web.FileInterpolatorController#includeFileName}
		class attribute.</li>
		<li>If you use the <a href="#file.display.jsp.interpolate"><code>&lt;spf-file-portlet:interpolate&gt;</code></a>
		JSP tag, set use the <code>includeFile</code> tag attribute.</li>
		<li>If you use the <a href="#file.display.htmlViewer"><code>htmlviewer</code></a>
		portlet, the file is assumed to be named <code>html_viewer_includes.properties</code>
		by default, but the portal administrator can override that when
		configuring the portlet instance. (The portlet's <code>config</code>
		mode lets the administrator enter an alternate token substitutions
		filename.)</li>
	</ul>

	<p>A template for the token substitutions file, also named <code>default_includes.properties</code>,
	is provided. You download it, then modify and rename it as needed, and
	ship it with your application.</p>

	<p>To get the <code>default_includes.properties</code> template,
	download the <code>spf-portlet-config.jar</code>. Download the latest
	version of this JAR (typically a version number is affixed to the JAR
	filename) and extract the <code>default_includes.properties</code>
	template file from it.</p>

	<p>You can get the latest <code>spf-portlet-config.jar</code> from
	the SPF team on their Maven 2 repository, here: <a
		href="http://samson.atl.hp.com:8081/nexus/content/groups/public/com/hp/it/spf/xa/spf-portlet-config">http://samson.atl.hp.com:8081/nexus/content/groups/public/com/hp/it/spf/xa/spf-portlet-config/</a>
	(browse for the latest version).</p>
	</dd>

	<dt><a
		href="com/hp/it/spf/xa/interpolate/portlet/FileInterpolator.html#page"><code>{PAGE:<i>pages</i>}...{/PAGE}</code></a></dt>
	<dd>
	<p>Use this container token to put content for multiple portal
	pages into the same uninterpolated content string (or file). When it is
	interpolated, only the section for the current portal page will be
	included.</p>

	<p>The <code><i>pages</i></code> parameter lists the page ID <i>substrings</i>
	for the pages that should use the wrapped content. The page ID for the
	current portal page must <i>contain</i> (case-insensitive) at least one
	of the listed page ID's. Use the <code>|</code> character to delimit
	multiple page ID's in the <code><i>pages</i></code> parameter. (In the
	SPF portal, the page ID is the Vignette <i>friendly ID</i> assigned to
	the page by the administrator. The SPF transmits this to the portlet
	where it can be accessed.)</p>

	<p>For example:</p>
	<blockquote><pre>
This text is for everybody.&lt;BR&gt;
{PAGE:abc|def}This text is only for the "abc" or "def" pages.{/PAGE}
{PAGE:xyz}This text is only for the "xyz" page.{/PAGE}
</pre></blockquote>

	<p>The actual page ID's will vary; they are setup by the
	administrator. They are not listed here.</p>
	</dd>

	<dt><a
		href="com/hp/it/spf/xa/interpolate/portlet/FileInterpolator.html#portlet"><code>{PORTLET:<i>portlets</i>}...{/PORTLET}</code></a></dt>
	<dd>
	<p>Use this container token to put content for multiple instances
	of one (or more) portlets into the same uninterpolated content string
	(eg file). When it is interpolated, only the section for the current
	portlet will be included.</p>

	<p>The <code><i>portlets</i></code> parameter lists the portlet ID
	<i>substrings</i> for the portlet instances that should get the wrapped
	content. The portlet ID for the current portlet instance must <i>contain</i>
	(case-insensitive) at least one of the listed portlet ID's. Use the <code>|</code>
	character to delimit multiple portlet ID's in the <code><i>portlets</i></code>
	parameter. (In the SPF portal, the portlet ID is the Vignette <i>friendly
	ID</i> assigned to the portlet instance when the administrator provisions
	the portlet on a portal page. The SPF transmits this to the portlet
	where it can be accessed.)</p>

	<p>For example:</p>
	<blockquote><pre>
This text is for everybody.&lt;BR&gt;
{PORTLET:abc|def}This text is only for the "abc" or "def" portlets.{/PORTLET}
{PORTLET:xyz}This text is only for the "xyz" portlet.{/PORTLET}
</pre></blockquote>

	<p>The actual portlet ID's will vary by portal and portlet
	instance; they are setup by the administrator. They are not listed
	here.</p>
	</dd>

	<dt><a
		href="com/hp/it/spf/xa/interpolate/portlet/FileInterpolator.html#site"><code>{SITE:<i>sites</i>}...{/SITE}</code></a></dt>
	<dd>
	<p>Use this container token to put content for multiple portal
	sites into the same uninterpolated content string (eg file). When it is
	interpolated, only the section for the current portal site will be
	included.</p>

	<p>The <code><i>sites</i></code> parameter lists the <i>site
	name(s)</i> of the portal site(s) which should get the wrapped content. The
	site name for the current portlet must match (case-insensitive) at
	least one of the listed site names. Use the <code>|</code> character to
	delimit multiple site names in the <code><i>sites</i></code> parameter.
	(In the SPF portal, the site name is the Vignette "site DNS name"
	assigned to the portal site when it is created by the administrator.
	The SPF transmits this to the portlet where it can be accessed.)</p>

	<p>For example:</p>
	<blockquote><pre>
This text is for everybody.&lt;BR&gt;
{SITE:abc|def}This text is only for portlets in the the "abc" or "def" portal sites.{/SITE}
{SITE:xyz}This text is only for portlets in the "xyz" portal site.{/SITE}
</pre></blockquote>

	<p>The actual site names will vary by portal site; they are setup
	by the administrator. They are not listed here.</p>
	</dd>
</dl>

<a name="file.author.token.misc">
<h4>4.5.5. Miscellaneous (<code>{AFTER:<i>date</i>}</code>, <code>{BEFORE:<i>date</i>}</code>,
<code>{SITE-NAME}</code>, <code>{URL-ENCODE:<i>string</i>}</code>)</h4>
</a>

<p>These are miscellaneous tokens. Please click on the links for
more documentation on each token.</p>

<dl>
	<dt><a
		href="com/hp/it/spf/xa/interpolate/portlet/FileInterpolator.html#after"><code>{AFTER:<i>date</i>}...{/AFTER}</code></a></dt>
	<dt><a
		href="com/hp/it/spf/xa/interpolate/portlet/FileInterpolator.html#before"><code>{BEFORE:<i>date</i>}...{/BEFORE}</code></a></dt>
	<dd>
	<p>Use these container tokens to restrict content inside the
	container based on the current date and time. The <code>{AFTER:<i>date</i>}...{/AFTER}</code>
	token will cause the wrapped content to be <b>included</b> in the
	interpolated content beginning on the particular <code><i>date</i></code>.
	The <code>{BEFORE:<i>date</i>}...{/BEFORE}</code> token is the
	opposite: the content will be included only until the particular <code><i>date</i></code>.
	You can nest these tokens to mark content with a beginning and end
	date.</p>
	<p>The format of the <code><i>date</i></code> parameter is as
	follows:</p>

	<p><code><i>M</i>/<i>d</i>/<i>yyyy</i> <i>h</i>:<i>mm</i>:<i>ss</i>
	<i>a</i> <i>z</i></code></p>

	<ul>
		<li><code><i>M</i></code> is a one or two-digit month</li>
		<li><code><i>d</i></code> is a one or two-digit day of month</li>
		<li><code><i>yyyy</i></code> is a four-digit year</li>
		<li><code><i>h</i></code> is a one or two-digit hour (12 hour
		clock)</li>
		<li><code><i>mm</i></code> is a two-digit minutes</li>
		<li><code><i>ss</i></code> is a two-digit seconds</li>
		<li><code><i>a</i></code> is <code>AM</code> or <code>PM</code></li>
		<li><code><i>z</i></code> is the timezone such as <code>GMT</code>
		for Greenwich Mean Time, <code>PST</code> for Pacific Standard Time, <code>GMT-05:00</code>
		for 5 hours behind GMT, etc.</li>
	</ul>

	<p>The tokens are very picky about this format. If they do not
	recognize your <code><i>date</i></code>, they will err on the side of
	displaying the wrapped content.</p>

	<p>For example:</p>

	<blockquote><pre>
This text is permanent.&lt;BR&gt;
{AFTER:2/1/2009 12:00:00 AM GMT}
  {BEFORE:3/1/2009 12:00:00 AM GMT}
  This text is only for the month of February 2009 (as measured by Greenwich Mean Time).
  {/BEFORE}
{/AFTER}
</pre></blockquote>
	</dd>

	<dt><a
		href="com/hp/it/spf/xa/interpolate/portlet/FileInterpolator.html#site-name"><code>{SITE-NAME}</code></a></dt>
	<dd>
	<p>Use this token to insert the portal site name into the
	interpolated content. In SPF, the portal site name is the Vignette
	"site DNS name", which the portal administrator assigns when creating
	the site. It is the part of the portal URL which uniquely identifies
	the portal site: <code>http://host.hp.com/portal/site/&lt;site-DNS-name&gt;/...</code>.
	Here is some sample HTML text, using this token (as well as the <code>{SITE-URL:<i>key</i>}</code>
	token) to present a logout hyperlink (in SPF, the logout process runs
	in the <code>spf</code> portal site, uses the Vignette secondary page
	whose template ID is <code>SPF_LOGOUT</code>, and expects the effective
	site DNS name to be in the <code>spfSite</code> query parameter):</p>

	<blockquote><pre>
&lt;A HREF="{SITE-URL:spf/template.SPF_LOGOUT?spfSite={SITE-NAME}}"&gt;Sign out&lt;/A&gt;
</pre></blockquote>

	<p>(Incidentally, notice from this example how <code>{SITE-NAME}</code>
	is nested inside the <code><i>uri</i></code> parameter for <code>{SITE-URL:<i>uri</i>}</code>.
	In general, any of the tokens can be used inside the parameter-values
	for any of the tokens.)</p>
	</dd>

	<dt><a
		href="com/hp/it/spf/xa/interpolate/portlet/FileInterpolator.html#url-encode"><code>{URL-ENCODE:<i>string</i>}</code></a></dt>
	<dd>
	<p>Use this token to insert a <code><i>string</i></code>,
	URL-encoded, into the interpolated content. For example:</p>

	<blockquote><pre>
&lt;A HREF="https://passport2.hp.com/hppcf/modifyuser.do?applandingpage={URL-ENCODE:{REQUEST-URL}}"&gt;
	</pre></blockquote>

	<p>This inserts the current request URL, properly encoded, into the
	query string of that hyperlink.</p>
	</dd>
</dl>

<hr>

<a name="portal">
<h2>5. Portal Data</h2>
</a>

<p>The Shared Portal Framework provides portlets with access to data
from the SPF portal, including user data and portal request data. This
chapter describes how to access these elements.</p>

<hr>

<a name="portal.kinds">
<h3>5.1. Kinds of portal provided data</h3>
</a>

<p>Following are the kinds of data which the SPF portal forwards to
the portlet.</p>

<blockquote>
<p><b>Important:</b> You must have configured the SPF {@link
com.hp.it.spf.sso.portlet.filter.MapAttributeFilter} as a filter for
your portlet, for any of this data to be visible to you. Here is how you
configure the filter, in your <code>portlet.xml</code>:</p>

<blockquote><pre>
&lt;filter&gt;
    &lt;display-name&gt;SPF Map Attribute Filter&lt;/display-name&gt; 
    &lt;filter-name&gt;MapAttributeFilter&lt;/filter-name&gt; 
    &lt;filter-class&gt;com.hp.it.spf.sso.portlet.filter.MapAttributeFilter&lt;/filter-class&gt; 
    &lt;lifecycle&gt;ACTION_PHASE&lt;/lifecycle&gt;      &lt;-- to get portal data during action phase
    &lt;lifecycle&gt;RENDER_PHASE&lt;/lifecycle&gt;      &lt;-- to get portal data during render phase
    &lt;lifecycle&gt;RESOURCE_PHASE&lt;/lifecycle&gt;    &lt;-- to get portal data during resource phase
    &lt;lifecycle&gt;EVENT_PHASE&lt;/lifecycle&gt;       &lt;-- to get portal data during event phase
&lt;/filter&gt;
&lt;filter-mapping&gt;
    &lt;filter-name&gt;MapAttributeFilter&lt;/filter-name&gt; 
    &lt;portlet-name&gt;*&lt;/portlet-name&gt; 
&lt;/filter-mapping&gt;
</pre></blockquote>

<p>The <code>MapAttributeFilter</code> is part of the <code>spf-portlet-filters</code>
artifact (Maven group ID <code>com.hp.it.spf.sso</code> and available at
the same repository as the SPF portlet utilities). Your portlet
application must include <code>spf-portlet-filters</code> in order to
load and run the <code>MapAttributeFilter</code>.</p>
</blockquote>

<blockquote>
<p><b>Note:</b> Your <code>portlet.xml</code> does not need to
specify the JSR-standard <code>&lt;user-attribute&gt;...&lt;/user-attribute&gt;</code>
elements in order for your portlet to have visibility to this data.
Similarly, this data is not accessible via the JSR-standard P3P map.</p>
</blockquote>

<a name="portal.user">
<h4>5.1.1. User data (profile attributes, groups, etc)</h4>
</a>

<p>SPF provides a {@java.util.Map} of user attributes aggregated
from numerous sources including HP Passport (when the user has logged-in
via HPP), HP Enterprise Directory (when the user has logged-in via the
&#64;HP employee portal), Persona, UPS, and UGS. This map, called the <i>SPF
user profile map</i>, is set in {@javax.portlet.PortletRequest#USER_INFO} as
per the Java standard. When the user is not logged-in, this map is still
provided - however its properties are set to default values for the
user's current resolved locale. (The resolved locale is the one
available to you via <code>PortletRequest.getLocale</code> - see the
previous discussion about <a href="#i18n.other.locale.get">getting
the locale</a>, which includes information on how this locale is
determined.)</p>

<p>The SPF portlet {@link com.hp.it.spf.xa.misc.portlet.Utils} class
provides access to the properties in the user profile map. You can get
user attributes, groups, and check whether or not the user is logged-in.</p>

<a name="portal.request">
<h4>5.1.2. Portal request data (site name, portlet ID, URLs, etc)</h4>
</a>

<p>SPF provides another {@java.util.Map} containing data about the
portal request and context. In that map is recorded information like the
current portal site name and URL, and the current portlet ID assigned to
the portlet in the portal.</p>

<p>The SPF portlet {@link com.hp.it.spf.xa.misc.portlet.Utils} class
provides access to these data elements as well.</p>

<hr>

<a name="portal.user.get">
<h3>5.2. Accessing user data</h3>
</a>

<p>Use {@link com.hp.it.spf.xa.misc.portlet.Utils} to access user
data, including profile attributes, groups, and current authentication
status. Be sure you have configured the SPF <code>MapAttributeFilter</code>
as <a href="#portal.kinds">shown above</a>.</p>

<a name="portal.user.loginStatus">
<h4>5.2.1. Checking user authentication status (<code>Utils.isAuthenticatedUser</code>)</h4>
</a>

<p>Use {@link
com.hp.it.spf.xa.misc.portlet.Utils#isAuthenticatedUser(PortletRequest)}
to determine whether the user is currently logged-in or not. This method
takes one parameter, the current {@link javax.portlet.PortletRequest}.
For example (where <code>request</code> is your <code>PortletRequest</code>):</p>

<blockquote><pre>
import com.hp.it.spf.xa.misc.portlet.Utils;
...
if (Utils.isAuthenticatedUser(request)) {
    // user is logged-in
    ...
} else {
    // user is not logged-in
    ...
}
</pre></blockquote>

<p>Please see the method documentation for more information.</p>

<a name="portal.user.props">
<h4>5.2.2. Accessing user profile attributes (<code>Utils.getUserProperty</code>)</h4>
</a>

<p>Use {@link
com.hp.it.spf.xa.misc.portlet.Utils#getUserProperty(PortletRequest,String)}
to obtain user attributes from the SPF <i>user profile map</i>. The
method returns an {@link java.lang.Object} whose type depends on the
type of property. The method takes the following arguments:</p>

<ul>
	<li>
	<p>The current {@link javax.portlet.PortletRequest} object.</p>
	</li>
	<li>
	<p>The string name of the property to lookup. This could be the
	name of a core user property from HP Passport or the &#64;HP employeee
	portal - these are the user-identity systems in SPF - or it could be
	the name of an extended user property from those systems, or from
	Persona or UPS.</p>

	<p>The core user-identity properties' names each have constants
	defined for them in the {@link com.hp.it.spf.xa.misc.portlet.Consts}
	class. They are the <code>Consts</code> class attributes whose names
	begin with <code>KEY_*</code> but <b>not</b> <code>KEY_PORTAL_*</code>.
	Here they are:</p>

	<dl>
		<dt>{@link com.hp.it.spf.xa.misc.portlet.Consts#KEY_CITY}</dt>
		<dd>
		<p>When you use this argument with an authenticated user, it
		returns the "city" field from the postal address on record for the
		user. This is taken from the HP Passport business contact data, or the
		HP Enterprise Directory information for the user (depending on whether
		the user logged-in via HPP or the &#64;HP employee portal).</p>
		<p>For an anonymous user, this returns null.</p>
		<p><i>Returns type:</i> {@link java.lang.String}</p>
		</dd>

		<dt>{@link com.hp.it.spf.xa.misc.portlet.Consts#KEY_COUNTRY}</dt>
		<dd>
		<p>When you use this argument, <code>Utils.getUserProperty</code>
		returns the <a
			href="http://www.iso.org/iso/country_codes/iso_3166_code_lists/english_country_names_and_code_elements.htm">ISO
		3166-1</a> country code for the country of the user. Note this is <b>not</b>
		necessarily the same as the country in the current resolved locale (ie
		the one returned by the <code>PortletRequest.getLocale</code> method -
		see the previous discussion about <a href="#i18n.other.locale.get">how
		SPF gets that locale</a>). Rather it is the country of record in the user
		profile:</p>
		<p>For an authenticated &#64;HP user, this will be the country of
		record for the user in the HP Enterprise Directory.</p>
		<p>For an authenticated HP Passport user, this is the HPP <code>residentCountryCode</code>
		attribute from the HPP user profile.</p>
		<p>For an anonymous user, this is the country of record for the
		default user profile the user has been assigned, based on their
		current resolved locale.</p>

		<p><i>Returns type:</i> {@link java.lang.String}</p>
		</dd>

		<dt>{@link com.hp.it.spf.xa.misc.portlet.Consts#KEY_EMAIL}</dt>
		<dd>
		<p>When you use this argument with an authenticated user, <code>Utils.getUserProperty</code>
		returns the email address for the user. This is taken from the HPP or
		HP ED user account.</p>
		<p>For an anonymous user, this returns null.</p>

		<p><i>Returns type:</i> {@link java.lang.String}</p>
		</dd>

		<dt>{@link com.hp.it.spf.xa.misc.portlet.Consts#KEY_EMAIL_PREF}</dt>
		<dd>
		<p>When you use this argument with an authenticated HP Passport
		user, it returns the user's opt-in preference for email contact from
		HP. A value of <code>Y</code> means the user is willing to be
		contacted via email. Any other value (eg, <code>N</code>) means the
		user wishes not to be contacted via email.</p>
		<p>For &#64;HP and anonymous users, this returns null.</p>
		<p><i>Returns type:</i> {@link java.lang.String}</p>
		</dd>

		<dt>{@link com.hp.it.spf.xa.misc.portlet.Consts#KEY_FIRST_NAME}</dt>
		<dd>
		<p>When you use this argument with an authenticated user, it
		returns the first (ie given) person name for the user, as taken from
		the HP Passport or HP Enterprise Directory information for the user
		(depending on whether the user logged-in via HPP or the &#64;HP
		employee portal).</p>
		<p>For an anonymous user, this returns null</p>

		<p><i>Returns type:</i> {@link java.lang.String}</p>
		</dd>

		<dt>{@link com.hp.it.spf.xa.misc.portlet.Consts#KEY_LANGUAGE}</dt>
		<dd>
		<p>When you use this argument, <code>Utils.getUserProperty</code>
		returns a code for the language of the user. Note that this is <b>not</b>
		necessarily the same as the language in the current resolved locale
		(ie the one returned by the <code>PortletRequest.getLocale</code>
		method - see the previous discussion about <a
			href="#i18n.other.locale.get">how SPF gets that locale</a>). Rather
		it is the language of record in the user profile:</p>
		<p>For an authenticated &#64;HP user, this will always be <code>en</code>.
		</p>
		<p>For an authenticated HP Passport user, this is the HPP <code>langCode</code>
		attribute from the HPP user profile. It looks like an <a
			href="http://www.loc.gov/standards/iso639-2/php/English_list.php">ISO
		639-1</a> language code, but there are exceptions for Simplified and
		Traditional Chinese (you can use one of the SPF-provided converter
		methods, like {@link
		com.hp.it.spf.xa.i18n.portlet.I18nUtility.hppLanguageToLocale(String)},
		to normalize it).</p>
		<p>For an anonymous user, this is the <a
			href="http://www.loc.gov/standards/iso639-2/php/English_list.php">ISO
		639-1</a> language code of record for the default user profile the user
		has been assigned, based on their current resolved locale.</p>

		<p><i>Returns type:</i> {@link java.lang.String}</p>
		</dd>

		<dt>{@link
		com.hp.it.spf.xa.misc.portlet.Consts#KEY_LAST_CHANGE_DATE}</dt>
		<dd>
		<p>When you use this argument with an authenticated user, it
		returns the date and time of the most recent change to any of the
		profile attributes in the user account. This is taken from the HP
		Passport or HP Enterprise Directory information for the user
		(depending on whether the user logged-in via HPP or the &#64;HP
		employee portal).</p>
		<p>For an anonymous user, this is a null object.</p>
		<p><i>Returns type:</i> {@link java.util.Date}</p>
		</dd>

		<dt>{@link
		com.hp.it.spf.xa.misc.portlet.Consts#KEY_LAST_LOGIN_DATE}</dt>
		<dd>
		<p>When you use this argument with an authenticated user, it
		returns the date and time of the most recent successful authentication
		for the user account. This is taken from the HP Passport or HP
		Enterprise Directory information for the user (depending on whether
		the user logged-in via HPP or the &#64;HP employee portal).</p>
		<p>For an anonymous user, this is a null object.</p>
		<p><i>Returns type:</i> {@link java.util.Date}</p>
		</dd>

		<dt>{@link com.hp.it.spf.xa.misc.portlet.Consts#KEY_LAST_NAME}</dt>
		<dd>
		<p>When you use this argument with an authenticated user, it
		returns the last (ie family or surname) person name for the user, as
		taken from the HP Passport or HP Enterprise Directory information for
		the user (depending on whether the user logged-in via HPP or the
		&#64;HP employee portal).</p>
		<p>For an anonymous user, this returns null</p>

		<p><i>Returns type:</i> {@link java.lang.String}</p>
		</dd>

		<dt>{@link com.hp.it.spf.xa.misc.portlet.Consts#KEY_MAIL_STOP}</dt>
		<dd>
		<p>When you use this argument with an authenticated user, it
		returns the "mail stop" field from the postal address on record for
		the user. This is taken from the HP Passport business contact data, or
		the or HP Enterprise Directory information for the user (depending on
		whether the user logged-in via HPP or the &#64;HP employee portal).</p>
		<p>For an anonymous user, this returns null.</p>
		<p><i>Returns type:</i> {@link java.lang.String}</p>
		</dd>

		<dt>{@link com.hp.it.spf.xa.misc.portlet.Consts#KEY_PHONE_NUMBER}</dt>
		<dd>
		<p>When you use this argument with an authenticated user, it
		returns the telephone number on record for the user. This is taken
		from the HP Passport business contact data, or the HP Enterprise
		Directory information for the user (depending on whether the user
		logged-in via HPP or the &#64;HP employee portal). Whether the
		telephone number already includes international dialing information
		depends on those systems.</p>
		<p>For an anonymous user, this returns null.</p>
		<p><i>Returns type:</i> {@link java.lang.String}</p>
		</dd>

		<dt>{@link
		com.hp.it.spf.xa.misc.portlet.Consts#KEY_PHONE_NUMBER_EXT}</dt>
		<dd>
		<p>When you use this argument with an authenticated user, it
		returns the telephone extension on record for the user. This is taken
		from the HP Passport business contact data, or the HP Enterprise
		Directory information for the user (depending on whether the user
		logged-in via HPP or the &#64;HP employee portal).</p>
		<p>For an anonymous user, this returns null.</p>
		<p><i>Returns type:</i> {@link java.lang.String}</p>
		</dd>

		<dt>{@link com.hp.it.spf.xa.misc.portlet.Consts#KEY_PHONE_PREF}</dt>
		<dd>
		<p>When you use this argument with an authenticated HP Passport
		user, it returns the user's opt-in preference for telephone contact
		from HP. A value of <code>Y</code> means the user is willing to be
		contacted via telephone. Any other value (eg, <code>N</code>) means
		the user wishes not to be contacted by telephone.</p>
		<p>For &#64;HP and anonymous users, this returns null.</p>
		<p><i>Returns type:</i> {@link java.lang.String}</p>
		</dd>

		<dt>{@link com.hp.it.spf.xa.misc.portlet.Consts#KEY_POSTAL_PREF}</dt>
		<dd>
		<p>When you use this argument with an authenticated HP Passport
		user, it returns the user's opt-in preference for postal mail contact
		from HP. A value of <code>Y</code> means the user is willing to be
		contacted via postal mail. Any other value (eg, <code>N</code>) means
		the user wishes not to be contacted by postal mail.</p>
		<p>For &#64;HP and anonymous users, this returns null.</p>
		<p><i>Returns type:</i> {@link java.lang.String}</p>
		</dd>

		<dt>{@link com.hp.it.spf.xa.misc.portlet.Consts#KEY_PROFILE_ID}</dt>
		<dd>
		<p>When you use this argument with an authenticated user, <code>Utils.getUserProperty</code>
		returns the internal ID (called the <i>profile ID</i>) for the user.
		This is an internal principal for the user, not known to the user,
		which is both unique to the user account and static over time. This is
		an ASCII string, but its exact format is internal and differs for HPP
		and &#64;HP users accounts.</p>

		<p>For an anonymous user, this is a non-null, non-blank, reserved
		ASCII string indicating the kind of default user profile that the user
		has been assigned. It should not be considered user-visible or unique.</p>

		<p><i>Returns type:</i> {@link java.lang.String}</p>
		<dt>{@link
		com.hp.it.spf.xa.misc.portlet.Consts#KEY_SECURITY_LEVEL}</dt>
		<dd>
		<p>When you use this argument with an authenticated HP Passport
		user, it returns the user's HPP security level. This is an integer
		indicating the level of authentication stringency applied by HPP when
		validating the user's credentials. The lower the number, the lesser
		the security constraints imposed (eg password complexity, password
		expiry policy, etc).</p>
		<p>When you use this argument with an authenticated &#64;HP user,
		it returns the user's &#64;HP security level. This also is an integer,
		corresponding to the kind of login which the user used (SEA or
		DigitalBadge).</p>
		<p>For anonymous users and &#64;HP users, this returns null.</p>
		<p><i>Returns type:</i> {@link java.lang.Integer}</p>
		</dd>

		<dt>{@link com.hp.it.spf.xa.misc.portlet.Consts#KEY_STATE}</dt>
		<dd>
		<p>When you use this argument with an authenticated user, it
		returns the "state or province" field from the postal address on
		record for the user. This is taken from the HP Passport business
		contact data, or the HP Enterprise Directory information for the user
		(depending on whether the user logged-in via HPP or the &#64;HP
		employee portal).</p>
		<p>For an anonymous user, this returns null.</p>
		<p><i>Returns type:</i> {@link java.lang.String}</p>
		</dd>

		<dt>{@link com.hp.it.spf.xa.misc.portlet.Consts#KEY_STREET}</dt>
		<dd>
		<p>When you use this argument with an authenticated user, it
		returns the "street" field from the postal address on record for the
		user. This is taken from the HP Passport business contact data, or the
		HP Enterprise Directory information for the user (depending on whether
		the user logged-in via HPP or the &#64;HP employee portal).</p>
		<p>For an anonymous user, this returns null.</p>
		<p><i>Returns type:</i> {@link java.lang.String}</p>
		</dd>

		<dt>{@link com.hp.it.spf.xa.misc.portlet.Consts#KEY_TIMEZONE}</dt>
		<dd>
		<p>When you use this argument with an authenticated user, it
		returns the timezone for the user, as taken from the HP Passport
		business contact data, or the HP Enterprise Directory information for
		the user (depending on whether the user logged-in via HPP or the
		&#64;HP employee portal).</p>
		<p>For an anonymous user, this is the timezone of record for the
		default profile the user has been assigned, based on their current
		resolved locale (see the discussion about <a
			href="#i18n.other.locale.get">getting the locale</a>, for how the
		locale is determined).</p>

		<blockquote>
		<p><b>Note:</b> This is just a reasonable default timezone for the
		locale, based primarily on the country in the locale (if any), and the
		language in the locale if the country is generic. For example, the
		Japan timezone is returned for any Japan-country locale, or any
		Japanese-language locale with an unrecognized (or generic) country.
		Many locales span multiple timezones, so the SPF just assigns one of
		them by default in that case. SPF defaults to GMT if it does not
		recognize the locale for this purpose. The mapping between locale and
		timezone returned by the SPF for an anonymous user is not published
		and may change over time.</p>
		</blockquote>

		<p><i>Returns type:</i> {@link java.lang.String} which is a valid
		{@link java.util.TimeZone} ID string from which you can build a <code>TimeZone</code>
		object</p>
		</dd>

		<dt>{@link com.hp.it.spf.xa.misc.portlet.Consts#KEY_USER_NAME}</dt>
		<dd>
		<p>When you use this argument with an authenticated user, <code>Utils.getUserProperty</code>
		returns the ID which the user used to login to HP Passport (or, in the
		case of a user accessing SPF via &#64;HP, this is the HP SEA). This
		user ID is unique, but please note that it may change over time, since
		both HP Passport and HP ED allow it to change.</p>

		<p>For an anonymous user, this is a non-null, non-blank, reserved
		ASCII string indicating the kind of default user profile that the user
		has been assigned. It should not be considered user-visible or unique.</p>

		<p><i>Returns type:</i> {@link java.lang.String}</p>
		</dd>

		<dt>{@link com.hp.it.spf.xa.misc.portlet.Consts#KEY_ZIP}</dt>
		<dd>
		<p>When you use this argument with an authenticated user, it
		returns the "postal code" field from the postal address on record for
		the user. This is taken from the HP Passport business contact data, or
		the HP Enterprise Directory information for the user (depending on
		whether the user logged-in via HPP or the &#64;HP employee portal).</p>
		<p>For an anonymous user, this is a null or blank string.</p>
		<p><i>Returns type:</i> {@link java.lang.String}</p>
		</dd>

	</dl>
</ul>
<blockquote>
<p><b>Note:</b> The above are just the core properties. The extended
properties include other business contact and home contact data elements
from HP Passport, as well as custom properties from Persona or UPS.
Their property names are not defined here. SPF will relay them through
if they are encountered, however, and you can access them by passing the
string literal property name to the same <code>Utils.getUserProperty</code>
API. All are returned as type {@link java.lang.String}.</p>
</blockquote>

<p>For example, here is how we can use <code>Utils.getUserProperty</code>,
along with the <a href="#overview.other.spf.common">SPF common
utilities</a> {@link
com.hp.it.spf.xa.i18n.portlet.I18nUtility#getUserDisplayName(String,String,Locale)}
method, to get the full name for the user (in customary order of given
and family name). In this example, <code>request</code> is the <code>PortletRequest</code>:</p>

<blockquote><pre>
import com.hp.it.spf.xa.i18n.portlet.I18nUtility;
import com.hp.it.spf.xa.misc.portlet.Utils;
import com.hp.it.spf.xa.misc.portlet.Consts;
...
String fn = (String) Utils.getUserProperty(request, Consts.KEY_FIRST_NAME);
String ln = (String) Utils.getUserProperty(request, Consts.KEY_LAST_NAME);
String fullName = I18nUtility.getUserDisplayName(fn, ln, request.getLocale());
...
// Tip: if you are going to display this fullName in the UI, you should also
// escape it in case for some reason there are HTML metacharacters in it (eg
// an XSS attack):
String escapedFullName = Utils.escapeXml(fullName);
</pre></blockquote>

<a name="portal.user.groups">
<h4>5.2.3. Accessing user groups (<code>Utils.getGroups</code>, <code>Utils.isUserInGroup</code>)</h4>
</a>

<p>Use these methods to access and test the user's security groups
(see <b>Background</b> below for more information about groups). These
methods work for anonymous as well as authenticated users.</p>

<dl>
	<dt>{@link
	com.hp.it.spf.xa.misc.portlet.Utils#getGroups(PortletRequest)}</dt>
	<dd>
	<p>Use this method to obtain an array of names of the security
	groups to which the user belongs. The method takes the current {@link
	javax.portlet.PortletRequest} for the user. For example (where <code>request</code>
	is the current <code>PortletRequest</code>):</p>

	<blockquote><pre>
import com.hp.it.spf.xa.misc.portlet.Utils;
...
String[] groups = Utils.getGroups(request);
</pre></blockquote>
	</dd>

	<dt>{@link
	com.hp.it.spf.xa.misc.portlet.Utils#isUserInGroup(PortletRequest,String)}</dt>
	<dd>
	<p>Use this method to check whether the the user belongs to a
	certain security group. The method takes the current {@link
	javax.portlet.PortletRequest} for the user, as well as a name (string)
	for the group to check. For example, to check if the user is in the <code>ABC</code>
	group (and where <code>request</code> is the current <code>PortletRequest</code>):
	</p>

	<blockquote><pre>
import com.hp.it.spf.xa.misc.portlet.Utils;
...
if (Utils.isUserInGroup(request, "ABC")) {
    // user is in the group
    ...
} else {
    // user is not in the group
    ...
}
</pre></blockquote>
	</dd>
</dl>

<p>Please see the method documentation for more information.</p>

<p><b>Background:</b> The SPF has 2 related concepts for
authorization: groups and roles. Groups are portal-level constructs and
are not JSR portlet standard; roles are portlet-level constructs which
are JSR-standard. The SPF portal both forwards the user's groups as part
of the {@link javax.portlet.PortletRequest}, and maps the groups into
roles which are likewise part of the <code>PortletRequest</code>. The
group-to-role mapping is specified when provisioning the portlet inside
the portal. In SPF, groups themselves are generally mapped from other
characteristics, either in the portal itself, or in UGS. Both groups and
roles can exist apart from authentication; ie anonymous users can still
be in groups/roles. This SPF authorization design is documented
elsewhere.</p>

<p>The actual groups will vary by application and over time. The SPF
core framework defines the following groups, but applications will add
to them. All SPF users (whether authenticated or anonymous) are
automatically assigned by the SPF into the following groups as
appropriate:</p>

<dl>
	<dt>
	<p><b><u>Access Type Groups:</u></b></p>
	</dt>
	<dd>
	<dl>
		<dt><code>{@link
		com.hp.it.spf.xa.misc.portlet.Consts#GROUP_AUTH_TYPE_ATHP}</code></dt>
		<dd>
		<p>Indicates the user is a member of the &#64;HP employee portal,
		not HP Passport. Whether the user is currently logged-into his/her HP
		Enterprise Directory account is irrelevant; this group indicates the
		user is accessing via the HP Intranet and the &#64;HP authentication
		system.</p>
		</dd>

		<dt><code>{@link
		com.hp.it.spf.xa.misc.portlet.Consts#GROUP_AUTH_TYPE_HPP}</code></dt>
		<dd>
		<p>Indicates the user is a member of <i>standard</i> (not
		federated) HP Passport. Whether the user is currently logged-into
		his/her HPP user account is irrelevant; this group indicates the user
		is accessing through the public (ie HPP) authentication system.
		However the current portal site, and the HPP policies, have not been
		enabled for user-identity federation with a 3rd-party identity
		provider. (User identity federation is not typically used with SPF at
		this time.)</p>
		</dd>

		<dt><code>{@link
		com.hp.it.spf.xa.misc.portlet.Consts#GROUP_AUTH_TYPE_FED}</code></dt>
		<dd>
		<p><i>This group is uncommon in most SPF portal applications.</i>
		It indicates the user is a member of <i>federated</i> (not standard)
		HP Passport. Whether the user is currently logged-into his/her HPP
		user account is irrelevant; this group indicates the user is accessing
		through the public (ie HPP) authentication system, which has been
		setup (along with the portal site) for user-identity federation with a
		3rd-party identity provider. (User identity federation is not
		typically used with SPF at this time.)</p>
		</dd>
	</dl>
	</dd>
	<dt>
	<p><b><u>Authentication Status Groups:</u></b></p>
	</dt>
	<dd>
	<dl>
		<dt><code>{@link
		com.hp.it.spf.xa.misc.portlet.Consts#GROUP_AUTH_STATUS_AUTHENTICATED}</code></dt>
		<dd>
		<p>Indicates the user is currently logged-in (whether via HP
		Passport or HP Enterprise Directory is not indicated; check the
		access-type groups).</p>
		</dd>

		<dt><code>{@link
		com.hp.it.spf.xa.misc.portlet.Consts#GROUP_AUTH_STATUS_ANONYMOUS}</code></dt>
		<dd>
		<p>Indicates the user is currently <b>not</b> logged-in (whether
		via HP Passport or HP Enterprise Directory is not indicated; check the
		access-type groups).</p>
		</dd>
	</dl>
	<p><b>Note:</b> These groups are mutually-exclusive. They will
	present consistently with the results of the <a
		href="#portal.user.loginStatus"><code>Utils.isAuthenticatedUser</code>
	method</a> (see above). That is, when <code>Utils.isAuthenticatedUser</code>
	returns true, the user will also be a member of the <code>{@link
	com.hp.it.spf.xa.misc.portlet.Consts#GROUP_AUTH_STATUS_AUTHENTICATED}</code>
	group; and vice-versa.</p>
	</dd>
	<dt>
	<p><b><u>Locale Groups:</u></b></p>
	</dt>
	<dd>
	<dl>
		<dt><code>{@link
		com.hp.it.spf.xa.misc.portlet.Consts#GROUP_LOCALE_COUNTRY_PREFIX} + "<i>&lt;country-code&gt;</i>"</code></dt>
		<dd>
		<p>Indicates the user should be considered a member of the group
		for the particular country. This is based on the locale resolved for
		the user (ie, this is the locale returned by <a
			href="#i18n.other.locale.get"><code>PortletRequest.getLocale</code></a>).
		The <code><i>&lt;country-code&gt;</i></code> is the uppercase <a
			href="http://www.iso.org/iso/country_codes/iso_3166_code_lists/english_country_names_and_code_elements.htm">ISO
		3166-1</a> country code. Note that this may, or may not, be the same
		country as the user's registered country in SiteMinder (eg, the <code>residentCountryCode</code>
		attribute of the core HPP profile).</p>
		<p>For example, <code>Consts.GROUP_LOCALE_COUNTRY_PREFIX +
		"BR"</code> for a user with any Brazil locale; <code>Consts.GROUP_LOCALE_COUNTRY_PREFIX
		+ "GB"</code> for a user with any United Kingdom locale; etc.</p>
		<blockquote>
		<p><b>Note:</b> When the user's resolved locale does not include a
		country (ie a generic locale like French), the user will not be
		assigned into any such group.</p>
		</blockquote>
		</dd>

		<dt><code>{@link
		com.hp.it.spf.xa.misc.portlet.Consts#GROUP_LOCALE_LANGUAGE_PREFIX} + "<i>&lt;language-code&gt;</i>"</code></dt>
		<dd>
		<p>Indicates the user should be considered a member of the group
		for the particular language. This is based on the locale resolved for
		the user (ie this is the locale returned by <a
			href="#i18n.other.locale.get"><code>PortletRequest.getLocale</code></a>).
		The <code><i>&lt;language-code&gt;</i></code> is the uppercase <a
			href="http://www.loc.gov/standards/iso639-2/php/English_list.php">ISO
		639-1</a> language code. Note that this may, or may not, be the same
		language as the user's registered language in SiteMinder (eg, the <code>langCode</code>
		attribute of the core HPP profile).</p>
		<p>For example, <code>Consts.GROUP_LOCALE_LANGUAGE_PREFIX +
		"ZH"</code> for a user with any Chinese-language locale; <code>Consts.GROUP_LOCALE_LANGUAGE_PREFIX
		+ "RU"</code> for a user with any Russian-language locale; etc.</p>
		</dd>
	</dl>
	</dd>
</dl>

<hr>

<a name="portal.request.get">
<h3>5.3. Accessing portal request data</h3>
</a>

<p>Use {@link com.hp.it.spf.xa.misc.portlet.Utils} to access portal
request data, including the portal site name, the portlet ID, and the
URL's for the current portal request and the portal site home page. Be
sure you have configured the SPF <code>MapAttributeFilter</code> as <a
	href="#portal.kinds">shown above</a>.</p>

<a name="portal.request.site">
<h4>5.3.1. Accessing the portal site name (<code>Utils.getPortalSiteName</code>)</h4>
</a>

<p>Use {@link
com.hp.it.spf.xa.misc.portlet.Utils#getPortalSiteName(PortletRequest)}
to get the name of the current portal site. SPF is a portal-hosting
platform for hosting numerous individual portal sites - this method will
return the name of your site, as assigned by the portal administrator.
Note that in Vignette, this is the "site DNS name". For example (where <code>request</code>
is the {@link com.hp.it.spf.xa.misc.portlet.PortletRequest}):</p>

<blockquote><pre>
import com.hp.it.spf.xa.misc.portlet.Utils;
...
String siteName = Utils.getPortalSiteName(request);
</pre></blockquote>

<p>Please see the method documentation for more information.</p>

<a name="portal.request.portlet">
<h4>5.3.2. Accessing the portlet ID (<code>Utils.getPortalPortletID</code>)</h4>
</a>

<p>Use {@link
com.hp.it.spf.xa.misc.portlet.Utils#getPortalPortletID(PortletRequest)}
to get the ID for your portlet as it is known to your portal site. This
portlet ID is assigned to the instance of your portlet when it is
created by the portal administrator. Note that in Vignette, this is the
"portlet friendly ID". For example (where <code>request</code> is the
{@link javax.portlet.PortletRequest}):</p>

<blockquote><pre>
import com.hp.it.spf.xa.misc.portlet.Utils;
...
String portletID = Utils.getPortalPortletID(request);
</pre></blockquote>

<p>Please see the method documentation for more information.</p>

<a name="portal.request.url">
<h4>5.3.3. Accessing portal URL's (<code>Utils.getPortalRequestURL</code>,
<code>Utils.getPortalSiteURL</code>)</h4>
</a>

<p>Use these methods to get portal URL's for the portal site
containing your portlet.</p>

<dl>
	<dt>{@link
	com.hp.it.spf.xa.misc.portlet.Utils#getPortalRequestURL(PortletRequest)}</dt>
	<dt>{@link
	com.hp.it.spf.xa.misc.portlet.Utils#getPortalRequestURL(PortletRequest,Boolean,String,int)}</dt>
	<dd>
	<p>These methods return a URL corresponding to the current portal
	request. By default, the URL contains the same scheme, hostname and
	port which the browser used, with the path for the current portal page
	and site. Its query string (if any) contains all of the form parameters
	for the current page as well (including parameters targeted to your
	portlet, if any). It does not matter whether the form parameters were
	submitted via HTTP <code>GET</code> or <code>POST</code> - they are
	included in the query string of the URL returned by this method.</p>
	<p>The arguments are:</p>
	<ul>
		<li>Your current {@link javax.portlet.PortletRequest}.</li>
		<li>A {@link java.lang.Boolean} indicating the security scheme
		that should be set into the returned URL. If true, then the returned
		URL will be an <code>https</code> URL. If false, then it will be an <code>http</code>
		URL. By default (eg if you provide null for this argument) the scheme
		will be the same as used in the current request.</li>
		<li>A string hostname indicating the hostname that should be set
		into the returned URL. By default (eg if you provide a null or blank
		string), the hostname will be the same as used in the current request.</li>
		<li>An integer port number indicating the port that should be
		specified in the returned URL. By default (eg if you provide a
		non-positive number), the port will be the same as used in the current
		request.</li>
		<blockquote>
		<p><b>Note:</b> You can configure a non-standard HTTP or HTTPS
		port in the <code>portalurl.properties</code> file. If you switch the
		security scheme using this method, and do not provide a positive port
		number directly, your non-standard port number from the file will be
		used in the returned URL string. For information about installing and
		configuring <code>portalurl.properties</code>, please see the SPF
		common utilities developer's guide.</p>
		</blockquote>
	</ul>
	<p>For example, this gets the URL for the current request (where <code>request</code>
	is the {@link javax.portlet.PortletRequest}):</p>
	<blockquote><pre>
import com.hp.it.spf.xa.misc.portlet.Utils;
...
String url = Utils.getPortalRequestURL(request);
</pre></blockquote>
	<p>And this forcibly changes it to use HTTPS:</p>
	<blockquote><pre>
import com.hp.it.spf.xa.misc.portlet.Utils;
...
String url = Utils.getPortletRequestURL(request, new Boolean(true));
</pre></blockquote>
	</dd>

	<dt>{@link
	com.hp.it.spf.xa.misc.portlet.Utils#getPortalSiteURL(PortletRequest)}</dt>
	<dd>
	<p>This method returns the URL for the current portal site's home
	page. The URL contains the same scheme, hostname, and port which the
	browser used for the current portal page. The URL can be used with the
	<a href="#overview.other.spf.common">SPF common utilities</a> {@link
	com.hp.it.spf.xa.portalurl.PortalURL} interface when constructing
	portal URL objects for arbitrary sites, pages and portlets.</p>

	<p>For example, consider that we wish to build a <code>PortalURL</code>
	for the current portal site's Forums page, where <code>forums</code> is
	the friendly URI. Here is the code (where <code>request</code> is the
	{@link javax.portlet.PortletRequest} - and note that {@link
	com.hp.it.spf.xa.portalurl.PortalURL} and {@link
	com.hp.it.spf.xa.portalurl.PortalURLFactory} are artifacts inside the <a
		href="#overview.other.spf.common">SPF common utilities</a>):</p>

	<blockquote><pre>
import com.hp.it.spf.xa.misc.portlet.Utils;
import com.hp.it.spf.xa.portalurl.PortalURL;
import com.hp.it.spf.xa.portalurl.PortalURLFactory;
...
String home = Utils.getPortalSiteURL(request);
PortalURL portalURL = PortalURLFactory.createPageURL(home, "forums");
...
// We could then continue with the portalURL, to target a particular portlet
// on that page, setting its mode, parameters, etc.  Please see the
// PortalURL documentation.
...
String url = portalURL.toString();
</pre></blockquote>

	<p>We could then continue with the <code>PortalURL</code> to target
	a particular portlet on that page, setting its mode, parameters, etc.
	Please see the <code>PortalURL</code> documentation.</p>
	</dd>

	<dt>{@link
	com.hp.it.spf.xa.misc.portlet.Utils#getPortalSiteURL(PortletRequest,Boolean,String,int,String)}</dt>
	<dd>
	<p>This method returns the URL for a page at a portal site. By
	default, the URL contains the same scheme, hostname, and port which the
	browser used for the current portal page. Also by default, the URL
	points to the home page for the current portal site. (Thus the default
	behavior of this method is the same as the above method.) However you
	can override the defaults with the arguments. They are:</p>

	<ul>
		<li>
		<p>Your current {@link javax.portlet.PortletRequest}.</p>
		</li>
		<li>
		<p>A {@link java.lang.Boolean} indicating the security scheme that
		should be set into the returned URL. If true, then the returned URL
		will be an <code>https</code> URL. If false, then it will be an <code>http</code>
		URL. By default (eg if you provide null for this argument) the scheme
		will be the same as used in the current request.</p>
		</li>
		<li>
		<p>A string hostname indicating the hostname that should be set
		into the returned URL. By default (eg if you provide a null or blank
		string), the hostname will be the same as used in the current request.</p>
		</li>
		<li>
		<p>An integer port number indicating the port that should be
		specified in the returned URL. By default (eg if you provide a
		non-positive number), the port will be the same as used in the current
		request.</p>
		<blockquote>
		<p><b>Note:</b> You can configure a non-standard HTTP or HTTPS
		port in the <code>portalurl.properties</code> file. If you switch the
		security scheme using this method, and do not provide a positive port
		number directly, your non-standard port number from the file will be
		used in the returned URL string. For information about installing and
		configuring <code>portalurl.properties</code>, please see the SPF
		common utilities developer's guide.</p>
		</blockquote>
		</li>
		<li>
		<p>The final string argument is used to provide a <i>site-relative
		URI</i>, including optionally the portal site name and additional
		page-specific path (such as a friendly URI, template ID, query string,
		etc). As follows:</p>
		<ul>
			<li>If the URI string starts with <code>/</code> then the
			returned portal URL will be for the current portal site. The URI
			string specifies the particular page at that site (plus any
			additional path and/or query parameters).</li>
			<li>Otherwise the first part of the URI string is considered to
			be the site name for the desired portal site. Anything after the
			first <code>/</code> in the URI string is considered to specify the
			particular page, as above.</li>
		</ul>
		</li>
	</ul>

	<p>Let's repeat the above example, but this time without using <code>PortalURL</code>.
	It can all be done through this method instead. Here is the code (the
	null and -1 parameters cause the hostname, scheme and port to default
	to their current values):</p>

	<blockquote><pre>
import com.hp.it.spf.xa.misc.portlet.Utils;
...
String url = Utils.getPortalSiteURL(request, null, null, -1, "/forums");
</pre></blockquote>

	<p>If we wanted to switch to HTTPS on a non-standard port 444, too,
	we could do it like this (passing null as the final parameter means
	this will result in a home page URL for our current site):</p>

	<blockquote><pre>
import com.hp.it.spf.xa.misc.portlet.Utils;
...
String url = Utils.getPortalSiteURL(request, new Boolean(true), null, 444, null);
</pre></blockquote>

	<blockquote>
	<p><b>Note:</b> If you are trying to build a portal URL that
	targets a particular portlet on that page, then you must use the
	approach with <code>PortalURL</code> instead, since only that API
	contains methods for targeting portlets and setting their modes,
	parameters, etc. Please see the documentation for {@link
	com.hp.it.spf.xa.portalurl.PortalURL} and {@link
	com.hp.it.spf.xa.portalurl.PortalURLFactory} - they are part of the <a
		href="#overview.other.spf.common">SPF common utilities</a></p>
	</blockquote>
	</dd>

	<dt>{@link
	com.hp.it.spf.xa.misc.portlet.Utils#getPortalSiteURL(PortletRequest,String)}</dt>
	<dd>
	<p>This method is like the above method, where the string parameter
	is the <i>site-relative URI</i>. Using this method, you can get a URL
	for any portal page, where the URL includes the same hostname, scheme
	and port as used for the current request.</p>
	</dd>
</dl>

<p>Please refer to the method documentation for more information.</p>

<hr>

<a name="error">
<h2>6. Error Handling</h2>
</a>

<p>For error handling in your portlet, you will generally rely on
the core technologies provided by WPAP, Spring Portlet MVC, and
J2EE/Java. However the Shared Portal Framework does provide some
extensions to assist with your error handling. This chapter describes
those extensions.</p>

<hr>

<a name="error.about">
<h3>6.1. About error handling and the Shared Portal Framework</h3>
</a>

<a name="error.about.other">
<h4>6.1.1. Error handling with WPA Portlet Edition and Spring
Portlet MVC</h4>
</a>

<p>Generally, when coding a portlet, you could use the standard WPAP
and Spring Portlet MVC technologies to perform your error handling:</p>

<ol>
	<li>
	<p>With Spring Portlet MVC, you can instantiate exceptions in your
	controllers during the action or render phases. You can use these
	exceptions to influence the output of your normal view, of course; but
	if desired you can instead throw them back to the Spring dispatcher.
	You can then configure an exception handler, such as Spring's provided
	{@link
	org.springframework.web.portlet.handler.SimpleMappingExceptionResolver}
	to catch them and forward, based on the particular exception class, to
	an appropriate artifact (eg in the case of <code>SimpleMappingExceptionResolver</code>
	you forward to an appropriate view). Please see the Spring
	documentation for more information on this. Spring Web MVC - which is
	the same as Spring Portlet MVC in this regard - also has the <code>SimpleMappingExceptionResolver</code>
	and it is covered in section <a
		href="http://static.springframework.org/spring/docs/2.0.x/reference/mvc.html#mvc-exceptionhandlers">section
	13.10</a> of the Spring Framework Reference Documentation.</p>
	</li>

	<li>
	<p>With WPA Portlet Edition, you can automatically inject logging
	of the thrown exception, using WPAP's {@link
	com.hp.frameworks.wpa.portlet.handler.TransactionLoggingInterceptor}.
	This way, when the Spring Portlet dispatcher catches the exception
	you've thrown, information about the exception is captured and logged
	automatically to the WPAP error and error trace logs. The WPAP business
	log will also record the fact that an exception occurred, in its status
	summary column. Please see the WPAP documentation for how to set this
	up. For example, for WPAP version 3.0.1, see <a
		href="http://dl.frameworks.hp.com/websat/websat/docs/wpap/core_3.0.1/javadoc/com/hp/frameworks/wpa/portlet/logging/package-summary.html#installation">Installation
	and Configuration</a> in the WPAP Transaction Logging Guide.</p>
	</li>
</ol>

<a name="error.about.spf">
<h4>6.1.2. Error handling extensions in SPF</h4>
</a>

<p>Shared Portal Framework offers a few technologies to augment what
is already provided by WPAP and Spring Portlet MVC:</p>

<ol>
	<li>
	<p>The SPF portlet utilities provide an {@link
	com.hp.it.spf.xa.exception.portlet.SPFException} hierarchy from which
	you can extend. This hierarchy supports the notion of error codes as
	well as error messages, and distinguishes <i>business exceptions</i>
	from <i>system exceptions</i>. It also supports defining localized
	user-suitable error messages for these exceptions, from your message
	resource bundles. We encourage you to subclass your exceptions from
	this hierarchy.</p>
	</li>

	<li>
	<p>The SPF portlet utilities also provide utility methods (in
	{@link com.hp.it.spf.xa.exception.portlet.ExceptionUtil}) for storing
	an exception into a request for later; and then accessing the stored
	exception (and any other exceptions chained with it), including such
	things as their localized user-suitable messages (with defaults). So in
	just a line or two of code in your view artifact (eg JSP) you can fetch
	and display a message about the stored exception to the user.</p>
	</li>

	<li>
	<p>Finally, if you throw an exception from your action or render
	phase, the SPF portlet utilities provide an extension to Spring's
	{@link
	org.springframework.web.portlet.handler.SimpleMappingExceptionResolver},
	also named {@link
	com.hp.it.spf.xa.exception.portlet.handler.SimpleMappingExceptionResolver},
	which stores the caught exception into the {@link
	javax.portlet.PortletRequest} automatically for you, so you can access
	it in your view. This just saves you from having to store it to the
	request yourself, before throwing the exception.</p>
	</li>
</ol>

<p>The rest of this chapter is about those technologies.</p>

<hr>

<a name="error.spf.exceptions">
<h3>6.2. Using the <code>SPFException</code> hierarchy (<code>SPFException</code>,
<code>BusinessException</code>, <code>SystemException</code>)</h3>
</a>

<p>The {@link com.hp.it.spf.xa.exception.portlet.SPFException} class
hierarchy is a useful exception family on which you can base your
portlet's exceptions. With this class hierarchy:</p>

<ul>
	<li>
	<p>You can classify each exception as a <i>business exception</i>
	or <i>system exception</i>:</p>
	<ul>
		<li>Business exceptions are error conditions for which the user
		is responsible, and which the user can repair if given an explanation.
		Business exceptions are usually violations of business logic in your
		portlet - for example, submitting a blank article to an existing
		Forums thread.</li>
		<li>System exceptions are error conditions for which the system
		is responsible, and which the user cannot repair by themselves.
		Business exceptions are usually system availability issues, unexpected
		data integrity problems, or likewise. For example, submitting an
		article to an existing Forums thread, which suddenly can no longer be
		found in the database, would be a system exception.</li>
	</ul>
	<p>This is a potentially useful division, since the two kinds of
	error conditions often have very different workflows. By dividing the
	world of error conditions up into these two categories, you may find
	your workflow easier to organize:</p>
	<ul>
		<li>Business exceptions often are rendered back to the original
		form in the UI, resulting in an error message to the user but no other
		action. Business exceptions typically have sufficiently detailed, and
		varying, error messages displayed to the user.</li>
		<li>System exceptions often involve some corrective action or
		error notification being taken later in your workflow. They also
		typically have "boilerplate" user messages associated with them,
		sometimes indistuinguishable from one another (since the user can do
		nothing about the problem anyway).</li>
	</ul>
	<p>Business exceptions are represented by the concrete subclass
	{@link com.hp.it.spf.xa.exception.portlet.BusinessException}, and
	system exceptions by the concrete subclass {@link
	com.hp.it.spf.xa.exception.portlet.SystemException}. You can
	instantiate these directly, or create condition-specific subclasses of
	them (eg <code>BlankArticleException extends BusinessException</code>,
	<code>ForumsThreadNotFoundException extends SystemException</code>,
	etc).</p>
	</li>

	<li>
	<p>Your SPF exceptions (business and system exceptions) can be
	characterized with an internal error code and message, and an external
	(ie user-suitable) localized message. You can also nest exceptions (and
	other throwables) inside them.</p>
	<ul>
		<li>
		<p>The <i>error code</i> is a short internal string which you
		could use as shorthand for the error condition (eg in an error
		resolution lookup table, system administration documentation, etc).
		For example, <code>error-422</code> or <code>error.forums.threadNotFound</code>
		or etc.</p>
		</li>
		<li>
		<p>The <i>error message</i> is a longer, still internal string
		which you can use to include some explanation of the problem for
		troubleshooting or administrative purposes (eg <code>The active
		forums thread (id: 1879A2) can no longer be found</code>).</p>
		</li>
		<li>
		<p>The <i>next-in-chain</i> {@link java.lang.Throwable} object, if
		any. This could be the root-cause for this exception, or it could be a
		related exception in a series. It may be another SPF exception, or any
		other kind of Java throwable.</p>
		</li>
	</ul>
	<p>Together the error code, error message, and the next-in-chain
	message (ie value of {@link java.lang.Throwable#getMessage()} from the
	next-in-chain object, if any) are included in the overall message for
	the SPF exception (ie in the value returned by the Java-standard {@link
	java.lang.Exception#getMessage()} method on an SPF exception). So if
	you have enabled WPAP error logging, these data elements will all
	appear in the logs if your SPF exception is thrown back to the
	dispatcher.</p>
	<ul>
		<li>
		<p>Finally, in this scheme, note that neither the error code nor
		message are generally localized or suitable for presentation to an
		end-user. So an SPF exception can include a <i>localized user
		message</i>. This message is automatically retrieved from your
		application's message resource bundles (ie the ones configured in your
		Spring application context), using your error code as the message key.
		This message lookup proceeds as described earlier in this document,
		for <a href="#i18n.messages.java.spf.getMessage"><code>I18nUtility.getMessage</code></a>.
		If the message cannot be found, the localized message defaults to the
		SPF exception's {@link java.lang.Exception#getMessage()} value, just
		as the Java standard {@link java.lang.Exception#getLocalizedMessage()}
		does.</p>
		</li>
	</ul>
</ul>

<p>The following constructors are available for the classes in this
hierarchy ({@link com.hp.it.spf.xa.exception.portlet.SPFException} is an
abstract base class - you would generally instantiate or extend from
either {@link com.hp.it.spf.xa.exception.portlet.BusinessException} or
{@link com.hp.it.spf.xa.exception.portlet.SystemException}):</p>

<dl>
	<dt>{@link
	com.hp.it.spf.xa.exception.portlet.BusinessException#BusinessException(String)}</dt>
	<dt>{@link
	com.hp.it.spf.xa.exception.portlet.BusinessException#BusinessException(String,String)}</dt>
	<dt>{@link
	com.hp.it.spf.xa.exception.portlet.BusinessException#BusinessException(String,Throwable,String)}</dt>
	<dt>{@link
	com.hp.it.spf.xa.exception.portlet.SystemException#SystemException(String)}</dt>
	<dt>{@link
	com.hp.it.spf.xa.exception.portlet.SystemException#SystemException(String,String)}</dt>
	<dt>{@link
	com.hp.it.spf.xa.exception.portlet.SystemException#SystemException(String,Throwable,String)}</dt>
	<dd>In these constructors, you provide your error code, error
	message, and/or next-in-chain throwable. The localized message is not
	available, and defaults to the error code, error message, and throwable
	message.</dd>
	<br>
	<br>

	<dt>{@link
	com.hp.it.spf.xa.exception.portlet.BusinessException#BusinessException(PortletRequest,String)}</dt>
	<dt>{@link
	com.hp.it.spf.xa.exception.portlet.BusinessException#BusinessException(PortletRequest,String,String)}</dt>
	<dt>{@link
	com.hp.it.spf.xa.exception.portlet.BusinessException#BusinessException(PortletRequest,String,Throwable,String)}</dt>
	<dt>{@link
	com.hp.it.spf.xa.exception.portlet.SystemException#SystemException(PortletRequest,String)}</dt>
	<dt>{@link
	com.hp.it.spf.xa.exception.portlet.SystemException#SystemException(PortletRequest,String,String)}</dt>
	<dt>{@link
	com.hp.it.spf.xa.exception.portlet.SystemException#SystemException(PortletRequest,String,Throwable,String)}</dt>
	<dd>In these constructors, you provide your portlet request as
	well. This allows your localized message to be looked-up from your
	message resources by error code. Note the portlet request is just used
	for this lookup; it is not stored inside the exception.</dd>
</dl>

<p>You can then use the following methods to get access to the data
inside the exception:</p>

<dl>
	<dt>{@link
	com.hp.it.spf.xa.exception.portlet.BusinessException#getErrorCode()}</dt>
	<dt>{@link
	com.hp.it.spf.xa.exception.portlet.BusinessException#getErrorMessage()}</dt>
	<dt>{@link
	com.hp.it.spf.xa.exception.portlet.BusinessException#getNext()}</dt>
	<dt>{@link
	com.hp.it.spf.xa.exception.portlet.SystemException#getErrorCode()}</dt>
	<dt>{@link
	com.hp.it.spf.xa.exception.portlet.SystemException#getErrorMessage()}</dt>
	<dt>{@link
	com.hp.it.spf.xa.exception.portlet.SystemException#getNext()}</dt>
	<dd>These return the individual data elements as described above.</dd>
	<br>
	<br>

	<dt>{@link
	com.hp.it.spf.xa.exception.portlet.BusinessException#getLocalizedMessage()}</dt>
	<dt>{@link
	com.hp.it.spf.xa.exception.portlet.SystemException#getLocalizedMessage()}</dt>
	<dd>This returns your localized message, looked-up by the
	constructor from your resource bundles; or by default it returns the
	value of <code>getMessage</code> as per the Java standard behavior for
	{@link java.lang.Exception}.</dd>
	<br>
	<br>

	<dt>{@link
	com.hp.it.spf.xa.exception.portlet.BusinessException#getMessage()}</dt>
	<dt>{@link
	com.hp.it.spf.xa.exception.portlet.SystemException#getMessage()}</dt>
	<dd>This returns a string comprised of your error code, error
	message, and/or your throwable's message. Typically it is not suitable
	for display to the end-user.</dd>
	<br>
	<br>

	<dt>{@link
	com.hp.it.spf.xa.exception.portlet.BusinessException#getCause()}</dt>
	<dt>{@link
	com.hp.it.spf.xa.exception.portlet.SystemException#getCause()}</dt>
	<dd>This returns a the next-in-chain throwable, same as the <code>getNext</code>
	methods. They are provided for compliance with the Java-standard
	exception class.</dd>
</dl>

<p>Please see the method and class documentation for more
information.</p>

<blockquote>
<p><b>Note:</b> Examples are available at the end of this chapter.
Because error handling involves the use of several artifacts from
end-to-end, we have postponed the example until the other artifacts (<code>ExceptionUtil</code>
and <code>SimpleMappingExceptionResolver</code>) are introduced.</p>
</blockquote>

<hr>

<a name="error.spf.handling">
<h3>6.3. Handling exceptions using <code>ExceptionUtil</code> and <code>SimpleMappingExceptionResolver</code></h3>
</a>

<p>Once your exceptions are constructed, you can use {@link
com.hp.it.spf.xa.exception.portlet.ExceptionUtil} and {@link
com.hp.it.spf.xa.exception.portlet.handler.SimpleMappingExceptionResolver}
to work with them.</p>

<a name="error.spf.handling.exceptionUtil">
<h4>6.3.1 Using <code>ExceptionUtil</code> to store and access
exception data</h4>
</a>

<p>Use this class to set an exception into your {@link
javax.portlet.PortletRequest} and/or fetch it later. You can also
inspect what kind of exception(s) you have in your request, and get
their localized message(s) for display.</p>

<dl>
	<dt>{@link
	com.hp.it.spf.xa.exception.portlet.ExceptionUtil#setException(PortletRequest,Exception)}</dt>
	<dt>{@link
	com.hp.it.spf.xa.exception.portlet.ExceptionUtil#getException(PortletRequest)}</dt>
	<dd>
	<p>Use these methods to set your exception into your <code>PortletRequest</code>,
	and get it later (returning null if none was set). It does not have to
	be an exception which is using the {@link
	com.hp.it.spf.xa.exception.portlet.SPFException} hierarchy.</p>
	<blockquote>
	<p><b>Note:</b> Remember that in Java portlets, if you want your
	request attributes (like this exception) to persist from the action
	phase into the render phase, you need to enable <i>action-scoped
	request attributes</i> in your portlet container. See the <a
		href="#error.spf.examples.business">example below</a> for more about
	this.</p>
	</blockquote>
	</dd>

	<dt>{@link
	com.hp.it.spf.xa.exception.portlet.ExceptionUtil#containsBusinessException(PortletRequest)}</dt>
	<dt>{@link
	com.hp.it.spf.xa.exception.portlet.ExceptionUtil#containsSystemException(PortletRequest)}</dt>
	<dt>{@link
	com.hp.it.spf.xa.exception.portlet.ExceptionUtil#containsOtherException(PortletRequest)}</dt>
	<dd>
	<p>Use these methods to check what kind of exception you have (if
	any) in your current request. Since the exception may itself contain
	another {@link java.lang.Throwable} - such as another exception - there
	could therefore be a chain of throwables in the request. These methods
	check all of the object(s) in the chain to see if any one of them is of
	the indicated type (eg, <code>ExceptionUtil.containsBusinessException</code>
	returns true if any one of the throwables in the exception chain is a
	{@link com.hp.it.spf.xa.exception.portlet.BusinessException}).</p>
	</dd>

	<dt>{@link
	com.hp.it.spf.xa.exception.portlet.ExceptionUtil#getErrorCode(PortletRequest)}</dt>
	<dt>{@link
	com.hp.it.spf.xa.exception.portlet.ExceptionUtil#getErrorCode(PortletRequest,String)}</dt>
	<dd>
	<p>Use these methods to get the error code of the SPF exception (if
	any) in your current request. The string argument is an optional
	default error code. The method will return the given default (instead
	of null) if the exception in the request does not have an error code
	defined (eg, because it is a non-<code>SPFException</code>). If there
	is no exception in the request, the given default (instead of null)
	likewise will be returned.</p>
	</dd>

	<dt>{@link
	com.hp.it.spf.xa.exception.portlet.ExceptionUtil#getErrorCodes(PortletRequest)}</dt>
	<dt>{@link
	com.hp.it.spf.xa.exception.portlet.ExceptionUtil#getErrorCodes(PortletRequest,String)}</dt>
	<dd>
	<p>Since the exception in your request may itself contain another
	{@link java.lang.Throwable} - such as another exception - there could
	therefore be a chain of throwables in the request. The <code>ExceptionUtils.getErrorCodes</code>
	methods get an array of all the error code(s) in the chain (an empty
	array is returned if there is no exception in the request). The string
	argument is an optional default error code; the method will insert this
	default (instead of null) into the array for any throwable which does
	not have an error code defined (such as a non-<code>SPFException</code>).</p>
	</dd>

	<dt>{@link
	com.hp.it.spf.xa.exception.portlet.ExceptionUtil#getLocalizedMessage(PortletRequest)}</dt>
	<dt>{@link
	com.hp.it.spf.xa.exception.portlet.ExceptionUtil#getLocalizedMessage(PortletRequest,String)}</dt>
	<dd>
	<p>Use these methods to get the localized, user-suitable message
	for the exception (if any) in your current request. This uses the
	exception's <code>getLocalizedMessage()</code> method to get its
	localized message. In the case of an {@link
	com.hp.it.spf.xa.exception.portlet.SPFException}, that localized
	message may have been populated from your application's message
	resources at the time the exception was created (see above). If it was
	not, then a localized message for the error code is looked-up when you
	call this method, using <a href="#i18n.messages.java.spf.getMessage"><code>I18nUtility.getMessage</code></a>,
	and it is used as the <code>getLocalizedMessage()</code> value for the
	purposes of this method.</p>

	<p>This method then compares the exception's <code>getLocalizedMessage()</code>
	value with its <code>getMessage()</code> value. If they are not the
	same, then the <code>getLocalizedMessage()</code> is presumed to be
	user-suitable - a "real" localized message - and returned. But if they
	are the same, then the <code>getLocalizedMessage()</code> value is
	presumed to not be a "real", user-suitable message, and it is not
	returned. Instead, if a default was given (this is the optional string
	argument), a default message for that is returned instead (if no
	default was given, null is returned).</p>

	<p>The default may be either a message key for a default message in
	your application's resource bundles default error code; or it can be
	the default message itself. First the method tries to lookup a message
	for that given default, treating it as a key (this uses <a
		href="#i18n.messages.java.spf.getMessage"><code>I18nUtility.getMessage</code></a>);
	if found, that message is returned, otherwise the given default itself
	is returned.</p>

	<p>The default is also returned if there was no exception in the
	request.</p>
	</dd>

	<dt>{@link
	com.hp.it.spf.xa.exception.portlet.ExceptionUtil#getLocalizedMessages(PortletRequest)}</dt>
	<dt>{@link
	com.hp.it.spf.xa.exception.portlet.ExceptionUtil#getLocalizedMessages(PortletRequest,String)}</dt>
	<dd>
	<p>Since the exception in your request may itself contain another
	{@link java.lang.Throwable} - such as another exception - there could
	therefore be a chain of throwables in the request. Use these methods to
	get the localized, user-suitable message(s) for all of the ones in the
	chain (returning an empty array if there was no exception in the
	request). The procedure for getting a "real" localized message for each
	one, is the same as with the <code>ExceptionUtil.getLocalizedMessage</code>
	methods (see above).</p>
	</dd>
</dl>

<p>See the class and method documentation for more information. Also
see the <a href="#error.spf.examples">examples below</a>.</p>

<a name="error.spf.handling.simpleMappingExceptionResolver">
<h4>6.3.2. Using <code>SimpleMappingExceptionResolver</code> to
resolve a view for your exception</h4>
</a>

<p>The SPF provides a Spring handler for a thrown exception, called
{@link
com.hp.it.spf.xa.exception.portlet.handler.SimpleMappingExceptionResolver}.
This is identical to the Spring-standard {@link
org.springframework.web.portlet.handler.SimpleMappingExceptionResolver},
except that it also uses the <a href="#error.spf.handling.exceptionUtil"><code>ExceptionUtil</code></a>
to set the thrown exception into your request. Using this handler, you
can immediately throw (or let be thrown) exceptions from your render
controller, then use {@link
com.hp.it.spf.xa.exception.portlet.ExceptionUtil#getException(PortletRequest)},
{@link
com.hp.it.spf.xa.exception.portlet.ExceptionUtil#getLocalizedMessage(PortletRequest,String)},
or other <code>ExceptionUtil</code> methods to inspect the exception
data in your view (eg your JSP), without having had to explicitly set
the exception yourself.</p>

<p>To enable the SPF <code>SimpleMappingExceptionResolver</code>,
you configure it in your Spring application context like you would the
Spring <code>SimpleMappingExceptionResolver</code>. See the <a
	href="#error.spf.examples">examples below</a>.</p>

<hr>

<a name="error.spf.examples">
<h3>6.4. Some examples</h3>
</a>

<a name="error.spf.examples.business">
<h4>6.4.1. An example of business error handling</h4>
</a>

<p>Now for an example. Imagine that we have an error condition in
which a user has submitted a blank Forums article. (This could be
detected in our action phase, or in our render phase.) We could define a
{@link com.hp.it.spf.xa.exception.portlet.BusinessException} to
represent this case. Because it is a business exception (destined to be
presented to the user but not have anything else logged for it), we are
really only interested in an error code and a localized message for it.
So we construct the exception and set it into the request using {@link
com.hp.it.spf.xa.exception.portlet.ExceptionUtil#setException(PortletRequest,Exception)},
as follows:</p>

<blockquote><pre>
import com.hp.it.spf.xa.exception.portlet.BusinessException;
import com.hp.it.spf.xa.exception.portlet.ExceptionUtil;
...
BusinessException e = new BusinessException(request, "error.forums.blankArticle");
ExceptionUtil.setException(request, e);
</pre></blockquote>

<blockquote>
<p><b>Note:</b> Alternatively, we could have created our own
exception subclass of <code>BusinessException</code> and used that
instead. For example:</p>

<blockquote><pre>
import com.hp.it.spf.xa.exception.portlet.BusinessException;
...
public class BlankArticleException extends BusinessException {
    public BlankArticleException(PortletRequest request) {
        super(request, "error.forums.blankArticle");
    }
    public BlankArticleException(PortletRequest request, throwable next) {
        super(request, "error.forums.blankArticle", next, null);
    }
}
</pre></blockquote>

<p>Then we would instantiate that one in our code instead:</p>

<blockquote><pre>
import com.hp.it.spf.xa.exception.portlet.ExceptionUtil;
...
BlankArticleException e = new BlankArticleException(request);
ExceptionUtil.setException(request, e);
</pre></blockquote>
</blockquote>

<p>In either case, calling <code>ExceptionUtil.setException</code>
sets the new exception into our request scope. If it was set during the
action phase, whether that exception persists into the render phase or
not, depends on whether you have enabled <i>action-scoped request
attributes</i> for your portlet.</p>

<blockquote>
<p><b>Note:</b> <i>Action-scoped request attributes</i> are a JSR
286 feature. If you call <code>ExceptionUtil.setException</code> in your
action phase, and you want to be able to get that exception data (eg
using <code>ExceptionUtil.getException</code>) during your render phase,
you should enable this feature in your portlet.</p>

<p>To enable action-scoped request attributes, just add the
following to your <code>portlet.xml</code> (either for your particular
portlet, inside its <code>&lt;portlet&gt;...&lt;/portlet&gt;</code>
section, or at the global level):</p>

<blockquote><pre>
&lt;container-runtime-option&gt;
    &lt;name&gt;javax.portlet.actionScopedRequestAttributes&lt;/name&gt;
    &lt;value&gt;true&lt;/value&gt;
&lt;/container-runtime-option&gt;
</pre></blockquote>

<p>Please see the Portlet 2.0 (JSR 286) specification for more
information about action-scoped request attributes.</p>
</blockquote>

<p>So in our render phase, we can then get the exception from the
request and render it in our view (JSP). How involved this is, depends
on which view (JSP) we want to render it in.</p>

<p>In the simplest case, we want to render the exception in the
normal view for the render phase. In this case, we aren't interested in
diverting the flow to another view; we just want it to proceed into the
normal view. In this case, we just get and display the localized message
for the exception in our view, using one of the <code>ExceptionUtil.getLocalizedMessage</code>
methods. For example, assuming our view is a JSP, we could just have
this (since this is our normal view, we prepare for the case where there
was no exception, by using an empty string as the default message):</p>

<blockquote><pre>
...
&lt;% String errorMessage = ExceptionUtil.getLocalizedMessage(request, ""); %&gt;
&lt;%= errorMessage %&gt;
...
</pre></blockquote>

<blockquote>
<p><b>Note:</b> In other cases, though, we might want to divert the
flow to another view, away from our normal view. In that case, the
easiest way to manage it is to <i>throw</i> the exception back to the
dispatcher from our controller, either during the action phase or the
render phase. For example, we could send it into the view for the
original page from which the action was submitted in the first place, to
render out the message as above in that JSP.</p>

<p>For such a flow, we just throw the exception, and setup some
exception handler like the SPF {@link
com.hp.it.spf.xa.exception.portlet.handler.SimpleMappingExceptionResolver}
to then direct Spring Portlet MVC into the proper view for the
exception. (Note that Spring will preserve the exception in the request
across that flow; you do not need action-scoped request attributes if
you are going to throw your exception back to Spring.) See the <a
	href="#error.spf.examples.system">system error example below</a> for
how to set this up.</p>
</blockquote>

<p>Of course, to complete the example, we would want our <code>error.forums.blankArticle</code>
user message to be defined in our message resource bundle (remember this
bundle has to be properly configured in the Spring application context,
not shown here because that was covered in the internationalization
discussion earlier):</p>

<blockquote><pre>
error.forums.blankArticle=Please enter some text for your new posting, then submit it again.
</pre></blockquote>

<p>So that message (localized) will be what the user sees when you
get and express the localized message as above.</p>

<p>The above example considered a use case in which the user
triggered a single exception. What about when multiple business-logic
errors are detected - for example, the user has submitted a blank Forums
article, and also submitted it with a blank signature line. Exceptions
can be chained together - just nest the previous exception inside the
new one. For example (here, <code>BlankSignatureException</code> is
presumed to have been defined like <code>BlankArticleException</code>,
above):</p>

<blockquote><pre>
import com.hp.it.spf.xa.exception.portlet.ExceptionUtil;
...
BlankArticleException e1 = new BlankArticleException(request, ExceptionUtil.getException(request));
ExceptionUtil.setException(request, e1);
...
BlankSignatureException e2 = new BlankSignatureException(request, ExceptionUtil.getException(request));
ExceptionUtil.setException(request, e2);
</pre></blockquote>

<p>In your view (eg JSP), you could then get all of their localized
messages for the user, with or without defaults, using either of the <code>ExceptionUtil.getLocalizedMessages</code>
methods. Here we do it without defaults:</p>

<blockquote><pre>
...
&lt;% String[] errorMessages = ExceptionUtil.getLocalizedMessages(request);
   for (int i = 0; i < errorMessages.length; i++) {  %&gt;
&lt;%= errorMessages[i] %&gt;
&lt;% } %&gt;
...
</pre></blockquote>

<a name="error.spf.examples.system">
<h4>6.4.2. An example of system error handling</h4>
</a>

<p>The previous example was for a business exception. What might the
case of a system exception look like? Consider the case where the Forums
database was discovered to be unavailable. We could instantiate a {@link
com.hp.it.spf.xa.exception.portlet.SystemException} directly - in this
case, we might want to include an error message and another exception
for diagnostic purposes (eg perhaps an <code>SQLException</code> from
the database, here referred to in the variable <code>sqlException</code>):</p>

<blockquote><pre>
import com.hp.it.spf.xa.exception.portlet.SystemException;
import com.hp.it.spf.xa.exception.portlet.ExceptionUtil;
...
SystemException e = new SystemException(request,
                            "error.forums.dbUnavailable",
                            "The Forums database was unavailable - discovered while posting a new article",
                            sqlException);
ExceptionUtil.setException(request, e);
</pre></blockquote>

<blockquote>
<p><b>Note:</b> Alternately, we could define our own subclass of <code>SystemException</code>
for this case - eg <code>ForumsDbUnavailableException extends
SystemException</code> - and instantiate that here. Like in this class:</p>

<blockquote><pre>
import com.hp.it.spf.xa.exception.portlet.SystemException;
...
public class ForumsDbUnavailableException extends SystemException {
    public ForumsDbUnavailableException(PortletRequest request,
                                        String errorMessage,
                                        SQLException sqlException) {
        super(request, 
              "error.forums.dbUnavailable",
              sqlException,
              errorMessage);
    }
}
</pre></blockquote>

<p>Then we would instantiate that one in our code instead:</p>

<blockquote><pre>
import com.hp.it.spf.xa.exception.portlet.ExceptionUtil;
...
ForumsDbUnavailableException e = new ForumsDbUnavailableException(request,
                                    "The Forums database was unavailable - discovered while posting a new article",
                                    sqlException);
ExceptionUtil.setException(request, e);
</pre></blockquote>
</blockquote>

<p>In any event, after the exception is instantiated, we need to
consider flow-of-control - where should the use case proceed next? In
the <a href="#error.spf.examples.business">business error handling
example above</a>, we mentioned the options of 1) allowing the flow to
proceed into the normal view for the page (and presenting the user
message for the exception there, or 2) diverting the flow of control
away from the normal view, by throwing an exception. In the business
error handling example, we demonstrated the former option. But since
this is a system exception example, the latter option might be just what
we want to do in this case, in order to display a general-purpose system
error page to the user.</p>

<p>To arrange for that, we first throw the exception from the render
controller (ie during the render phase) back to the dispatcher. Here is
the code, assuming we use our <code>ForumsDbUnavailableException</code>
from above. (Note we do not need to bother with <code>ExceptionUtil.setException</code>
in this case - the SPF {@link
com.hp.it.spf.xa.exception.portlet.handler.SimpleMappingExceptionResolver}
will do that.)</p>

<blockquote><pre>
ForumsDbUnavailableException e = new ForumsDbUnavailableException(request,
                                    "The Forums database was unavailable - discovered while posting a new article",
                                    sqlException);
throw(e);
</pre></blockquote>

<p>Next, we configure the SPF portlet utilities' <code>SimpleMappingExceptionResolver</code>
to catch that, by adding the following to our Spring <code>applicationContext.xml</code>
(either the main one for our portlet application, or the
portlet-specific one as is often customary):</p>

<blockquote><pre>
&lt;bean id="exceptionHandlers"
	class="com.hp.it.spf.xa.exception.portlet.handler.SimpleMappingExceptionResolver"&gt;
    &lt;property name="defaultErrorView" value="systemError" /&gt;
    &lt;property name="exceptionMappings"&gt;
        &lt;props&gt;
            &lt;prop key="com.hp....<i>my-package</i>...ForumsDbUnavailableException"&gt;
                systemError
            &lt;/prop&gt;
            ...               &lt;-- others go here
        &lt;/props&gt;
    &lt;/property&gt;
&lt;/bean&gt;
</pre></blockquote>

<p>Whenever any <code>ForumsDbUnavailableException</code> is thrown
back from the render controller, the SPF's <code>SimpleMappingExceptionResolver</code>
now will automatically catch it, set the exception into the request for
you (using {@link
com.hp.it.spf.xa.exception.portlet.ExceptionUtil#setException(PortletRequest,Exception)}),
and forward it to the <code>systemError</code> view. This view, in turn,
could map directly to a <code>systemError.jsp</code> JSP - it depends on
what we have setup for our view resolver in Spring (that is standard
Spring Portlet MVC and not shown here).</p>

<blockquote>
<p><b>Note:</b> In the above example, we are using the same view for
our default error handling. That is what Spring dispatches to, if it
catches any other kind of exception besides a <code>ForumsDbUnavailableException</code>.</p>
</blockquote>

<blockquote>
<p><b>Note:</b> In the above example, we mapped from <code>ForumsDbUnavailableException</code>,
and presumably would setup similar mappings for other case-specific
exception classes we create. If we wanted all our various kinds of
{@link com.hp.it.spf.xa.exception.portlet.SystemException} to go to the
same system error page, though, we could just deal with them all in one
configuration, with a single property mapping for <code>com.hp.it.spf.xa.exception.portlet.SystemException</code>
instead.
</blockquote>

<p>Finally, in the JSP for that view (eg our <code>systemError.jsp</code>),
we can then just access the user-displayable error message for this
condition, and express it. The JSP code is similar to that shown for the
business exception above. Here though, we pass in a default message key
since this is a dedicated error page and we must display something
(remember that a good localized message will only be available if some
kind of {@link com.hp.it.spf.xa.exception.portlet.SPFException} was
buffered in the request - so here we pass in a default message for use
if that is ever not the case).</p>

<blockquote><pre>
&lt;% String errorMessage = ExceptionUtil.getLocalizedMessage(request, "error.forums.default"); %&gt;
&lt;%= errorMessage %&gt;
</pre></blockquote>

<p>Let's not forget our messages - both the one for the <code>error.forums.dbUnavailable</code>
error code specified in the constructor up above, and the one for the <code>error.forums.default</code>
specified as a last resort:</p>

<blockquote><pre>
error.forums.dbUnavailable=The Forums database is currently unavailable. Please try again later.
error.forums.default=The service or information you requested is currently unavailable.  Please try again later.
</pre></blockquote>

<blockquote>
<p><b>Note:</b> What if you need to divert the flow due to an
exception - but not just divert it into another view, but rather build
up a whole model for that view first? In that case, you can do it like
the above; but instead of using <code>SimpleMappingExceptionResolver</code>,
you should implement your own {@link
org.springframework.web.portlet.HandlerExceptionResolver}. In your
implementation, you would build the {@link
org.springframework.web.portlet.ModelAndView} including the needed model
for the view for the exception, and return it. (You should also set the
exception into the request, using <code>ExceptionUtil.setException</code>,
so your view can access it like above.)</p>

<p>Then you would just configure that <code>HandlerExceptionResolver</code>
like shown above for <code>SimpleMappingExceptionResolver</code>. So
when you throw your exception (whether during your action or render
phase), Spring will catch it, resolver your exception handler, and
invoke it with your exception as usual. Your handler will then run, set
the exception into the request for your view, build the model which your
view needs, and return the <code>ModelAndView</code> to forward to that
(as with any typical controller class).</p>
</blockquote>

<hr>

<a name="history">
<h2>7. Document History</h2>
</a>

<table border="1">
	<tr>
		<th>Version</th>
		<th>Date</th>
		<th>Editor</th>
		<th>Description</th>
	</tr>
	<tr>
		<td>1.0</td>
		<td>Feb 10 2009</td>
		<td>S. Jorgenson</td>
		<td>Initial published version.</td>
	</tr>
	<tr>
		<td>1.1</td>
		<td>Feb 12 2009</td>
		<td>S. Jorgenson</td>
		<td>
		<ul>
			<li>Added locale groups.</li>
			<li>Corrected global resources folder to conform to actual SASU
			value: <code>/opt/sasuapps/spf/globalResources</code> to <code>/opt/sasuapps/sp/global_resources/</code>
			</li>
			<li>Added defaults for timezone.</li>
		</ul>
		</td>
	</tr>
	<tr>
		<td>1.2</td>
		<td>Feb 14 2009</td>
		<td>S. Jorgenson</td>
		<td>
		<ul>
			<li>Added <code>servlet.fileRelay.included</code> property to <code>i18n_portlet_config.properties</code>.</li>
			<li>Added support for switching scheme and port in <code>{REQUEST-URL}</code>
			and <code>{SITE-URL}</code> text interpolation tokens.</li>
			<li>Added support for <code>{BEFORE:<i>date</i>}</code> and <code>{AFTER:<i>date</i>}</code>
			text interpolation tokens.
		</ul>
		</td>
	</tr>
	<tr>
		<td>1.3</td>
		<td>Feb 23 2009</td>
		<td>S. Jorgenson</td>
		<td>
		<ul>
			<li>Changed authentication-type and locale group names per
			Slawek and Ye.</li>
		</ul>
		</td>
	</tr>
	<tr>
		<td>1.4</td>
		<td>Feb 25 2009</td>
		<td>S. Jorgenson</td>
		<td>
		<ul>
			<li>Documented authentication status groups, and constant names
			for all groups.</li>
		</ul>
		</td>
	</tr>
	<tr>
		<td>1.5</td>
		<td>Feb 28 2009</td>
		<td>S. Jorgenson</td>
		<td>
		<ul>
			<li>Documented that <code>html_viewer_includes.properties</code>
			can be overridden in HTML viewer portlet <code>config</code> mode,
			and may be located as an internal or external resource.</li>
		</ul>
		</td>
	</tr>
	<tr>
		<td>1.6</td>
		<td>Mar 4 2009</td>
		<td>S. Jorgenson</td>
		<td>
		<ul>
			<li>Documented new <code>{HPP-LANGUAGE-CODE}</code> text
			interpolation token.</li>
		</ul>
		</td>
	</tr>
	<tr>
		<td>1.7</td>
		<td>Mar 13 2009</td>
		<td>S. Jorgenson</td>
		<td>
		<ul>
			<li>Documented new <code>{LANGUAGE-CODE:<i>case</i>}</code>, <code>{LANGUAGE-TAG:<i>case</i>}</code>,
			<code>{COUNTRY-CODE:<i>case</i>}</code>, <code>{HPP-LANGUAGE-CODE:<i>case</i>}</code>
			text interpolation tokens. Changed name of <code>{SITE:<i>names</i>}...{/SITE}</code>
			container token to <code>{SITES:<i>names</i>}...{/SITES}</code> to
			avoid ambiguity with <code>{SITE}</code> elemental token.</li>
		</ul>
		</td>
	</tr>
	<tr>
		<td>1.8</td>
		<td>Mar 29 2009</td>
		<td>S. Jorgenson</td>
		<td>
		<ul>
			<li>Documented new <code>{URL-ENCODE:<i>string</i>}</code> text
			interpolation token. Documented that timezone user property is
			returned as a string timezone ID; and added some generic
			documentation about extended user properties. Documented cacheSeconds
			for Spring <code>ReloadableResourceBundleMessageSource</code>
			configuration.</li>
		</ul>
		</td>
	</tr>
	<tr>
		<td>1.9</td>
		<td>Apr 7 2009</td>
		<td>S. Jorgenson</td>
		<td>Updated TBD URL's for property file templates, with pointers
		to SPF portlet config JAR.</td>
	</tr>
	<tr>
		<td>2.0</td>
		<td>Apr 20 2009</td>
		<td>S. Jorgenson</td>
		<td>Documented new <code>{PAGE:<i>pages</i>}</code> container
		token. Documented that <code>{SITES:<i>sites</i>}</code> container
		token has been renamed <code>{SITE:<i>sites</i>}</code>, and <code>{SITE}</code>
		token has been renamed <code>{SITE-NAME}</code>.</td>
	</tr>
	<tr>
		<td>2.1</td>
		<td>Jun 11 2009</td>
		<td>S. Jorgenson</td>
		<td>Fixed broken link.</td>
	</tr>
	<tr>
		<td>2.2</td>
		<td>Jul 21 2009</td>
		<td>S. Jorgenson</td>
		<td>Added dependency info about <code>spf-portlet-filters</code>.  Added note about
		configuring message sources in root application context for the portlet application, 
		not application context for the portlet.</td>
	</tr>

</table>
<p></p>

<hr>

<h2>- End -</h2>
</body>
</html>